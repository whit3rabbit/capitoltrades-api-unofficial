# Requirements Archive - Yahoo Finance Price Enrichment (v1.1)

**Milestone:** Yahoo Finance Price Enrichment & Portfolio Tracking
**Created:** 2026-02-09
**Archived:** 2026-02-11

## Enrichment

- [x] **REQ-E1**: Historical trade-date price lookup -- Phase 4 (SHIPPED)
  - Fetch adjusted close price from Yahoo Finance for each trade's `tx_date`
  - Handle weekends/holidays by using nearest prior trading day's close
  - Store as `trade_date_price REAL` in trades table
  - Use `tx_date` (actual trade date), not `pub_date` (disclosure date)
  - Skip trades with null/missing ticker symbols

- [x] **REQ-E2**: Current price per ticker -- Phase 4 (SHIPPED)
  - Fetch latest adjusted close price for each unique ticker
  - Store as `current_price REAL` in trades table
  - Track freshness via `price_enriched_at TEXT` (ISO 8601) column
  - Deduplicate: fetch once per ticker, apply to all trades with that ticker

- [x] **REQ-E3**: Ticker validation and batch processing -- Phase 3, 4 (SHIPPED)
  - Validate ticker exists in Yahoo Finance before historical lookup
  - Mark invalid/delisted tickers as unenrichable (don't retry on future runs)
  - Batch by unique ticker (1000 trades -> ~200 tickers)
  - Resume after failure: skip already-enriched trades on re-run
  - Rate limit: sequential with 200-500ms jittered delay, max 5 concurrent
  - Circuit breaker: trip after 10 consecutive failures
  - Log enrichment summary (success/fail/skip counts)

- [x] **REQ-E4**: Trade value estimation -- Phase 3 (SHIPPED)
  - Parse Capitol Trades dollar range strings (e.g., "$15,001 - $50,000") into numeric bounds
  - Estimate share count: `shares = range_midpoint / trade_date_price`
  - Store as `estimated_shares REAL` and `estimated_value REAL` in trades table
  - Validate: `estimated_shares * trade_date_price` should fall within original range
  - Skip estimation when trade_date_price is unavailable

## Portfolio

- [x] **REQ-P1**: Net position per politician per ticker (FIFO) -- Phase 5 (SHIPPED)
  - Calculate running balance of shares per politician per ticker
  - FIFO accounting: first shares bought are first shares sold
  - Handle transaction types: buy (add), sell (subtract), exchange (no-op), receive (add)
  - Use `estimated_shares` from REQ-E4 for share counts
  - Store in `positions` table: politician_id, ticker, shares_held, cost_basis, last_updated
  - Positions never go negative (Err return with warning on oversold)

- [x] **REQ-P2**: Unrealized P&L per position -- Phase 5 (SHIPPED)
  - Calculate: `(current_price - avg_cost_basis) * shares_held`
  - Requires current price (REQ-E2) and net position (REQ-P1)
  - Display as both dollar amount and percentage
  - Computed at query time via current_price subquery from trades table

- [x] **REQ-P3**: Realized P&L from closed positions -- Phase 5 (SHIPPED)
  - Track cost basis of sold shares using FIFO matching
  - Calculate: `(sell_price - buy_cost_basis) * shares_sold` per matched lot
  - Accumulate across all closed lots for total realized P&L per position
  - Stored as realized_pnl column on positions table

- [x] **REQ-P4**: Option trade classification -- Phase 5, 6 (SHIPPED)
  - Classify trades as stock vs option using existing `asset_type` field
  - Options excluded from FIFO position calculation (stock-only filtering)
  - Display options separately in portfolio output with "valuation deferred" note
  - Track option trades count per politician via count_option_trades

## Infrastructure

- [x] **REQ-I1**: Schema migration (v2) -- Phase 1 (SHIPPED)
  - Add columns to trades table: `trade_date_price`, `current_price`, `price_enriched_at`, `estimated_shares`, `estimated_value`
  - Create `positions` table for net position tracking
  - Use existing PRAGMA user_version migration pattern (increment to v2)
  - Auto-detect existing DB and add missing columns; fresh DBs include all columns in base schema

- [x] **REQ-I2**: Yahoo Finance client integration -- Phase 2 (SHIPPED)
  - Add `yahoo_finance_api = "4.1.0"` and `time = "0.3"` dependencies to capitoltraders_lib
  - Create YahooClient wrapper with chrono-to-time conversion helpers
  - Reuse existing reqwest 0.12 / tokio runtime
  - No authentication required (unofficial API)

- [x] **REQ-I3**: `enrich-prices` CLI subcommand -- Phase 4 (SHIPPED)
  - New subcommand: `capitoltraders enrich-prices --db <path>`
  - Required: `--db` flag (DB-only operation)
  - Optional: `--batch-size` (default 50)
  - Display progress: ticker count, success/fail/skip, elapsed time
  - Exit code 0 on success (even with partial failures), non-zero on total failure

- [x] **REQ-I4**: `portfolio` CLI subcommand -- Phase 6 (SHIPPED)
  - New subcommand: `capitoltraders portfolio --db <path>`
  - Required: `--db` flag
  - Filters: `--politician`, `--party`, `--state`, `--ticker`, `--include-closed`
  - Show: ticker, shares held, avg cost basis, current price, unrealized P&L, P&L %
  - Separate note for option trades (human-readable formats only)
  - Respects `--output` global flag (table, JSON, CSV, markdown, XML)

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| REQ-E1 | Phase 4 | Shipped |
| REQ-E2 | Phase 4 | Shipped |
| REQ-E3 | Phase 3, 4 | Shipped |
| REQ-E4 | Phase 3 | Shipped |
| REQ-P1 | Phase 5 | Shipped |
| REQ-P2 | Phase 5 | Shipped |
| REQ-P3 | Phase 5 | Shipped |
| REQ-P4 | Phase 5, 6 | Shipped |
| REQ-I1 | Phase 1 | Shipped |
| REQ-I2 | Phase 2 | Shipped |
| REQ-I3 | Phase 4 | Shipped |
| REQ-I4 | Phase 6 | Shipped |

**Coverage:** 12/12 requirements shipped (100%)

## Notes

- REQ-E3 originally specified "mark invalid tickers as unenrichable" -- implemented as always setting price_enriched_at (even for None results), preventing re-processing
- REQ-E4 originally specified "estimated_shares INTEGER" -- changed to REAL for fractional precision (documented in Phase 1 decisions)
- REQ-I3 originally included "--force" flag -- defined but deferred (prints notice, reserved for future)
- REQ-P2 originally specified "Mark as stale if price_enriched_at is older than configurable threshold" -- staleness threshold not implemented; prices show as-is

---
*Archived from .planning/REQUIREMENTS.md on 2026-02-11*
