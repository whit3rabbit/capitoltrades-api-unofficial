# Milestone v1.1: Yahoo Finance Price Enrichment

**Status:** SHIPPED 2026-02-11
**Phases:** 1-6
**Total Plans:** 7

## Overview

Extended Capitol Traders with Yahoo Finance market data integration and portfolio tracking. Added schema migration for price columns, Yahoo Finance client with caching, dollar range parsing and share estimation, a two-phase price enrichment pipeline, FIFO portfolio calculator with realized P&L, and a portfolio CLI command with full output format support.

## Phases

### Phase 1: Schema Migration & Data Model
**Goal**: Database schema supports price storage and portfolio tracking
**Depends on**: Nothing (first phase)
**Plans**: 1 plan

Plans:
- [x] 01-01: Schema migration v2 (price columns + positions table + DbTradeRow update + tests)

**Details:**
- Added v2 migration with 5 nullable price columns on trades table (trade_date_price, current_price, price_enriched_at, estimated_shares, estimated_value)
- Created positions table with composite PK (politician_id, issuer_ticker), REAL shares_held/cost_basis, CASCADE DELETE
- Updated DbTradeRow struct and query_trades() to include new fields
- 4 new tests (v1-to-v2 migration, idempotency, price field querying)

### Phase 2: Yahoo Finance Client Integration
**Goal**: System can fetch historical and current prices from Yahoo Finance
**Depends on**: Phase 1
**Plans**: 1 plan

Plans:
- [x] 02-01: YahooClient wrapper with time/chrono conversion, price fetching, weekend fallback, caching, and tests

**Details:**
- YahooError enum with 4 variants (RateLimited, InvalidDate, ParseFailed, Upstream)
- Bidirectional NaiveDate/OffsetDateTime conversion at UTC midnight
- YahooClient with DashMap cache, adjclose price fetching, weekend/holiday fallback (7-day lookback)
- Graceful Ok(None) return for invalid/delisted tickers
- 11 new tests

### Phase 3: Ticker Validation & Trade Value Estimation
**Goal**: Ticker symbols are validated and trade share counts are estimated
**Depends on**: Phase 2
**Plans**: 1 plan

Plans:
- [x] 03-01: Pricing module (dollar range parsing + share estimation) and DB operations (enrichment queries + price updates + tests)

**Details:**
- TradeRange struct with midpoint calculation, parse_trade_range(), ShareEstimate struct, estimate_shares()
- PriceEnrichmentRow with DB operations: count_unenriched_prices, get_unenriched_price_trades, update_trade_prices
- All DB methods JOIN issuers table for ticker access
- 23 new tests (13 pricing + 10 DB)

### Phase 4: Price Enrichment Pipeline
**Goal**: Trades are enriched with historical and current prices via batch processing
**Depends on**: Phase 3
**Plans**: 1 plan

Plans:
- [x] 04-01: Price enrichment pipeline (historical + current price fetching, CLI subcommand wiring, rate limiting, circuit breaker)

**Details:**
- Two-phase fetching: historical prices by (ticker, date), then current prices by ticker
- Rate-limited concurrent fetching (5 max concurrent, 200-500ms jittered delay)
- Circuit breaker (trips after 10 consecutive failures)
- Resumable enrichment via price_enriched_at timestamp
- `capitoltraders enrich-prices --db <path>` CLI subcommand
- 2 new tests

### Phase 5: Portfolio Calculator (FIFO)
**Goal**: Per-politician net positions with realized and unrealized P&L calculated
**Depends on**: Phase 4
**Plans**: 2 plans

Plans:
- [x] 05-01: FIFO calculator core (Lot/Position/TradeFIFO types, buy/sell/calculate_positions logic, TDD with 14 tests)
- [x] 05-02: DB integration (query_trades_for_portfolio, upsert_positions, get_portfolio with unrealized P&L, option trade counting)

**Details:**
- FIFO lot matching using VecDeque, partial lot sales, oversold handling (Err, no panic)
- Epsilon comparisons for floating-point zero checks
- Transaction type handling: buy/receive add, sell consumes FIFO, exchange no-op
- DB operations: query_trades_for_portfolio (stock-only, chronological), upsert_positions (ON CONFLICT), get_portfolio (dynamic filters, current_price subquery), count_option_trades
- PortfolioPosition and PortfolioFilter types for display layer
- 26 new tests (14 FIFO + 12 DB)

### Phase 6: CLI Commands & Output
**Goal**: Users can enrich prices and view portfolios via CLI
**Depends on**: Phase 5
**Plans**: 1 plan

Plans:
- [x] 06-01: Portfolio command with output formatting (PortfolioRow + 5 format functions + CLI wiring + filter validation)

**Details:**
- PortfolioRow with 8 columns: politician_id, ticker, shares_held, avg_cost_basis, current_price, current_value, unrealized_pnl, unrealized_pnl_pct
- Custom format_currency_with_commas helper for thousand separators
- All 5 output formats (table, JSON, CSV, markdown, XML) supported
- Option trades exclusion note in human-readable formats only
- 6 new tests

---

## Milestone Summary

**Key Decisions:**
- New enrich-prices subcommand (separate from scrape enrichment)
- yahoo_finance_api 4.1.0 crate (mature, compatible, no auth needed)
- Materialized positions table (avoid FIFO recalculation on every query)
- Midpoint of dollar range / historical price = estimated shares
- REAL for estimated_shares (fractional precision)
- Arc<YahooClient> for task sharing (YahooConnector not Clone)
- Two-phase enrichment: historical by (ticker, date), current by ticker
- VecDeque for FIFO lot queue
- Portfolio DB upsert: ON CONFLICT for idempotent writes
- Unrealized P&L computed at query time via current_price subquery
- Option trades note in table/markdown only (not JSON/CSV/XML)

**Issues Resolved:**
- Schema initialization order: base schema includes all columns from all migrations for fresh DBs
- YahooConnector Clone limitation: wrap in Arc for sharing across spawned tasks
- yahoo_finance_api Decimal type: is f64 by default (no conversion needed)
- response.quotes() NoQuotes error: nested match for parsing phase errors
- issuer_ticker JOIN: ticker lives on issuers table, not trades

**Issues Deferred:**
- Option valuation (strike price, expiry, Greeks) -- deferred until data quality improves
- --force flag on enrich-prices (defined but prints notice, reserved for future)
- Price cache TTL expiration (currently lives forever in DashMap)
- Proper logging for pricing validation (currently eprintln)

**Technical Debt Incurred:**
- YahooClient cache has no TTL (grows unbounded during long-running enrichment sessions)
- eprintln used for pricing validation warnings instead of structured logging

---

_For current project status, see .planning/ROADMAP.md_
