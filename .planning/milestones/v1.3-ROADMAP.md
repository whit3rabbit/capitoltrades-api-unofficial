# Milestone v1.3: Analytics & Scoring

**Status:** SHIPPED 2026-02-15
**Phases:** 13-17
**Total Plans:** 11

## Overview

Derives actionable insights from trade, price, portfolio, and donation data through performance scoring, historical anomaly detection, and sector/committee cross-reference analysis. Adds GICS sector classification, benchmark price enrichment (S&P 500 + 11 sector ETFs), FIFO-based performance analytics with politician leaderboards, committee-sector conflict detection with donation correlation, anomaly detection (pre-move trades, unusual volume, sector concentration), and analytics-enriched output across all existing commands.

## Phases

### Phase 13: Data Foundation & Sector Classification

**Goal**: Users can store benchmark prices and sector mappings for analytics
**Depends on**: Nothing (foundation)
**Requirements**: FOUND-01, FOUND-02, FOUND-04
**Verification**: 4/4 must-haves passed
**Plans**: 2 plans

Plans:
- [x] 13-01: Schema v6 migration, sector_benchmarks table, benchmark population, DB query helpers
- [x] 13-02: Sector mapping module, GICS YAML data file, issuer sector update operations

**Details:**
- Schema v6: gics_sector TEXT column on issuers, sector_benchmarks reference table
- 12 benchmark ETF definitions (SPY + 11 GICS sector SPDRs)
- gics_sector_mapping.yml: 200 ticker-to-sector static mappings with compile-time validation
- sector_mapping.rs: GICS_SECTORS constant, validate_sector(), parse_sector_mappings()
- Case-insensitive sector validation with official GICS capitalization normalization
- Duplicate ticker detection in YAML parsing via HashSet

### Phase 14: Benchmark Price Enrichment

**Goal**: Users can enrich trades with S&P 500 and sector ETF benchmark prices
**Depends on**: Phase 13
**Requirements**: FOUND-03
**Verification**: 18/18 must-haves passed
**Plans**: 2 plans

Plans:
- [x] 14-01: Schema v7 migration, BenchmarkEnrichmentRow, get_benchmark_unenriched_trades, update_benchmark_price
- [x] 14-02: Phase 3 benchmark enrichment loop in enrich_prices.rs with sector-to-ETF mapping

**Details:**
- Schema v7: benchmark_price REAL column on trades, idx_trades_benchmark_price index
- BenchmarkEnrichmentRow separate from PriceEnrichmentRow (different data needs)
- Phase 3 enrichment: dedup by (ETF ticker, date), concurrent fetch, independent circuit breaker
- get_benchmark_ticker() maps 11 GICS sectors to SPDR ETF tickers with SPY fallback
- Benchmark enrichment does NOT touch price_enriched_at (separate concerns)
- Weekend/holiday fallback via existing YahooClient get_price_on_date_with_fallback

### Phase 15: Performance Scoring & Leaderboards

**Goal**: Users can see performance metrics and politician rankings
**Depends on**: Phase 14
**Requirements**: PERF-01 through PERF-06, LEAD-01 through LEAD-04
**Verification**: 9/9 must-haves passed
**Plans**: 3 plans

Plans:
- [x] 15-01: Analytics calculation module (TDD): FIFO closed trade matching, metric functions, politician aggregation
- [x] 15-02: DB analytics query method: AnalyticsTradeRow type, query_trades_for_analytics with benchmark/sector data
- [x] 15-03: Analytics CLI command: leaderboard subcommand with filtering, sorting, and 5 output formats

**Details:**
- analytics.rs: AnalyticsTrade, ClosedTrade, TradeMetrics, PoliticianMetrics types
- FIFO matching via VecDeque<AnalyticsLot>, same pattern as portfolio.rs
- absolute_return, annualized_return (min 30 days), simple_alpha, holding_period_days
- Separate avg_alpha_spy and avg_alpha_sector aggregation
- Percentile rank: 1.0 - (index / (n-1)), recomputed after filtering
- analytics CLI: --period (ytd/1y/2y/all), --min-trades, --sort-by (return/win-rate/alpha), --party, --state, --top
- query_trades_for_analytics does NOT filter benchmark_price IS NOT NULL (needed for FIFO)
- 36 analytics unit tests + 5 DB query tests

### Phase 16: Conflict Detection

**Goal**: Users can identify committee-sector overlaps and donation-trade correlations
**Depends on**: Phase 15
**Requirements**: CONF-01 through CONF-04
**Verification**: 5/5 must-haves passed
**Plans**: 2 plans

Plans:
- [x] 16-01: Committee jurisdiction YAML mapping, loader module, conflict scoring types and pure functions
- [x] 16-02: DB conflict query methods, conflicts CLI subcommand with output formatting

**Details:**
- committee_sectors.yml: 40+ committees (17 House, 19 Senate, select) mapped to GICS sectors
- committee_jurisdiction.rs: load_committee_jurisdictions(), get_committee_sectors() with HashSet dedup
- conflict.rs: CommitteeTradingScore, DonationTradeCorrelation, calculate_committee_trading_score()
- Committee short codes from CapitolTrades scrape data (hsba, ssfi, etc.)
- gics_sector propagated from buy lot in FIFO matching to ClosedTrade
- query_donation_trade_correlations: 6-table JOIN (trades->issuers->employer_mappings->donations->donation_sync_meta)
- NULL sector trades excluded from both numerator and denominator
- Disclaimer: "Based on current committee assignments; may not reflect assignment at trade time"
- conflicts CLI: --politician (name resolution), --committee, --min-committee-pct, --include-donations, --min-confidence

### Phase 17: Anomaly Detection & Output Integration

**Goal**: Users can detect unusual trading patterns and see analytics in all outputs
**Depends on**: Phase 16
**Requirements**: ANOM-01 through ANOM-05, OUTP-01 through OUTP-04
**Verification**: 9/9 must-haves passed
**Plans**: 3 plans

Plans:
- [x] 17-01: Anomaly detection pure functions (TDD): pre-move, volume, HHI, composite scoring
- [x] 17-02: Output integration: extend trades/portfolio/politicians with analytics and conflict data
- [x] 17-03: Anomaly DB queries and anomalies CLI subcommand with 5 output formats

**Details:**
- anomaly.rs: TradeWithFuturePrice, TradeVolumeRecord, PortfolioPositionForHHI input types
- detect_pre_move_trades: >10% price change within 30 days, 4-way direction classification
- detect_unusual_volume: 90d/365d window, ratio > 2.0 threshold
- calculate_sector_concentration: HHI on 0-1 scale, concentrated if > 0.25
- calculate_composite_anomaly_score: normalized signals, equal weights, confidence metric
- EnrichedDbTradeRow, EnrichedPortfolioPosition, EnrichedDbPoliticianRow for backward-compatible output
- Best-effort enrichment: analytics/conflict data integration with graceful fallback
- anomalies CLI: --politician, --min-score, --min-confidence, --show-pre-move, --top, --sort-by

---

## Milestone Summary

**Key Decisions:**
- SPDR Sector ETFs for GICS Benchmarks (11 sectors + SPY, high liquidity, direct mapping)
- Compile-time YAML inclusion for sector and committee mappings (build-time validation)
- Separate BenchmarkEnrichmentRow from PriceEnrichmentRow (different data needs)
- query_trades_for_analytics does NOT filter benchmark_price IS NOT NULL (FIFO needs all trades)
- Filter closed trades before computing metrics (ClosedTrade has sell_date, TradeMetrics doesn't)
- Re-compute percentile ranks after filtering (relative to filtered pool, not global)
- Best-effort enrichment with graceful fallback (never fail commands when data unavailable)
- Enriched types over base type modification (backward compatibility)
- Pure function design for analytics, conflict, and anomaly modules (easy testing, no DB coupling)

**Issues Resolved:**
- SQLite correlated subquery scoping in pre-move query (simplified ORDER BY)
- rusqlite not re-exported for CLI crate (individual ticker queries instead of bulk IN clause)
- Dead code warnings from replaced output functions (allow(dead_code) on originals)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- Flaky yahoo cache test (timing issue, pre-existing from v1.1)
- #[allow(dead_code)] on original un-enriched output functions
- Simplified pre-move query ORDER BY (SQLite limitation)

---

_For current project status, see .planning/ROADMAP.md_
