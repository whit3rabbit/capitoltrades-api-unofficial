# Milestone v1.2: FEC Donation Integration

**Status:** SHIPPED 2026-02-14
**Phases:** 7-12
**Total Plans:** 15

## Overview

Extends Capitol Traders with OpenFEC campaign donation data to show who funds each politician, correlated against their trading activity. Adds .env-based API key management, a congress-legislators crosswalk for politician-to-FEC ID mapping, an OpenFEC API client with keyset pagination, a donation sync pipeline, a donations CLI query command, and employer-to-issuer correlation analysis. Six phases covering foundation through advanced correlation, with strict downward dependency flow.

## Phases

### Phase 7: Foundation & Environment Setup

**Goal**: Project can load API keys from environment and resolve politician-to-FEC ID mappings without consuming API budget
**Depends on**: Phase 6 (v1.1 complete)
**Requirements**: REQ-v1.2-001, REQ-v1.2-002
**Plans**: 2 plans

Plans:
- [x] 07-01: Environment setup, dependencies, schema v3 migration with fec_mappings table
- [x] 07-02: FEC mapping module, YAML parsing, DB operations, sync-fec CLI command

**Details:**
- dotenvy 0.15 added for .env loading at CLI startup (lazy -- only required for donation commands)
- serde_yml 0.0.12 for congress-legislators YAML parsing
- Schema v3: fec_mappings table with composite PK (politician_id, fec_candidate_id)
- (last_name, state) composite key matching with collision detection via tracing::warn
- Download both current + historical legislators for maximum coverage

### Phase 8: OpenFEC API Client

**Goal**: System can communicate with the OpenFEC API, handling pagination, rate limits, and errors correctly
**Depends on**: Phase 7
**Requirements**: REQ-v1.2-003
**Plans**: 2 plans

Plans:
- [x] 08-01: OpenFEC types, error enum, and client with three endpoint methods
- [x] 08-02: JSON fixtures and wiremock integration tests for all endpoints

**Details:**
- OpenFecClient with candidate search, committee lookup, Schedule A contributions
- Keyset pagination only for Schedule A (no page field)
- API key passed as query parameter, never as header
- HTTP 429 -> RateLimited, 403 -> InvalidApiKey typed errors
- 15 wiremock integration tests covering all endpoints

### Phase 9: Politician-to-Committee Mapping & Schema v4

**Goal**: Database schema supports donation storage and politician-to-committee resolution is fully operational
**Depends on**: Phase 8
**Requirements**: REQ-v1.2-004, REQ-v1.2-005
**Plans**: 2 plans

Plans:
- [x] 09-01: Schema v4 migration (donations, donation_sync_meta, fec_committees tables) and committee DB operations
- [x] 09-02: CommitteeResolver with three-tier cache, CommitteeClass enum, and wiremock integration tests

**Details:**
- Schema v4: fec_committees, donations, donation_sync_meta tables + committee_ids TEXT on fec_mappings
- 5 new indexes (donations committee/date/cycle, sync_meta politician, fec_committees designation)
- CommitteeClass::classify checks designation FIRST (leadership PACs have D regardless of H/S/P type)
- Arc<Mutex<Db>> for shared DB access (rusqlite::Connection not Send+Sync)
- Empty committee results cached to prevent repeated API calls

### Phase 10: Donation Sync Pipeline

**Goal**: Users can sync FEC donation data into their local database for any politician
**Depends on**: Phase 9
**Requirements**: REQ-v1.2-006
**Plans**: 2 plans

Plans:
- [x] 10-01: DB donation sync operations (insert, cursor management, politician lookup) and ScheduleAQuery date range extension
- [x] 10-02: sync-donations CLI command with concurrent pipeline, circuit breaker, and resume support

**Details:**
- Concurrent pipeline: Semaphore + JoinSet + mpsc (concurrency = 3)
- Circuit breaker threshold 5 (lower than enrich_prices' 10 for OpenFEC rate limits)
- 403 InvalidApiKey = immediate bail (not circuit breaker)
- Separate DB handles: setup_db for queries, receiver_db for writes
- save_sync_cursor_with_donations wraps donations + cursor in unchecked_transaction (atomic)
- NULL sub_id -> skip (return false, no insert, no panic)

### Phase 11: Donations CLI Command

**Goal**: Users can query and analyze synced donation data through the CLI
**Depends on**: Phase 10
**Requirements**: REQ-v1.2-007, REQ-v1.2-008
**Plans**: 2 plans

Plans:
- [x] 11-01: Donation query types, filter struct, individual + aggregation DB query methods with unit tests
- [x] 11-02: Donations CLI command, output formatting (all 5 formats), XML support, filter validation

**Details:**
- 4 display modes: individual contributions, group-by contributor, employer, or state
- 8 filter flags: politician, cycle, min-amount, employer, state, top, group-by, db
- All donation queries JOIN through donation_sync_meta (donations lack direct politician_id)
- build_donation_where_clause shared helper avoids filter duplication across 4 query methods
- CSV formula injection sanitization on contributor/employer fields
- Cycle validation: even year >= 1976

### Phase 12: Employer Correlation & Analysis

**Goal**: Users can see connections between donation sources and traded securities
**Depends on**: Phase 11
**Requirements**: REQ-v1.2-009, REQ-v1.2-010
**Plans**: 5 plans

Plans:
- [x] 12-01: Employer mapping module: normalization, fuzzy matching (strsim), seed data TOML, unit tests
- [x] 12-02: Schema v5 migration (employer_mappings + employer_lookup tables), donor context DB queries
- [x] 12-03: map-employers CLI command with export, import, and load-seed subcommands
- [x] 12-04: --show-donor-context on trades command, --show-donations on portfolio command
- [x] 12-05: Final verification and user checkpoint

**Details:**
- Jaro-Winkler fuzzy matching via strsim, 0.85 threshold (configurable)
- 52 seed employer-to-issuer mappings in TOML format
- Corporate suffix list sorted by length descending (prevents partial matches)
- Short employer names (< 5 chars) require exact match only
- Schema v5: employer_mappings and employer_lookup tables
- map-employers CLI: export/import/load-seed subcommands
- --show-donor-context on trades, --show-donations on portfolio (stderr output)
- Graceful degradation when donation data absent

---

## Dependency Chain

```
Phase 7 (Foundation) --> Phase 8 (API Client) --> Phase 9 (Schema + Mapping)
                                                        |
                                                        v
                                                  Phase 10 (Sync Pipeline)
                                                        |
                                                        v
                                                  Phase 11 (Donations CLI)
                                                        |
                                                        v
                                                  Phase 12 (Correlation)
```

## Milestone Summary

**Key Decisions:**
- Keyset pagination for OpenFEC Schedule A (no page-based offset)
- (last_name, state) composite key for politician-FEC matching instead of first_name
- Designation-first committee classification (leadership PACs override type-based rules)
- Separate DB handles for concurrent sync (avoids Arc<Mutex> contention)
- Jaro-Winkler over Levenshtein for employer fuzzy matching
- 52 seed mappings shipped (quality over aspirational 200, incremental growth via export/import)

**Issues Resolved:**
- CapitolTrades politician_id format: resolved with name-based matching (not Bioguide ID crosswalk)
- await_holding_lock clippy warning in Phase 9 fixed with scoped MutexGuard in Phase 12
- Ticker format mismatch between employer seed data and DB (resolved in Plan 12-05)

**Issues Deferred:**
- Employer fuzzy matching threshold empirical tuning with real FEC data
- Full 200 employer seed mapping coverage (52 shipped, growth via export/import workflow)
- End-to-end testing with real OpenFEC API data (manual UAT)

**Technical Debt Incurred:**
- Direct ID crosswalk between CapitolTrades and FEC remains a potential improvement over name-based matching
- Employer normalization rules may need expansion as more FEC data is encountered

---

_For current project status, see .planning/ROADMAP.md_
