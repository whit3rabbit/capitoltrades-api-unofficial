# Milestone v1.2: FEC Donation Integration

**Status:** IN PROGRESS
**Phases:** 7-12
**Total Plans:** TBD (refined during phase planning)

## Overview

Extends Capitol Traders with OpenFEC campaign donation data to show who funds each politician, correlated against their trading activity. Adds .env-based API key management, a congress-legislators crosswalk for politician-to-FEC ID mapping, an OpenFEC API client with keyset pagination, a donation sync pipeline, a donations CLI query command, and employer-to-issuer correlation analysis. Six phases covering foundation through advanced correlation, with strict downward dependency flow.

## Phases

### Phase 7: Foundation & Environment Setup
**Goal**: Project can load API keys from environment and resolve politician-to-FEC ID mappings without consuming API budget
**Depends on**: Phase 6 (v1.1 complete)
**Requirements**: REQ-v1.2-001, REQ-v1.2-002
**Research flag**: No -- dotenvy is well-documented, congress-legislators dataset format is known
**Plans**: TBD

**Success Criteria** (what must be TRUE):
  1. Running any donation-related command without a .env file or OPENFEC_API_KEY produces a clear error message explaining how to get and configure the key
  2. .env file is loaded at startup and .gitignore excludes it from version control
  3. Congress-legislators dataset is parsed and politician-to-FEC-ID mappings are stored in SQLite
  4. A lookup by politician name or Bioguide ID returns the correct FEC candidate ID(s)

**Deliverables:**
- dotenvy 0.15 added to workspace dependencies
- .env loading wired into CLI startup (lazy -- only required for donation commands)
- .env.example template with OPENFEC_API_KEY placeholder and registration URL
- .gitignore updated to exclude .env
- Congress-legislators YAML parser (current + historical legislators)
- fec_mappings table populated from congress-legislators data
- Lookup functions by name and Bioguide ID
- Tests for .env loading, YAML parsing, mapping lookups

**Phase ordering rationale:** Every subsequent phase depends on having an API key available and FEC ID mappings resolved. The congress-legislators crosswalk avoids burning API budget on candidate search calls during later phases.

Plans:
- [ ] 07-01: TBD

---

### Phase 8: OpenFEC API Client
**Goal**: System can communicate with the OpenFEC API, handling pagination, rate limits, and errors correctly
**Depends on**: Phase 7
**Requirements**: REQ-v1.2-003
**Research flag**: No -- OpenFEC API is thoroughly documented, follows same patterns as existing API clients
**Plans**: TBD

**Success Criteria** (what must be TRUE):
  1. Client can search for candidates by name and return structured candidate records
  2. Client can fetch all authorized committees for a given candidate ID
  3. Client can fetch Schedule A contributions using keyset pagination (not page numbers)
  4. A 429 rate limit response triggers backoff and circuit breaker, not a crash
  5. Wiremock tests verify all endpoints (success, rate limit, invalid key, multi-page pagination)

**Deliverables:**
- openfec/ module in capitoltraders_lib with client.rs, types.rs, error.rs
- OpenFecClient struct with reqwest::Client, API key, base URL (configurable for wiremock)
- Candidate search endpoint implementation
- Committee lookup endpoint implementation
- Schedule A contributions endpoint with keyset pagination (last_index + last_contribution_receipt_date)
- OpenFecError enum: RateLimited, InvalidKey, NotFound, Network, Parse variants
- Rate limiting: Semaphore concurrency = 3, 429 detection
- Circuit breaker: 5 consecutive failures = trip
- JSON fixture files for deserialization tests
- Wiremock integration tests for success, rate limit, invalid key, and pagination scenarios

**Phase ordering rationale:** The HTTP client must exist before any data flows. This phase is pure library code with no CLI integration, making it independently testable.

Plans:
- [ ] 08-01: TBD

---

### Phase 9: Politician-to-Committee Mapping & Schema v3
**Goal**: Database schema supports donation storage and politician-to-committee resolution is fully operational
**Depends on**: Phase 8
**Requirements**: REQ-v1.2-004, REQ-v1.2-005
**Research flag**: YES -- CapitolTrades politician_id format needs investigation to determine if it maps to Bioguide IDs or is proprietary. Validate with 5-10 real politician records during planning.
**Plans**: TBD

**Success Criteria** (what must be TRUE):
  1. Schema v3 migration adds donations, fec_mappings, and donation_sync_meta tables without breaking existing v2 data
  2. Fresh database creation includes all v1+v2+v3 schema in the base DDL
  3. Given a CapitolTrades politician, the system resolves their FEC candidate ID and all authorized committee IDs
  4. Committee resolution uses three-tier cache (memory -> SQLite -> API) to minimize API calls
  5. Committee types are classified (campaign vs leadership PAC vs joint fundraising)

**Deliverables:**
- Schema v3 migration (PRAGMA user_version 2 -> 3)
- Three new tables: donations (sub_id PK), fec_mappings (politician_id + fec_candidate_id), donation_sync_meta (politician_id + committee_id)
- Base schema DDL updated with all v3 tables for fresh DB creation
- Three-tier committee resolution cache: DashMap -> SQLite fec_mappings -> OpenFEC API
- Committee type classification (campaign, leadership PAC, joint fundraising)
- Resolution pipeline: CapitolTrades politician -> congress-legislators crosswalk -> FEC candidate ID -> committee IDs
- Migration tests (v2-to-v3, idempotency, fresh DB)
- Committee resolution tests (cache hits, cache misses, API fallback, classification)

**Phase ordering rationale:** Schema and committee mapping must exist before the sync pipeline can write donation records. Committee resolution depends on the OpenFEC client from Phase 8.

Plans:
- [ ] 09-01: TBD

---

### Phase 10: Donation Sync Pipeline
**Goal**: Users can sync FEC donation data into their local database for any politician
**Depends on**: Phase 9
**Requirements**: REQ-v1.2-006
**Research flag**: No -- directly reuses Semaphore+JoinSet+mpsc pattern from price enrichment. Only novelty is keyset pagination, which is well-documented.
**Plans**: TBD

**Success Criteria** (what must be TRUE):
  1. `capitoltraders sync-donations --db trades.db --politician "Nancy Pelosi"` fetches and stores Schedule A contributions for all of that politician's committees
  2. Sync is resumable: interrupting and re-running picks up where it left off (keyset cursor persisted)
  3. Duplicate donations are rejected (sub_id deduplication)
  4. Progress is reported during sync (donations synced count, elapsed time)
  5. Circuit breaker halts sync after 5 consecutive 429 errors with an informative message

**Deliverables:**
- `sync-donations` CLI subcommand with --db, --politician, --cycle, --batch-size flags
- Concurrent Schedule A fetch per committee (Semaphore + JoinSet + mpsc, concurrency = 3)
- Keyset pagination loop with cursor state persistence in donation_sync_meta
- Incremental sync via min_date checkpointing (re-sync 90-day overlap window)
- Deduplication by FEC sub_id (ON CONFLICT ignore on insert)
- Circuit breaker (5 consecutive 429s = stop)
- Progress reporting: N donations synced for politician X, elapsed time
- Exit code handling: 0 on success/partial, non-zero on total failure
- Pipeline tests (sync flow, resume, dedup, circuit breaker)

**Phase ordering rationale:** With the client built and schema in place, the sync pipeline is the core data ingestion path. Must exist before any query/display work.

Plans:
- [ ] 10-01: TBD

---

### Phase 11: Donations CLI Command
**Goal**: Users can query and analyze synced donation data through the CLI
**Depends on**: Phase 10
**Requirements**: REQ-v1.2-007, REQ-v1.2-008
**Research flag**: No -- mirrors existing trades/politicians command structure exactly
**Plans**: TBD

**Success Criteria** (what must be TRUE):
  1. `capitoltraders donations --db trades.db --politician "Nancy Pelosi"` lists individual contributions sorted by amount
  2. `--group-by employer` aggregates donations by employer with total amount and count
  3. `--top 10` shows the top N donors by total contribution amount
  4. All 5 output formats work (table, JSON, CSV, markdown, XML)
  5. Filters (--cycle, --min-amount, --employer, --state) narrow results correctly

**Deliverables:**
- `donations` CLI subcommand with --db (required), --politician, --cycle, --min-amount, --employer, --state, --top, --group-by flags
- DonationRow / DonationAggRow types for display layer
- SQLite query functions: query_donations (individual), query_donations_grouped (aggregated)
- Aggregation modes: by contributor, by employer, by state
- Top N donors by total contribution amount
- Cycle totals (2-year election period grouping)
- Geographic donor concentration (state-level)
- Max-out donor identification ($3,300 per-election limit)
- Committee-level breakdown (campaign vs leadership PAC split)
- All 5 output format functions (table, JSON, CSV, markdown, XML)
- Input validation for all new filter parameters
- Output tests, query tests, validation tests

**Phase ordering rationale:** Data must be synced before it can be queried/displayed. The read path (donations command) is fully SQLite-based, requiring no API calls.

Plans:
- [ ] 11-01: TBD

---

### Phase 12: Employer Correlation & Analysis
**Goal**: Users can see connections between donation sources and traded securities
**Depends on**: Phase 11
**Requirements**: REQ-v1.2-009, REQ-v1.2-010
**Research flag**: YES -- Employer normalization and fuzzy matching thresholds need empirical tuning with real FEC data. The strsim crate is well-documented but threshold selection (0.85 vs 0.90) requires testing against actual employer name distributions.
**Plans**: TBD

**Success Criteria** (what must be TRUE):
  1. Employer names are normalized and matched against stock issuers with confidence scores
  2. `--show-donor-context` on trades command displays donation context for the politician's traded sectors
  3. Portfolio output includes optional donation summary (total received, top employer sectors) when donation data exists
  4. Unmatched employers can be exported for manual review and re-imported as confirmed mappings

**Deliverables:**
- Employer normalization module (lowercase, strip corporate suffixes, collapse whitespace)
- Manual seed data for top 200 employers with ticker/sector mappings (JSON file)
- strsim dependency added (Jaro-Winkler fuzzy matching)
- Confidence-scored matching: exact (1.0), fuzzy (0.85-0.99), no match (skip)
- Export-review-import workflow for unmatched employers (CSV export, validated import)
- --show-donor-context flag on trades command
- Optional donation summary in portfolio output
- Graceful no-op when no donation data exists
- Normalization tests, matching tests, integration tests

**Phase ordering rationale:** Employer correlation is highest-risk, highest-reward. Deferring it means core donation features (phases 7-11) ship even if fuzzy matching proves harder than expected. Requires both donation data (Phase 10-11) and trade data (existing) to be meaningful.

---

## Dependency Chain

```
Phase 7 (Foundation) --> Phase 8 (API Client) --> Phase 9 (Schema + Mapping)
                                                        |
                                                        v
                                                  Phase 10 (Sync Pipeline)
                                                        |
                                                        v
                                                  Phase 11 (Donations CLI)
                                                        |
                                                        v
                                                  Phase 12 (Correlation)
```

All dependencies are strict and linear. Each phase builds on the previous.

## Research Flags Summary

| Phase | Needs Research | Reason |
|-------|---------------|--------|
| 7 | No | dotenvy and congress-legislators are well-documented |
| 8 | No | OpenFEC API follows same patterns as existing clients |
| 9 | YES | CapitolTrades politician_id format needs investigation for crosswalk strategy |
| 10 | No | Reuses established Semaphore+JoinSet+mpsc enrichment pattern |
| 11 | No | Mirrors existing CLI command structure exactly |
| 12 | YES | Employer fuzzy matching thresholds need empirical tuning with real data |

## Coverage Verification

| Requirement | Phase | Category |
|-------------|-------|----------|
| REQ-v1.2-001 (.env loading) | Phase 7 | Environment |
| REQ-v1.2-002 (Congress-legislators crosswalk) | Phase 7 | Foundation |
| REQ-v1.2-003 (OpenFEC API client) | Phase 8 | API Client |
| REQ-v1.2-004 (Schema v3 migration) | Phase 9 | Data Model |
| REQ-v1.2-005 (Committee resolution pipeline) | Phase 9 | Data Model |
| REQ-v1.2-006 (Donation sync command) | Phase 10 | Sync Pipeline |
| REQ-v1.2-007 (Donations CLI subcommand) | Phase 11 | Query & Display |
| REQ-v1.2-008 (Donation analysis aggregations) | Phase 11 | Query & Display |
| REQ-v1.2-009 (Employer-to-issuer correlation) | Phase 12 | Correlation |
| REQ-v1.2-010 (Donation context in existing commands) | Phase 12 | Integration |

**Coverage: 10/10 requirements mapped (100%). No orphans.**

---

_For current project status, see .planning/ROADMAP.md_
