---
phase: 16-conflict-detection
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - capitoltraders_lib/src/db.rs
  - capitoltraders_cli/src/commands/conflicts.rs
  - capitoltraders_cli/src/commands/mod.rs
  - capitoltraders_cli/src/main.rs
  - capitoltraders_cli/src/output.rs
autonomous: true

must_haves:
  truths:
    - "User can query committee trading scores for all politicians via CLI"
    - "User can filter conflict results by politician name"
    - "User can filter conflict results by committee name"
    - "User can set minimum committee trading percentage threshold"
    - "User can see donation-trade correlations with donor count and total amount"
    - "Disclaimer about current committee assignments appears in all output"
    - "Output supports all 5 formats (table, JSON, CSV, markdown, XML)"
  artifacts:
    - path: "capitoltraders_lib/src/db.rs"
      provides: "Conflict query methods on Db"
      exports: ["query_committee_related_trades", "query_donation_trade_correlations", "get_politician_committee_names"]
    - path: "capitoltraders_cli/src/commands/conflicts.rs"
      provides: "Conflicts CLI subcommand implementation"
      exports: ["ConflictsArgs", "run"]
    - path: "capitoltraders_cli/src/output.rs"
      provides: "Conflict output formatting functions"
      exports: ["print_conflict_table", "print_conflict_csv", "print_conflict_markdown", "print_conflict_xml"]
    - path: "capitoltraders_cli/src/main.rs"
      provides: "Conflicts command wired into CLI dispatch"
      contains: "Commands::Conflicts"
  key_links:
    - from: "capitoltraders_cli/src/commands/conflicts.rs"
      to: "capitoltraders_lib/src/conflict.rs"
      via: "calculate_committee_trading_score import"
      pattern: "use capitoltraders_lib.*calculate_committee_trading_score"
    - from: "capitoltraders_cli/src/commands/conflicts.rs"
      to: "capitoltraders_lib/src/db.rs"
      via: "Db query methods"
      pattern: "db\\.query_donation_trade_correlations"
    - from: "capitoltraders_cli/src/commands/conflicts.rs"
      to: "capitoltraders_lib/src/committee_jurisdiction.rs"
      via: "load_committee_jurisdictions"
      pattern: "load_committee_jurisdictions"
    - from: "capitoltraders_cli/src/main.rs"
      to: "capitoltraders_cli/src/commands/conflicts.rs"
      via: "Command dispatch"
      pattern: "Commands::Conflicts"
---

<objective>
Wire conflict scoring to database queries and create the conflicts CLI subcommand.

Purpose: Enable users to query committee-sector trading scores and donation-trade correlations through a dedicated CLI command, fulfilling CONF-01 through CONF-04 requirements.

Output: DB query methods for conflict data, conflicts CLI subcommand with filtering, output in all 5 formats with disclaimer.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-conflict-detection/16-RESEARCH.md
@.planning/phases/16-conflict-detection/16-01-SUMMARY.md
@capitoltraders_lib/src/db.rs
@capitoltraders_lib/src/conflict.rs
@capitoltraders_lib/src/committee_jurisdiction.rs
@capitoltraders_cli/src/commands/analytics.rs
@capitoltraders_cli/src/commands/mod.rs
@capitoltraders_cli/src/main.rs
@capitoltraders_cli/src/output.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB conflict query methods</name>
  <files>
    capitoltraders_lib/src/db.rs
  </files>
  <action>
Add three new query methods to the Db impl in db.rs:

1. get_politician_committee_names(&self, politician_id: &str) -> Result<Vec<String>, DbError>
   - Query: SELECT committee FROM politician_committees WHERE politician_id = ?1
   - Returns list of committee names for a politician
   - Empty Vec if politician has no committee assignments

2. get_all_politicians_with_committees(&self) -> Result<Vec<(String, String, Vec<String>)>, DbError>
   - Query: SELECT DISTINCT p.politician_id, p.first_name || ' ' || p.last_name, GROUP_CONCAT(pc.committee) FROM politicians p JOIN politician_committees pc ON p.politician_id = pc.politician_id GROUP BY p.politician_id
   - Returns (politician_id, politician_name, committee_names) tuples
   - Split GROUP_CONCAT result on comma to produce Vec of committee names
   - Only includes politicians who have at least one committee assignment

3. query_donation_trade_correlations(&self, min_confidence: f64) -> Result<Vec<DonationTradeCorrelation>, DbError>
   - Import DonationTradeCorrelation from crate::conflict
   - SQL query joins: closed trade data (from query_trades_for_analytics pattern) -> issuers (for ticker) -> employer_mappings (for ticker-employer link) -> employer_lookup (for raw-to-normalized mapping) -> donations (for employer match) -> donation_sync_meta (for politician_id link)
   - Filter: employer_mappings.confidence >= min_confidence parameter (default will be 0.90 at CLI level)
   - Group by: politician_id, ticker
   - Select: politician_id, politician_name (from politicians JOIN), ticker, COUNT(DISTINCT contributor_employer) as matching_donor_count, AVG(em.confidence) as avg_mapping_confidence, GROUP_CONCAT(DISTINCT contributor_employer) as donor_employers, SUM(contribution_receipt_amount) as total_donation_amount
   - Order by: matching_donor_count DESC, total_donation_amount DESC
   - HAVING matching_donor_count > 0

   IMPORTANT: The donation-trade correlation SQL is complex. Key JOIN path:
   trades t -> issuers i (for ticker) -> employer_mappings em (ticker match) -> donations d (employer match via LOWER(d.contributor_employer) compared against employer_lookup or em.normalized_employer) -> donation_sync_meta dsm (for politician_id link to ensure we are matching the SAME politician's donations to their trades).

   The query must ensure the politician who received the donation is the same politician who made the trade. This means joining donation_sync_meta.politician_id = t.politician_id.

   Handle the case where employer_mappings or donations tables may be empty (no donation data synced yet) -- return empty Vec, do not error.

Add unit tests using in-memory DB:
- test_get_politician_committee_names: insert politician + committees, verify retrieval
- test_get_politician_committee_names_empty: politician with no committees returns empty Vec
- test_get_all_politicians_with_committees: multiple politicians with committees, verify all returned
- test_query_donation_trade_correlations_empty: no donations -> empty Vec (no error)
  </action>
  <verify>
    cargo test -p capitoltraders_lib get_politician_committee_names -- --nocapture
    cargo test -p capitoltraders_lib get_all_politicians_with_committees -- --nocapture
    cargo test -p capitoltraders_lib query_donation_trade_correlations -- --nocapture
    cargo check --workspace
  </verify>
  <done>
    Three DB query methods implemented and tested. get_politician_committee_names returns committee names for a politician. get_all_politicians_with_committees returns all politicians with committee assignments. query_donation_trade_correlations returns employer-trade matches above confidence threshold. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Conflicts CLI subcommand with output formatting</name>
  <files>
    capitoltraders_cli/src/commands/conflicts.rs
    capitoltraders_cli/src/commands/mod.rs
    capitoltraders_cli/src/main.rs
    capitoltraders_cli/src/output.rs
  </files>
  <action>
Create capitoltraders_cli/src/commands/conflicts.rs as a new CLI subcommand following the analytics.rs pattern.

ConflictsArgs (clap Args):
- db: PathBuf (required, --db flag)
- politician: Option<String> (--politician, filter by name)
- committee: Option<String> (--committee, filter by committee name)
- min_committee_pct: f64 (--min-committee-pct, default 0.0, range 0-100)
- include_donations: bool (--include-donations flag, shows donation-trade correlations)
- min_confidence: f64 (--min-confidence, default 0.90, for donation correlation filtering)
- top: usize (--top, default 25)

run() function implementation:
1. Open DB, load committee jurisdictions via load_committee_jurisdictions()
2. Query all enriched trades via db.query_trades_for_analytics()
3. Run FIFO matching via calculate_closed_trades() to get closed trades
4. Get politicians with committees via db.get_all_politicians_with_committees()
5. For each politician with committees:
   a. Filter their closed trades from the full set
   b. Get their committee names
   c. If --committee filter provided, skip politicians not on that committee
   d. Call calculate_committee_trading_score()
   e. If score >= min_committee_pct, include in results
6. If --politician filter provided, use find_politician_by_name() (existing DB method from Phase 10) to resolve name, then filter results
7. Sort by committee_trading_pct descending
8. Truncate to --top
9. Output committee trading scores via format dispatch
10. If --include-donations, also query donation_trade_correlations and output separately
11. Print disclaimer to stderr: "Note: Based on current committee assignments. Historical committee membership not tracked. Trades with unknown sector excluded from scoring."

ConflictRow struct for output (Serialize):
- rank: usize
- politician_name: String
- committees: String (comma-joined)
- total_scored_trades: usize
- committee_related_trades: usize
- committee_trading_pct: f64

DonationCorrelationRow struct for output (Serialize):
- politician_name: String
- ticker: String
- matching_donors: i64
- total_donations: f64
- donor_employers: String

Output functions in output.rs:
- print_conflict_table(rows: &[ConflictRow]) -- table format using tabled
- print_conflict_csv(rows: &[ConflictRow]) -> Result<()> -- CSV with sanitization
- print_conflict_markdown(rows: &[ConflictRow]) -- Markdown table
- print_conflict_xml(rows: &[ConflictRow]) -- XML output
- print_donation_correlation_table(rows: &[DonationCorrelationRow]) -- table for donations
- print_donation_correlation_csv(rows: &[DonationCorrelationRow]) -> Result<()>
- print_donation_correlation_markdown(rows: &[DonationCorrelationRow])
- print_donation_correlation_xml(rows: &[DonationCorrelationRow])

Follow existing output.rs patterns for table building (tabled), CSV (csv writer with sanitization), Markdown (manual format), and XML (quick-xml bridge).

Wire into CLI:
- Add `pub mod conflicts;` to commands/mod.rs
- Add `Conflicts(commands::conflicts::ConflictsArgs)` variant to Commands enum in main.rs (use Box if struct is large per clippy convention)
- Add match arm: Commands::Conflicts(args) => commands::conflicts::run(args, &format)?
- The conflicts command is DB-only (no scrape mode), similar to analytics

Summary output to stderr after results:
"Showing {N}/{total} politicians with committee assignments ({M} scored trades, confidence >= {confidence})"

IMPORTANT: Apply CSV formula injection sanitization on donor_employers field (user-contributed content). Reuse sanitize_csv_field pattern from output.rs.
  </action>
  <verify>
    cargo build --workspace
    cargo clippy --workspace
    cargo test --workspace
    cargo run -p capitoltraders_cli -- conflicts --help
  </verify>
  <done>
    Conflicts CLI subcommand compiles and shows help. Output supports all 5 formats. Committee trading scores computed and displayed. Donation correlations available via --include-donations. Disclaimer appears in output. CSV sanitization applied. Wired into main.rs dispatch. cargo clippy clean. All workspace tests pass.
  </done>
</task>

</tasks>

<verification>
- cargo run -p capitoltraders_cli -- conflicts --help (shows all arguments)
- cargo build --workspace (compiles cleanly)
- cargo test --workspace (no regressions)
- cargo clippy --workspace (no warnings)
- Verify ConflictRow and DonationCorrelationRow have Serialize derive for JSON output
- Verify disclaimer text appears in all output modes (stderr)
</verification>

<success_criteria>
- `capitoltraders conflicts --db path.db` shows committee trading scores for politicians
- `capitoltraders conflicts --db path.db --politician "Pelosi"` filters by politician
- `capitoltraders conflicts --db path.db --committee "Financial Services"` filters by committee
- `capitoltraders conflicts --db path.db --min-committee-pct 50` applies threshold
- `capitoltraders conflicts --db path.db --include-donations` shows donation-trade correlations
- Output works in all 5 formats (--output table/json/csv/md/xml)
- Disclaimer prints to stderr in all modes
- All workspace tests pass, clippy clean
</success_criteria>

<output>
After completion, create `.planning/phases/16-conflict-detection/16-02-SUMMARY.md`
</output>
