---
phase: 16-conflict-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - seed_data/committee_sectors.yml
  - capitoltraders_lib/src/committee_jurisdiction.rs
  - capitoltraders_lib/src/conflict.rs
  - capitoltraders_lib/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Committee-sector jurisdiction mappings load and validate at compile time"
    - "All sectors in YAML are valid GICS sectors"
    - "Committee trading score computes correctly for politicians with committee assignments"
    - "Committee trading score handles NULL gics_sector by excluding those trades from scoring"
    - "Overlapping committee jurisdictions are deduplicated via HashSet"
  artifacts:
    - path: "seed_data/committee_sectors.yml"
      provides: "Committee-to-GICS-sector jurisdiction mapping for ~15 major committees"
      contains: "committee_name"
    - path: "capitoltraders_lib/src/committee_jurisdiction.rs"
      provides: "YAML types, load function, validation"
      exports: ["CommitteeJurisdiction", "load_committee_jurisdictions", "validate_committee_jurisdictions"]
    - path: "capitoltraders_lib/src/conflict.rs"
      provides: "Conflict scoring types and pure computation functions"
      exports: ["CommitteeTradingScore", "DonationTradeCorrelation", "calculate_committee_trading_score"]
    - path: "capitoltraders_lib/src/lib.rs"
      provides: "Module declarations and pub use re-exports"
      contains: "pub mod committee_jurisdiction"
  key_links:
    - from: "capitoltraders_lib/src/committee_jurisdiction.rs"
      to: "seed_data/committee_sectors.yml"
      via: "include_str! compile-time embedding"
      pattern: "include_str!.*committee_sectors\\.yml"
    - from: "capitoltraders_lib/src/committee_jurisdiction.rs"
      to: "capitoltraders_lib/src/sector_mapping.rs"
      via: "validate_sector reuse"
      pattern: "use crate::sector_mapping"
    - from: "capitoltraders_lib/src/conflict.rs"
      to: "capitoltraders_lib/src/committee_jurisdiction.rs"
      via: "CommitteeJurisdiction type usage"
      pattern: "use crate::committee_jurisdiction"
---

<objective>
Create committee-sector jurisdiction mapping data and conflict scoring computation module.

Purpose: Provide the foundational data (which GICS sectors fall under each congressional committee's jurisdiction) and pure scoring logic (committee trading percentage) that Plan 02 will wire to DB queries and CLI output.

Output: committee_sectors.yml seed data, committee_jurisdiction.rs module, conflict.rs scoring module with unit tests.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-conflict-detection/16-RESEARCH.md
@capitoltraders_lib/src/sector_mapping.rs
@capitoltraders_lib/src/analytics.rs
@capitoltraders_lib/src/lib.rs
@seed_data/gics_sector_mapping.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Committee-sector jurisdiction YAML and loader module</name>
  <files>
    seed_data/committee_sectors.yml
    capitoltraders_lib/src/committee_jurisdiction.rs
    capitoltraders_lib/src/lib.rs
  </files>
  <action>
Create seed_data/committee_sectors.yml with committee-to-GICS-sector mappings for major congressional committees. Include at minimum these committees with their sector jurisdictions:

House committees:
- House Financial Services -> Financials
- House Energy and Commerce -> Energy, Utilities, Communication Services, Health Care, Consumer Discretionary, Consumer Staples (broadest jurisdiction)
- House Agriculture -> Consumer Staples
- House Transportation and Infrastructure -> Industrials, Real Estate
- House Armed Services -> Industrials
- House Science, Space, and Technology -> Information Technology

Senate committees:
- Senate Banking, Housing, and Urban Affairs -> Financials
- Senate Commerce, Science, and Transportation -> Communication Services, Information Technology, Industrials
- Senate Energy and Natural Resources -> Energy, Materials
- Senate Health, Education, Labor, and Pensions -> Health Care
- Senate Agriculture, Nutrition, and Forestry -> Consumer Staples
- Senate Armed Services -> Industrials
- Senate Environment and Public Works -> Utilities, Materials

Also include committees with no specific sector jurisdiction (empty sectors array):
- House Ways and Means (tax policy applies to all sectors equally)
- Senate Judiciary
- Senate Foreign Relations

YAML schema: top-level `committees` array, each entry has `committee_name` (String), `chamber` ("House" or "Senate"), `sectors` (array of GICS sector names), `notes` (optional string explaining jurisdiction).

Create capitoltraders_lib/src/committee_jurisdiction.rs following the sector_mapping.rs pattern exactly:

1. Define CommitteeJurisdiction struct (Deserialize, Debug, Clone) with fields: committee_name, chamber, sectors (Vec of String), notes (Option of String).
2. Define CommitteeJurisdictionFile struct (Deserialize) with `committees` field.
3. Define error handling -- reuse SectorMappingError from sector_mapping.rs. Add a new variant InvalidSeedData(String) to SectorMappingError if it does not already exist (check first). If it already exists, reuse it. If not feasible, create a local error type.
4. Implement load_committee_jurisdictions() using include_str!("../../seed_data/committee_sectors.yml") for compile-time embedding. Parse with serde_yml. Validate all sectors using validate_sector() from sector_mapping.rs. Validate chamber is "House" or "Senate". Return Vec of CommitteeJurisdiction.
5. Implement validate_committee_jurisdictions() that takes a slice of CommitteeJurisdiction and validates all sectors and chambers.
6. Implement get_committee_sectors() that takes a slice of CommitteeJurisdiction and a slice of politician committee names (strings), returns a HashSet of String containing all GICS sectors under those committees' jurisdictions. This is the deduplication function that prevents double-counting from overlapping jurisdictions.

Add unit tests:
- test_load_committee_jurisdictions_succeeds: loads YAML, verifies count >= 15
- test_all_sectors_valid_gics: every sector in loaded data is in GICS_SECTORS
- test_get_committee_sectors_single: single committee returns expected sectors
- test_get_committee_sectors_overlap: two committees with overlapping sectors returns deduplicated set
- test_get_committee_sectors_unknown_committee: unknown committee name is silently skipped (no error)
- test_empty_sectors_committee: committees with empty sectors array produce empty set
- test_chamber_validation: invalid chamber rejected

Add `pub mod committee_jurisdiction;` to lib.rs. Add pub use exports for CommitteeJurisdiction, load_committee_jurisdictions, get_committee_sectors.

IMPORTANT: The committee names in the YAML must match what exists in the politician_committees table. Those committee names come from the CapitolTrades scrape data (NOT FEC committees). Check the politician_committees table structure -- the `committee` column stores short codes like "ssfi", "hsag" or full names depending on what sync populates. The research warns about this pitfall (Pitfall 1). If the sync stores short codes, the YAML must use matching short codes OR the conflict scoring must handle the mapping. Look at the replace_all_politician_committees function and how committee names flow from the scrape. Use whatever format the DB actually stores. If you cannot determine the format from code alone, use full committee names in the YAML and document that a mapping layer may be needed.
  </action>
  <verify>
    cargo test -p capitoltraders_lib committee_jurisdiction -- --nocapture
    cargo check --workspace
  </verify>
  <done>
    committee_sectors.yml contains 15+ committee entries with valid GICS sectors. committee_jurisdiction.rs loads and validates the YAML at compile time. get_committee_sectors correctly deduplicates overlapping jurisdictions. All unit tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Conflict scoring module with committee trading score and types</name>
  <files>
    capitoltraders_lib/src/conflict.rs
    capitoltraders_lib/src/lib.rs
  </files>
  <action>
Create capitoltraders_lib/src/conflict.rs with conflict scoring types and pure computation functions.

Define types:

1. CommitteeTradingScore:
   - politician_id: String
   - politician_name: String (for display)
   - committee_names: Vec of String
   - total_scored_trades: usize (trades with known gics_sector, excludes NULL sector)
   - committee_related_trades: usize
   - committee_trading_pct: f64 (0.0 to 100.0)
   - disclaimer: String (always "Based on current committee assignments; may not reflect assignment at trade time")

2. DonationTradeCorrelation (for Plan 02 DB results):
   - politician_id: String
   - politician_name: String
   - ticker: String
   - matching_donor_count: i64
   - avg_mapping_confidence: f64
   - donor_employers: String (comma-separated)
   - total_donation_amount: f64
   Both types should derive Serialize, Debug, Clone.

3. ConflictSummary (combines both signals for a politician):
   - politician_id: String
   - politician_name: String
   - committee_score: Option of CommitteeTradingScore
   - donation_correlations: Vec of DonationTradeCorrelation
   - disclaimer: String

Implement pure functions:

calculate_committee_trading_score():
- Takes: closed_trades (slice of analytics::ClosedTrade), politician_committees (slice of String), committee_jurisdictions (slice of CommitteeJurisdiction from committee_jurisdiction.rs), politician_id and politician_name (Strings)
- Uses get_committee_sectors() to build sector HashSet
- Filters closed trades to those with known gics_sector (requires adding gics_sector field to ClosedTrade -- see below)
- Counts trades where gics_sector is in committee_sectors HashSet
- Returns CommitteeTradingScore with percentage
- If no committee sectors (politician has no mapped committees), return 0% with total_scored_trades = 0

IMPORTANT: ClosedTrade in analytics.rs currently does NOT have a gics_sector field. The scoring function needs to know each trade's sector. Two options:
A) Add an optional gics_sector field to ClosedTrade (modifies analytics.rs)
B) Accept a parallel structure or lookup function

Choose option A: Add `pub gics_sector: Option<String>` to ClosedTrade in analytics.rs. Update AnalyticsPosition::sell() to propagate sector from the buy lot. This requires also adding gics_sector to AnalyticsTrade and AnalyticsLot. The DB query (query_trades_for_analytics) already returns gics_sector in AnalyticsTradeRow, and the CLI analytics.rs row_to_analytics_trade conversion just needs to pass it through. Update all existing test ClosedTrade constructors to include gics_sector: None so existing tests still pass.

Add unit tests in conflict.rs:
- test_committee_trading_score_basic: politician on Financial Services, 3 trades (2 Financials, 1 Energy) -> 66.7%
- test_committee_trading_score_no_committees: politician with no committees -> 0%
- test_committee_trading_score_no_trades: politician with committees but no trades -> 0%
- test_committee_trading_score_null_sectors_excluded: trades with None gics_sector excluded from both numerator and denominator
- test_committee_trading_score_overlapping_jurisdictions: politician on two committees with overlapping sectors, single trade counted once
- test_committee_trading_score_disclaimer_present: verify disclaimer field is populated
- test_donation_trade_correlation_type: verify DonationTradeCorrelation struct fields

Add `pub mod conflict;` to lib.rs. Add pub use exports for CommitteeTradingScore, DonationTradeCorrelation, ConflictSummary, calculate_committee_trading_score.
  </action>
  <verify>
    cargo test -p capitoltraders_lib conflict -- --nocapture
    cargo test -p capitoltraders_lib analytics -- --nocapture
    cargo test --workspace
    cargo clippy --workspace
  </verify>
  <done>
    conflict.rs contains CommitteeTradingScore, DonationTradeCorrelation, ConflictSummary types and calculate_committee_trading_score function. ClosedTrade extended with gics_sector field. All existing analytics tests still pass. All 7+ conflict unit tests pass. cargo clippy clean.
  </done>
</task>

</tasks>

<verification>
- cargo test -p capitoltraders_lib committee_jurisdiction (all YAML/validation tests pass)
- cargo test -p capitoltraders_lib conflict (all scoring tests pass)
- cargo test -p capitoltraders_lib analytics (existing tests unbroken after ClosedTrade extension)
- cargo test --workspace (no regressions)
- cargo clippy --workspace (no warnings)
</verification>

<success_criteria>
- Committee jurisdiction YAML loads with 15+ committees, all sectors validated against GICS
- get_committee_sectors correctly deduplicates overlapping jurisdictions
- calculate_committee_trading_score produces correct percentages
- NULL gics_sector trades excluded from scoring denominator
- ClosedTrade extended with gics_sector without breaking existing analytics module
- All workspace tests pass, clippy clean
</success_criteria>

<output>
After completion, create `.planning/phases/16-conflict-detection/16-01-SUMMARY.md`
</output>
