---
phase: 12-employer-correlation-analysis
plan: 04
type: execute
wave: 2
depends_on: ["12-02"]
files_modified:
  - capitoltraders_cli/src/commands/trades.rs
  - capitoltraders_cli/src/commands/portfolio.rs
  - capitoltraders_lib/src/db.rs
autonomous: true

must_haves:
  truths:
    - "--show-donor-context on trades displays top employers donating to the politician in the traded issuer's sector"
    - "Portfolio output includes optional donation summary when politician filter is active and donation data exists"
    - "Both features gracefully no-op when no donation data or no employer mappings exist"
    - "Existing trades and portfolio functionality is unaffected when new flags are not used"
  artifacts:
    - path: "capitoltraders_cli/src/commands/trades.rs"
      provides: "--show-donor-context flag and donor context display logic"
      contains: "show_donor_context"
    - path: "capitoltraders_cli/src/commands/portfolio.rs"
      provides: "Donation summary display after portfolio output"
      contains: "get_donation_summary"
    - path: "capitoltraders_lib/src/db.rs"
      provides: "politician_id and issuer_sector fields on DbTradeRow, updated query_trades SQL"
      contains: "issuer_sector"
  key_links:
    - from: "capitoltraders_cli/src/commands/trades.rs"
      to: "capitoltraders_lib::Db::get_donor_context_for_sector"
      via: "method call after trade output"
      pattern: "get_donor_context_for_sector"
    - from: "capitoltraders_cli/src/commands/portfolio.rs"
      to: "capitoltraders_lib::Db::get_donation_summary"
      via: "method call after portfolio output"
      pattern: "get_donation_summary"
    - from: "capitoltraders_lib/src/db.rs DbTradeRow"
      to: "query_trades SQL SELECT"
      via: "politician_id and issuer_sector added to struct and query"
      pattern: "politician_id.*issuer_sector"
---

<objective>
Add --show-donor-context flag to trades command and optional donation summary to portfolio command.

Purpose: This is the user-facing correlation feature -- the whole point of Phase 12. When a user views trades, they can optionally see which employers in the traded security's sector donated to the politician. When viewing a portfolio, they see a donation summary. Both are opt-in and gracefully handle missing data.

Output: Updated trades.rs, portfolio.rs, and db.rs (DbTradeRow fields) with donation context features.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-employer-correlation-analysis/12-RESEARCH.md
@.planning/phases/12-employer-correlation-analysis/12-02-SUMMARY.md
@capitoltraders_cli/src/commands/trades.rs
@capitoltraders_cli/src/commands/portfolio.rs
@capitoltraders_cli/src/main.rs
@capitoltraders_lib/src/db.rs (DbTradeRow struct, query_trades method, DonorContext, DonationSummary, get_donor_context_for_sector, get_donation_summary)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --show-donor-context flag to trades command</name>
  <files>
    capitoltraders_cli/src/commands/trades.rs
    capitoltraders_lib/src/db.rs
  </files>
  <action>
    1. Add a new flag to TradesArgs struct:
    ```rust
    /// Show donation context for traded securities (requires synced donations and employer mappings)
    #[arg(long)]
    pub show_donor_context: bool,
    ```

    2. In db.rs, add `pub politician_id: String` and `pub issuer_sector: Option<String>` fields to DbTradeRow. Update the query_trades SQL SELECT to include `t.politician_id` and `i.sector AS issuer_sector` (the issuers table is already JOINed for issuer_name/issuer_ticker). Update the row mapping closure to read these new fields.

    3. In the `run_db` function in trades.rs, after the existing trade output (after the match on format block), add donor context logic:

    ```rust
    if args.show_donor_context {
        let mut seen: HashSet<(String, String)> = HashSet::new();
        let mut any_context = false;

        for trade in &rows {
            if let Some(ref sector) = trade.issuer_sector {
                let key = (trade.politician_id.clone(), sector.clone());
                if seen.contains(&key) {
                    continue;
                }
                seen.insert(key);

                let context = db.get_donor_context_for_sector(
                    &trade.politician_id,
                    sector,
                    5,  // top 5 employers
                )?;

                if !context.is_empty() {
                    if !any_context {
                        eprintln!("\n--- Donor Context ---");
                        any_context = true;
                    }
                    eprintln!(
                        "\n{} - {} sector:",
                        trade.politician_name, sector
                    );
                    for dc in &context {
                        eprintln!(
                            "  {:40} ${:>12.0} ({} donations)",
                            dc.employer, dc.total_amount, dc.donation_count
                        );
                    }
                }
            }
        }

        if !any_context && !rows.is_empty() {
            eprintln!("\nNo donor context available. Run 'map-employers load-seed' or 'map-employers export/import' to build employer mappings.");
        }
    }
    ```

    4. The --show-donor-context flag is ONLY available in DB mode. In scrape mode (run function), if show_donor_context is true, print a note: "Note: --show-donor-context requires --db mode." and continue without it.

    5. Add `use std::collections::HashSet;` at the top of trades.rs.

    6. Verify that existing DB trade output tests still pass. The new fields (politician_id, issuer_sector) should not affect output formatting since they are not rendered in the table/CSV/JSON output -- they are only used by the donor context logic.
  </action>
  <verify>
    `cargo check --workspace` -- compiles.
    `cargo clippy --workspace` -- no warnings.
    `cargo run -p capitoltraders_cli -- trades --help` -- shows --show-donor-context flag.
    Existing trades tests still pass: `cargo test --workspace`.
  </verify>
  <done>
    --show-donor-context flag added to trades command. DB mode displays top 5 employers in each traded sector. Gracefully handles no-data case. Scrape mode shows informative note. politician_id and issuer_sector added to DbTradeRow in db.rs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add optional donation summary to portfolio output</name>
  <files>
    capitoltraders_cli/src/commands/portfolio.rs
  </files>
  <action>
    1. Add a new flag to PortfolioArgs:
    ```rust
    /// Show donation summary for the politician (requires synced donations)
    #[arg(long)]
    pub show_donations: bool,
    ```

    2. In the `run` function, after the existing format output block (after the option_count note), add donation summary logic:

    ```rust
    // Donation summary (opt-in or auto-detect when politician filter active)
    if args.show_donations {
        if let Some(ref pid) = filter.politician_id {
            match db.get_donation_summary(pid) {
                Ok(Some(summary)) => {
                    eprintln!("\n--- Donation Summary ---");
                    eprintln!(
                        "Total received: ${:.0} ({} contributions)",
                        summary.total_amount, summary.donation_count
                    );
                    if !summary.top_sectors.is_empty() {
                        eprintln!("Top employer sectors (matched):");
                        for st in &summary.top_sectors {
                            eprintln!(
                                "  {:30} ${:>12.0} ({} employers)",
                                st.sector, st.total_amount, st.employer_count
                            );
                        }
                    }
                }
                Ok(None) => {
                    eprintln!("\nNo donation data available for this politician.");
                    eprintln!("Hint: Run 'capitoltraders sync-donations --db {} --politician ...' first.", args.db.display());
                }
                Err(e) => {
                    // Non-fatal: log warning but don't fail the portfolio command
                    eprintln!("\nWarning: Could not load donation summary: {}", e);
                }
            }
        } else {
            eprintln!("\nNote: --show-donations requires --politician filter to display donation summary.");
        }
    }
    ```

    3. Import DonationSummary is not needed since we only call db methods and match on the result. But ensure capitoltraders_lib::Db is imported (already is).

    Key design decisions:
    - --show-donations is explicit opt-in (not auto-detect) to keep behavior predictable
    - Requires --politician filter because donation summary is per-politician
    - Errors are non-fatal (eprintln warning) so portfolio output is never broken by donation data issues
    - Output goes to stderr (eprintln) so it does not interfere with piped stdout (JSON/CSV output)
  </action>
  <verify>
    `cargo check --workspace` -- compiles.
    `cargo clippy --workspace` -- no warnings.
    `cargo run -p capitoltraders_cli -- portfolio --help` -- shows --show-donations flag.
    Existing portfolio functionality unaffected: `cargo test --workspace`.
  </verify>
  <done>
    --show-donations flag added to portfolio command. When used with --politician, displays total donations received and top employer sectors. Gracefully handles missing data. Non-fatal errors. Output on stderr to preserve stdout for data formats.
  </done>
</task>

</tasks>

<verification>
- `cargo test --workspace` -- all tests pass
- `cargo clippy --workspace` -- no warnings
- trades --help shows --show-donor-context
- portfolio --help shows --show-donations
- Existing trades/portfolio commands work identically without new flags
- New flags produce helpful messages when data is missing
</verification>

<success_criteria>
- --show-donor-context on trades displays top employers per (politician, sector) pair
- --show-donations on portfolio displays donation summary when --politician is active
- Both features no-op gracefully when no donation/mapping data exists
- Output on stderr preserves stdout for data format piping
- No changes to existing command behavior when new flags are not used
- DbTradeRow in db.rs has politician_id and issuer_sector fields
</success_criteria>

<output>
After completion, create `.planning/phases/12-employer-correlation-analysis/12-04-SUMMARY.md`
</output>
