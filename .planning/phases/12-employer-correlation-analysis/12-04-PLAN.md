---
phase: 12-employer-correlation-analysis
plan: 04
type: execute
wave: 2
depends_on: ["12-02"]
files_modified:
  - capitoltraders_cli/src/commands/trades.rs
  - capitoltraders_cli/src/commands/portfolio.rs
autonomous: true

must_haves:
  truths:
    - "--show-donor-context on trades displays top employers donating to the politician in the traded issuer's sector"
    - "Portfolio output includes optional donation summary when politician filter is active and donation data exists"
    - "Both features gracefully no-op when no donation data or no employer mappings exist"
    - "Existing trades and portfolio functionality is unaffected when new flags are not used"
  artifacts:
    - path: "capitoltraders_cli/src/commands/trades.rs"
      provides: "--show-donor-context flag and donor context display logic"
      contains: "show_donor_context"
    - path: "capitoltraders_cli/src/commands/portfolio.rs"
      provides: "Donation summary display after portfolio output"
      contains: "get_donation_summary"
  key_links:
    - from: "capitoltraders_cli/src/commands/trades.rs"
      to: "capitoltraders_lib::Db::get_donor_context_for_sector"
      via: "method call after trade output"
      pattern: "get_donor_context_for_sector"
    - from: "capitoltraders_cli/src/commands/portfolio.rs"
      to: "capitoltraders_lib::Db::get_donation_summary"
      via: "method call after portfolio output"
      pattern: "get_donation_summary"
---

<objective>
Add --show-donor-context flag to trades command and optional donation summary to portfolio command.

Purpose: This is the user-facing correlation feature -- the whole point of Phase 12. When a user views trades, they can optionally see which employers in the traded security's sector donated to the politician. When viewing a portfolio, they see a donation summary. Both are opt-in and gracefully handle missing data.

Output: Updated trades.rs and portfolio.rs with donation context features.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-employer-correlation-analysis/12-RESEARCH.md
@.planning/phases/12-employer-correlation-analysis/12-02-SUMMARY.md
@capitoltraders_cli/src/commands/trades.rs
@capitoltraders_cli/src/commands/portfolio.rs
@capitoltraders_cli/src/main.rs
@capitoltraders_lib/src/db.rs (DonorContext, DonationSummary, get_donor_context_for_sector, get_donation_summary)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --show-donor-context flag to trades command</name>
  <files>
    capitoltraders_cli/src/commands/trades.rs
  </files>
  <action>
    1. Add a new flag to TradesArgs struct:
    ```rust
    /// Show donation context for traded securities (requires synced donations and employer mappings)
    #[arg(long)]
    pub show_donor_context: bool,
    ```

    2. In the `run_db` function, after the existing trade output (after the match on format block), add donor context logic:

    ```rust
    if args.show_donor_context {
        // Collect unique (politician_id, sector) pairs from displayed trades
        // to avoid duplicate context blocks
        let mut seen_contexts: std::collections::HashSet<(String, String)> = std::collections::HashSet::new();

        for trade in &rows {
            // DbTradeRow does not have politician_id directly -- it has politician_name.
            // We need politician_id for the DB query. Check if DbTradeRow has it.
            // If not, we need to look it up or add it to DbTradeRow.
            // Looking at the struct: it does not have politician_id. We need to either:
            // (a) Add politician_id to DbTradeRow (modifying the query_trades SQL), or
            // (b) Use a separate lookup by politician_name.
            //
            // Option (a) is cleaner. Add politician_id to DbTradeRow and update the
            // query_trades SELECT to include t.politician_id.
            // But this plan says we only modify trades.rs. Let me check if this is needed.
            //
            // Actually, since we also need the issuer's sector and DbTradeRow does not have
            // sector either, we need both. We could add a separate DB method
            // or accept that we need to touch db.rs (which is Plan 02's territory).
            //
            // DECISION: This plan will add politician_id and issuer_sector to DbTradeRow
            // in db.rs (small schema read change, not a new table). This is a minor addition
            // to Plan 02's work. If Plan 02 already ran, this is safe to modify since
            // we are only adding fields to the SELECT, not changing the table.
        }
    }
    ```

    Actually, let me re-plan this more carefully. We need politician_id and sector on DbTradeRow. Let me add them.

    Steps:
    a. In db.rs, add `pub politician_id: String` and `pub issuer_sector: Option<String>` fields to DbTradeRow.
    b. Update the query_trades SQL to SELECT t.politician_id and i.sector (i is already JOINed for issuer_name).
    c. Update the row mapping closure to read politician_id and issuer_sector.

    Then in trades.rs run_db, after the format output block:

    ```rust
    if args.show_donor_context {
        let mut seen: HashSet<(String, String)> = HashSet::new();
        let mut any_context = false;

        for trade in &rows {
            if let Some(ref sector) = trade.issuer_sector {
                let key = (trade.politician_id.clone(), sector.clone());
                if seen.contains(&key) {
                    continue;
                }
                seen.insert(key);

                let context = db.get_donor_context_for_sector(
                    &trade.politician_id,
                    sector,
                    5,  // top 5 employers
                )?;

                if !context.is_empty() {
                    if !any_context {
                        eprintln!("\n--- Donor Context ---");
                        any_context = true;
                    }
                    eprintln!(
                        "\n{} - {} sector:",
                        trade.politician_name, sector
                    );
                    for dc in &context {
                        eprintln!(
                            "  {:40} ${:>12.0} ({} donations)",
                            dc.employer, dc.total_amount, dc.donation_count
                        );
                    }
                }
            }
        }

        if !any_context && !rows.is_empty() {
            eprintln!("\nNo donor context available. Run 'map-employers load-seed' or 'map-employers export/import' to build employer mappings.");
        }
    }
    ```

    3. The --show-donor-context flag is ONLY available in DB mode. In scrape mode (run function), ignore the flag silently (or add it to the unsupported list with a note). Best approach: if show_donor_context is true and args.db is None, print a note: "Note: --show-donor-context requires --db mode." and continue without it.

    Actually, the scrape mode `run` function does not have access to db. The main.rs dispatches to either run or run_db based on args.db presence. So we handle it in the run function: if args.show_donor_context is set, print the note and continue.

    4. Add `use std::collections::HashSet;` at the top of trades.rs.
    5. Add `use capitoltraders_lib::Db;` if not already imported (it is, via the existing imports).
  </action>
  <verify>
    `cargo check --workspace` -- compiles.
    `cargo clippy --workspace` -- no warnings.
    `cargo run -p capitoltraders_cli -- trades --help` -- shows --show-donor-context flag.
    Existing trades tests still pass: `cargo test --workspace`.
  </verify>
  <done>
    --show-donor-context flag added to trades command. DB mode displays top 5 employers in each traded sector. Gracefully handles no-data case. Scrape mode shows informative note. politician_id and issuer_sector added to DbTradeRow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add optional donation summary to portfolio output</name>
  <files>
    capitoltraders_cli/src/commands/portfolio.rs
  </files>
  <action>
    1. Add a new flag to PortfolioArgs:
    ```rust
    /// Show donation summary for the politician (requires synced donations)
    #[arg(long)]
    pub show_donations: bool,
    ```

    2. In the `run` function, after the existing format output block (after the option_count note), add donation summary logic:

    ```rust
    // Donation summary (opt-in or auto-detect when politician filter active)
    if args.show_donations {
        if let Some(ref pid) = filter.politician_id {
            match db.get_donation_summary(pid) {
                Ok(Some(summary)) => {
                    eprintln!("\n--- Donation Summary ---");
                    eprintln!(
                        "Total received: ${:.0} ({} contributions)",
                        summary.total_amount, summary.donation_count
                    );
                    if !summary.top_sectors.is_empty() {
                        eprintln!("Top employer sectors (matched):");
                        for st in &summary.top_sectors {
                            eprintln!(
                                "  {:30} ${:>12.0} ({} employers)",
                                st.sector, st.total_amount, st.employer_count
                            );
                        }
                    }
                }
                Ok(None) => {
                    eprintln!("\nNo donation data available for this politician.");
                    eprintln!("Hint: Run 'capitoltraders sync-donations --db {} --politician ...' first.", args.db.display());
                }
                Err(e) => {
                    // Non-fatal: log warning but don't fail the portfolio command
                    eprintln!("\nWarning: Could not load donation summary: {}", e);
                }
            }
        } else {
            eprintln!("\nNote: --show-donations requires --politician filter to display donation summary.");
        }
    }
    ```

    3. Import DonationSummary is not needed since we only call db methods and match on the result. But ensure capitoltraders_lib::Db is imported (already is).

    Key design decisions:
    - --show-donations is explicit opt-in (not auto-detect) to keep behavior predictable
    - Requires --politician filter because donation summary is per-politician
    - Errors are non-fatal (eprintln warning) so portfolio output is never broken by donation data issues
    - Output goes to stderr (eprintln) so it does not interfere with piped stdout (JSON/CSV output)
  </action>
  <verify>
    `cargo check --workspace` -- compiles.
    `cargo clippy --workspace` -- no warnings.
    `cargo run -p capitoltraders_cli -- portfolio --help` -- shows --show-donations flag.
    Existing portfolio functionality unaffected: `cargo test --workspace`.
  </verify>
  <done>
    --show-donations flag added to portfolio command. When used with --politician, displays total donations received and top employer sectors. Gracefully handles missing data. Non-fatal errors. Output on stderr to preserve stdout for data formats.
  </done>
</task>

</tasks>

<verification>
- `cargo test --workspace` -- all tests pass
- `cargo clippy --workspace` -- no warnings
- trades --help shows --show-donor-context
- portfolio --help shows --show-donations
- Existing trades/portfolio commands work identically without new flags
- New flags produce helpful messages when data is missing
</verification>

<success_criteria>
- --show-donor-context on trades displays top employers per (politician, sector) pair
- --show-donations on portfolio displays donation summary when --politician is active
- Both features no-op gracefully when no donation/mapping data exists
- Output on stderr preserves stdout for data format piping
- No changes to existing command behavior when new flags are not used
</success_criteria>

<output>
After completion, create `.planning/phases/12-employer-correlation-analysis/12-04-SUMMARY.md`
</output>
