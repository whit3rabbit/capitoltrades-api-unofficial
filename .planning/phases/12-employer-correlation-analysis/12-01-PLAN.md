---
phase: 12-employer-correlation-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - capitoltraders_lib/Cargo.toml
  - capitoltraders_lib/src/employer_mapping.rs
  - capitoltraders_lib/src/lib.rs
  - seed_data/employer_issuers.toml
autonomous: true

must_haves:
  truths:
    - "Employer names are normalized consistently (lowercase, suffix stripped, whitespace collapsed)"
    - "Exact matches produce confidence 1.0"
    - "Fuzzy matches produce confidence between 0.85 and 0.99"
    - "Non-corporate employers (Retired, Self-employed, etc.) are blacklisted and skipped"
    - "Short employer names (< 5 chars after normalization) require exact match only"
    - "Seed data covers top employers with known ticker mappings"
  artifacts:
    - path: "capitoltraders_lib/src/employer_mapping.rs"
      provides: "Normalization, fuzzy matching, confidence scoring, seed data loading"
      exports: ["normalize_employer", "match_employer", "load_seed_data", "MatchResult", "MatchType", "SeedMapping", "is_blacklisted"]
    - path: "seed_data/employer_issuers.toml"
      provides: "Pre-populated employer-to-issuer mappings for common employers"
      contains: "[[mapping]]"
  key_links:
    - from: "capitoltraders_lib/src/employer_mapping.rs"
      to: "strsim::jaro_winkler"
      via: "fuzzy matching function call"
      pattern: "jaro_winkler"
    - from: "capitoltraders_lib/src/employer_mapping.rs"
      to: "seed_data/employer_issuers.toml"
      via: "include_str! at compile time"
      pattern: "include_str!"
---

<objective>
Create the employer mapping module with normalization, fuzzy matching, and seed data.

Purpose: Provides the core matching logic that Plan 02 (DB layer) and Plan 03 (CLI) depend on. Pure logic module with no DB or CLI dependencies -- fully testable in isolation.

Output: employer_mapping.rs with normalization/matching functions, seed TOML file, and strsim/toml dependencies added.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-employer-correlation-analysis/12-RESEARCH.md
@capitoltraders_lib/Cargo.toml
@capitoltraders_lib/src/lib.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add strsim and toml dependencies, create employer_mapping.rs with normalization and matching</name>
  <files>
    Cargo.toml
    capitoltraders_lib/Cargo.toml
    capitoltraders_lib/src/employer_mapping.rs
    capitoltraders_lib/src/lib.rs
  </files>
  <action>
    1. Add `strsim = "0.11"` and `toml = "0.8"` to capitoltraders_lib/Cargo.toml [dependencies].

    2. Create `capitoltraders_lib/src/employer_mapping.rs` with:

    Types:
    - `MatchType` enum: Exact, Fuzzy, Manual (derive Serialize, Deserialize, Debug, Clone, Copy, PartialEq)
    - `MatchResult` struct: issuer_id (i64), issuer_name (String), issuer_ticker (String), confidence (f64), match_type (MatchType)
    - `SeedMapping` struct (Deserialize): employer_names (Vec<String>), issuer_ticker (String), sector (String), confidence (f64), notes (Option<String>)
    - `SeedFile` struct (Deserialize): mapping (Vec<SeedMapping>)
    - `EmployerMappingError` enum via thiserror: TomlParse(String), InvalidSeedData(String)

    Blacklist constant:
    - `EMPLOYER_BLACKLIST: &[&str]` = ["self-employed", "self employed", "retired", "not employed", "n/a", "none", "homemaker", "student", "unemployed", "information requested", "information requested per best efforts"]
    - `fn is_blacklisted(employer: &str) -> bool` -- normalize then check if starts_with or equals any blacklist entry

    Corporate suffix list constant:
    - `CORPORATE_SUFFIXES: &[&str]` = ["corporation", "incorporated", "inc", "llc", "l.l.c.", "l.p.", "corp", "ltd", "limited", "co", "company", "group", "holdings", "partners", "partnership", "associates", "gmbh", "ag", "s.a.", "plc", "n.v."]
    - Sort by length descending so longer suffixes match before shorter ones (e.g., "corporation" before "corp")

    Functions:
    - `pub fn normalize_employer(raw: &str) -> String`: trim, lowercase, strip ONE trailing suffix from CORPORATE_SUFFIXES (strip trailing dots/commas/spaces after removal), collapse whitespace. Return empty string for empty input.
    - `pub fn match_employer(employer: &str, issuers: &[(i64, String, String)]) -> Option<MatchResult>`: where issuers tuple is (issuer_id, issuer_name, issuer_ticker). First check is_blacklisted (return None). Normalize employer. Tier 1: exact match against normalized issuer_name (confidence 1.0, MatchType::Exact). Tier 2: if normalized employer length >= 5, fuzzy match via strsim::jaro_winkler against all normalized issuer_names, take best match >= 0.85 threshold (MatchType::Fuzzy). Return None if no match found.
    - `pub fn load_seed_data() -> Result<Vec<SeedMapping>, EmployerMappingError>`: use include_str!("../../seed_data/employer_issuers.toml") to load at compile time. Parse via toml::from_str into SeedFile. Return the mapping vec.

    3. Add `pub mod employer_mapping;` to lib.rs. Add re-exports to lib.rs: `pub use employer_mapping::{normalize_employer, match_employer, load_seed_data, is_blacklisted, MatchResult, MatchType, SeedMapping, EmployerMappingError};`

    4. Add unit tests module in employer_mapping.rs with #[cfg(test)] mod tests:
    - test_normalize_basic: "Apple Inc" -> "apple"
    - test_normalize_llc: "Google LLC" -> "google"
    - test_normalize_corporation: "Microsoft Corporation" -> "microsoft"
    - test_normalize_preserves_spaces: "Goldman Sachs Group" -> "goldman sachs" (strip "group" as it is in suffixes? Actually "group" IS in the suffix list, so "Goldman Sachs Group" -> strip "group" -> "goldman sachs". Good.)
    - test_normalize_empty: "" -> ""
    - test_normalize_whitespace_collapse: "  Apple   Inc  " -> "apple"
    - test_normalize_international: "Siemens AG" -> "siemens"
    - test_blacklisted_retired: is_blacklisted("Retired") == true
    - test_blacklisted_self_employed: is_blacklisted("SELF-EMPLOYED") == true
    - test_blacklisted_normal: is_blacklisted("Apple Inc") == false
    - test_blacklisted_na: is_blacklisted("N/A") == true
    - test_match_exact: "Apple" matches issuer "Apple" at 1.0
    - test_match_fuzzy: "Apple Computer" matches issuer "Apple" with score >= 0.85 (Jaro-Winkler on "apple computer" vs "apple")
    - test_match_blacklisted_returns_none: "Retired" returns None
    - test_match_short_name_no_fuzzy: "IBM" (3 chars) does not fuzzy match "IBMC Corp" -- only exact match allowed for < 5 chars
    - test_match_no_match: "Random Xyz Company" returns None against unrelated issuers
    - test_load_seed_data: load_seed_data() returns non-empty vec (validates TOML compiles)
  </action>
  <verify>
    `cargo test -p capitoltraders_lib employer_mapping -- --nocapture` -- all 17 tests pass.
    `cargo clippy --workspace` -- no new warnings.
  </verify>
  <done>
    employer_mapping.rs exists with normalize_employer, match_employer, load_seed_data, is_blacklisted functions. 17 unit tests pass. strsim and toml dependencies compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create seed data TOML with top employer-to-issuer mappings</name>
  <files>
    seed_data/employer_issuers.toml
  </files>
  <action>
    Create `seed_data/employer_issuers.toml` with the top ~50 employers commonly found in FEC donation data mapped to S&P 500 issuers. Quality over quantity -- only include mappings with high certainty.

    File structure:
    ```toml
    # Employer-to-Issuer Seed Mappings
    # These are manually curated, high-confidence mappings for common FEC employers.
    # Format: employer_names (variants) -> issuer_ticker + sector
    # Confidence is always 1.0 for seed data (manually verified).
    # Last updated: 2026-02-13

    [[mapping]]
    employer_names = ["Apple Inc", "Apple Computer Inc", "Apple"]
    issuer_ticker = "AAPL"
    sector = "Information Technology"
    confidence = 1.0
    notes = "Multiple historical names"
    ```

    Include at minimum these categories (with employer name variants for each):
    - Big Tech: Apple, Alphabet/Google, Microsoft, Amazon, Meta/Facebook, Netflix, Nvidia, Intel, AMD, Salesforce, Oracle, Adobe, Cisco
    - Finance: Goldman Sachs, JPMorgan/JP Morgan, Morgan Stanley, Bank of America/BofA, Citigroup/Citi, Wells Fargo, BlackRock, Charles Schwab, Fidelity Investments
    - Healthcare: Johnson & Johnson, Pfizer, UnitedHealth/United Health, Merck, Abbott/Abbott Laboratories, Eli Lilly
    - Energy: ExxonMobil/Exxon Mobil, Chevron, ConocoPhillips
    - Defense: Lockheed Martin, Raytheon/RTX, Boeing, Northrop Grumman, General Dynamics
    - Consumer: Walmart, Procter & Gamble/P&G, Coca-Cola, PepsiCo, McDonald's
    - Telecom: AT&T, Verizon, Comcast, T-Mobile

    Each mapping should list 2-4 common employer name variants found in FEC data. The issuer_ticker should be the actual ticker symbol. Do NOT include issuer_id (the DB lookup will match by ticker).

    Note: Remove issuer_id from the SeedMapping struct if it was included in Task 1. Seed data should use issuer_ticker as the join key since issuer_id is database-specific and varies per user's synced data. Update Task 1's SeedMapping struct accordingly if needed.
  </action>
  <verify>
    `cargo test -p capitoltraders_lib employer_mapping::tests::test_load_seed_data` passes (proves TOML is valid and parseable).
    File contains at least 40 [[mapping]] entries.
  </verify>
  <done>
    seed_data/employer_issuers.toml exists with 40+ curated employer-to-issuer mappings. TOML parses without error. Each mapping has employer_names variants, issuer_ticker, sector, and confidence 1.0.
  </done>
</task>

</tasks>

<verification>
- `cargo test -p capitoltraders_lib employer_mapping` -- all tests pass
- `cargo clippy --workspace` -- no warnings
- `cargo check --workspace` -- compiles cleanly
- normalize_employer handles edge cases: empty input, international suffixes, whitespace
- match_employer respects blacklist, short-name restriction, and 0.85 threshold
- Seed TOML loads at compile time via include_str!
</verification>

<success_criteria>
- employer_mapping.rs has normalize_employer, match_employer, load_seed_data, is_blacklisted
- 17+ unit tests pass covering normalization, blacklisting, exact match, fuzzy match, short names
- strsim and toml dependencies added to capitoltraders_lib
- Seed TOML has 40+ manually curated employer-to-issuer mappings
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/12-employer-correlation-analysis/12-01-SUMMARY.md`
</output>
