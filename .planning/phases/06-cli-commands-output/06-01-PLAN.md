---
phase: 06-cli-commands-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - capitoltraders_cli/src/output.rs
  - capitoltraders_cli/src/output_tests.rs
  - capitoltraders_cli/src/xml_output.rs
  - capitoltraders_cli/src/commands/portfolio.rs
  - capitoltraders_cli/src/commands/mod.rs
  - capitoltraders_cli/src/main.rs
autonomous: true

must_haves:
  truths:
    - "capitoltraders portfolio --db <path> shows positions with P&L columns"
    - "portfolio command filters by --politician, --party, --state, --ticker"
    - "portfolio output includes ticker, shares_held, avg_cost_basis, current_price, current_value, unrealized_pnl, unrealized_pnl_pct columns"
    - "Option positions display note when option trades exist"
    - "All 5 output formats (table, JSON, CSV, markdown, XML) work for portfolio"
    - "enrich-prices command already exists and meets success criteria 1 and 7"
  artifacts:
    - path: "capitoltraders_cli/src/commands/portfolio.rs"
      provides: "Portfolio CLI command with PortfolioArgs and run function"
      min_lines: 40
    - path: "capitoltraders_cli/src/output.rs"
      provides: "Portfolio output formatting (PortfolioRow, 5 print functions)"
      contains: "print_portfolio_table"
    - path: "capitoltraders_cli/src/xml_output.rs"
      provides: "XML serialization for portfolio positions"
      contains: "portfolio_to_xml"
    - path: "capitoltraders_cli/src/main.rs"
      provides: "Portfolio variant in Commands enum and dispatch"
      contains: "Commands::Portfolio"
  key_links:
    - from: "capitoltraders_cli/src/commands/portfolio.rs"
      to: "capitoltraders_lib::Db::get_portfolio"
      via: "db.get_portfolio(&filter)"
      pattern: "get_portfolio"
    - from: "capitoltraders_cli/src/commands/portfolio.rs"
      to: "capitoltraders_cli/src/output.rs"
      via: "format dispatch match on OutputFormat"
      pattern: "print_portfolio_table|print_portfolio_csv|print_portfolio_markdown|print_portfolio_xml|print_json"
    - from: "capitoltraders_cli/src/main.rs"
      to: "capitoltraders_cli/src/commands/portfolio.rs"
      via: "Commands::Portfolio dispatch"
      pattern: "Commands::Portfolio"
---

<objective>
Add the `portfolio` CLI subcommand with full output formatting support. The enrich-prices command already exists from Phase 4, so this plan focuses exclusively on the portfolio command that displays per-politician stock positions with unrealized P&L.

Purpose: Complete the final user-facing feature -- users can see what their politicians' positions are currently worth and whether they are making or losing money.

Output: Working `capitoltraders portfolio --db <path>` command with table, JSON, CSV, markdown, and XML output.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-portfolio-calculator-fifo/05-02-SUMMARY.md
@.planning/phases/06-cli-commands-output/06-RESEARCH.md
@capitoltraders_cli/src/main.rs
@capitoltraders_cli/src/output.rs
@capitoltraders_cli/src/xml_output.rs
@capitoltraders_cli/src/commands/mod.rs
@capitoltraders_cli/src/commands/issuers.rs
@capitoltraders_lib/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Portfolio output formatting and XML serialization</name>
  <files>
    capitoltraders_cli/src/output.rs
    capitoltraders_cli/src/output_tests.rs
    capitoltraders_cli/src/xml_output.rs
  </files>
  <action>
Add portfolio output formatting to output.rs, following the exact patterns used for DB issuers (DbIssuerOutputRow / build_db_issuer_rows / print_db_issuers_*).

**In output.rs:**

1. Add import: `use capitoltraders_lib::PortfolioPosition;`

2. Create `PortfolioRow` struct with `#[derive(Tabled, Serialize)]`:
   - `politician_id: String` (rename "Politician")
   - `ticker: String` (rename "Ticker")
   - `shares_held: String` (rename "Shares")
   - `avg_cost_basis: String` (rename "Avg Cost")
   - `current_price: String` (rename "Current Price")
   - `current_value: String` (rename "Current Value")
   - `unrealized_pnl: String` (rename "Unrealized P&L")
   - `unrealized_pnl_pct: String` (rename "P&L %")

3. Create `format_shares(shares: f64) -> String` helper: `format!("{:.2}", shares)`

4. Create `format_currency(value: f64) -> String` helper: `format!("${:.2}", value)`

5. Create `build_portfolio_rows(positions: &[PortfolioPosition]) -> Vec<PortfolioRow>`:
   - Map each position to PortfolioRow
   - politician_id: clone directly
   - ticker: clone directly
   - shares_held: format_shares(p.shares_held)
   - avg_cost_basis: format_currency(p.cost_basis)
   - current_price: `p.current_price.map(format_currency).unwrap_or_else(|| "-".to_string())`
   - current_value: `p.current_value.map(|v| format!("${:,.2}", v)).unwrap_or_else(|| "-".to_string())`
   - unrealized_pnl: map with +/- prefix: `if pnl >= 0.0 { format!("+${:,.2}", pnl) } else { format!("-${:,.2}", pnl.abs()) }`, unwrap_or "-"
   - unrealized_pnl_pct: `p.unrealized_pnl_pct.map(format_percent).unwrap_or_else(|| "-".to_string())`

   Note: format_percent already exists in output.rs (line 478). It takes f64 and multiplies by 100. But PortfolioPosition.unrealized_pnl_pct is ALREADY a percentage (computed as `((price - cost_basis) / cost_basis) * 100.0` in db.rs line 1919). So do NOT use format_percent directly. Instead use a local formatting: `if pct >= 0.0 { format!("+{:.1}%", pct) } else { format!("{:.1}%", pct) }`.

6. Create 5 public print functions following existing patterns:
   - `print_portfolio_table(positions: &[PortfolioPosition])` -- println Table::new
   - `print_portfolio_markdown(positions: &[PortfolioPosition])` -- Table with Style::markdown()
   - `print_portfolio_csv(positions: &[PortfolioPosition]) -> Result<()>` -- csv::Writer with sanitize_csv_field on politician_id and ticker
   - `print_portfolio_xml(positions: &[PortfolioPosition])` -- println xml_output::portfolio_to_xml
   - Note: print_json already works generically for any Serialize type (PortfolioPosition derives Serialize)

**In xml_output.rs:**

1. Add import: `use capitoltraders_lib::PortfolioPosition;`

2. Add function:
   ```rust
   pub fn portfolio_to_xml(positions: &[PortfolioPosition]) -> String {
       items_to_xml("portfolio", "position", positions)
   }
   ```

**In output_tests.rs:**

Add tests at the end of the file:

1. `test_format_shares`: verify format_shares(100.5) == "100.50"
2. `test_format_currency`: verify format_currency(50.0) == "$50.00"
3. `test_build_portfolio_rows_with_pnl`: Create a PortfolioPosition with known values (current_price=Some(75.0), cost_basis=50.0, shares_held=100.0, unrealized_pnl=Some(2500.0), unrealized_pnl_pct=Some(50.0), current_value=Some(7500.0)). Verify row fields: shares="100.00", avg_cost_basis="$50.00", current_price="$75.00", unrealized_pnl contains "+$2,500.00", unrealized_pnl_pct contains "+50.0%"
4. `test_build_portfolio_rows_missing_price`: Create PortfolioPosition with current_price=None, unrealized_pnl=None, unrealized_pnl_pct=None, current_value=None. Verify all those fields show "-".
5. `test_portfolio_csv_sanitization`: Create PortfolioPosition with ticker="=SUM(A1)". Verify print_portfolio_csv does not panic (write to Vec instead of stdout if needed, or just test that build_portfolio_rows produces the row and sanitize_csv_field("=SUM(A1)") starts with tab).
  </action>
  <verify>
Run `cargo test -p capitoltraders_cli output_tests` and verify all new tests pass. Run `cargo check -p capitoltraders_cli` to confirm no compilation errors in the output module.
  </verify>
  <done>
PortfolioRow struct exists with all 8 columns. Five print_portfolio_* functions exist. portfolio_to_xml function exists in xml_output.rs. At least 4 new output tests pass covering formatting, None handling, and CSV sanitization.
  </done>
</task>

<task type="auto">
  <name>Task 2: Portfolio command module and CLI wiring</name>
  <files>
    capitoltraders_cli/src/commands/portfolio.rs
    capitoltraders_cli/src/commands/mod.rs
    capitoltraders_cli/src/main.rs
  </files>
  <action>
Create the portfolio command module and wire it into the CLI, following the exact pattern of the issuers command (DB-only path).

**Create capitoltraders_cli/src/commands/portfolio.rs:**

```rust
//! The `portfolio` subcommand: displays per-politician stock positions with P&L.

use anyhow::Result;
use capitoltraders_lib::{validation, Db, PortfolioFilter};
use clap::Args;
use std::path::PathBuf;

use crate::output::{
    print_json, print_portfolio_csv, print_portfolio_markdown, print_portfolio_table,
    print_portfolio_xml, OutputFormat,
};

/// Arguments for the `portfolio` subcommand.
///
/// Displays stock positions with unrealized P&L from the local SQLite database.
/// Requires a synced and price-enriched database.
#[derive(Args)]
pub struct PortfolioArgs {
    /// SQLite database path (required)
    #[arg(long)]
    pub db: PathBuf,

    /// Filter by politician ID (e.g., P000001)
    #[arg(long)]
    pub politician: Option<String>,

    /// Filter by party: democrat (d), republican (r)
    #[arg(long)]
    pub party: Option<String>,

    /// Filter by state (e.g., CA, TX)
    #[arg(long)]
    pub state: Option<String>,

    /// Filter by ticker symbol (e.g., AAPL)
    #[arg(long)]
    pub ticker: Option<String>,

    /// Include closed positions (shares near zero)
    #[arg(long)]
    pub include_closed: bool,
}
```

Implement the `run` function:

```rust
pub fn run(args: &PortfolioArgs, format: &OutputFormat) -> Result<()> {
    let db = Db::open(&args.db)?;

    // Validate filters
    let party = match args.party {
        Some(ref val) => Some(validation::validate_party(val.trim())?.to_string()),
        None => None,
    };

    let state = match args.state {
        Some(ref val) => Some(validation::validate_state(val.trim())?.to_string()),
        None => None,
    };

    let politician_id = match args.politician {
        Some(ref val) => Some(validation::validate_politician_id(val.trim())?.to_string()),
        None => None,
    };

    let ticker = args.ticker.as_ref().map(|t| t.trim().to_uppercase());

    let filter = PortfolioFilter {
        politician_id,
        ticker,
        party,
        state,
        include_closed: args.include_closed,
    };

    let positions = db.get_portfolio(&filter)?;

    if positions.is_empty() {
        eprintln!("No portfolio positions found matching the given filters.");
        eprintln!("Hint: Run 'capitoltraders sync' then 'capitoltraders enrich-prices' first.");
        return Ok(());
    }

    // Count option trades for the note
    let option_count = db.count_option_trades(filter.politician_id.as_deref())?;

    match format {
        OutputFormat::Table => {
            print_portfolio_table(&positions);
            if option_count > 0 {
                eprintln!(
                    "\nNote: {} option trade(s) excluded (valuation deferred)",
                    option_count
                );
            }
        }
        OutputFormat::Json => print_json(&positions),
        OutputFormat::Csv => print_portfolio_csv(&positions)?,
        OutputFormat::Markdown => {
            print_portfolio_markdown(&positions);
            if option_count > 0 {
                eprintln!(
                    "\nNote: {} option trade(s) excluded (valuation deferred)",
                    option_count
                );
            }
        }
        OutputFormat::Xml => print_portfolio_xml(&positions),
    }

    Ok(())
}
```

Important details:
- This is NOT async (no network calls needed, DB-only). Use `fn run` not `async fn run`.
- Option note only shown for table and markdown (human-readable formats), not JSON/CSV/XML (pure data formats). This matches the research recommendation in open question #2.
- validate_party returns a Party enum, call .to_string() to get the display string matching what the DB stores (e.g. "Democrat").
- validate_state returns uppercase 2-letter code.
- validate_politician_id returns the validated ID string.

**Update capitoltraders_cli/src/commands/mod.rs:**

Add `pub mod portfolio;` to the module list.

**Update capitoltraders_cli/src/main.rs:**

1. Add variant to Commands enum:
   ```rust
   /// View portfolio positions with P&L
   Portfolio(commands::portfolio::PortfolioArgs),
   ```

2. Add dispatch in the match block (after EnrichPrices):
   ```rust
   Commands::Portfolio(args) => commands::portfolio::run(&args, &format)?,
   ```
   Note: no `.await` since run is not async.

3. Update the module doc comment to mention the portfolio subcommand (change "four subcommands" to "six subcommands" and add `portfolio` to the list).
  </action>
  <verify>
Run `cargo check --workspace` to verify compilation. Run `cargo clippy --workspace` for lint check. Run `cargo test --workspace` to verify all existing + new tests pass. Run `cargo run -p capitoltraders_cli -- portfolio --help` to verify the help text shows --db, --politician, --party, --state, --ticker, --include-closed flags.
  </verify>
  <done>
`capitoltraders portfolio --help` shows all expected flags with descriptions. `capitoltraders portfolio --db test.db` runs without panic (may show "No portfolio positions" if DB is empty/non-enriched). Commands enum has 6 variants. All workspace tests pass. No clippy warnings.
  </done>
</task>

</tasks>

<verification>
1. `cargo test --workspace` -- all tests pass (existing + new output tests)
2. `cargo clippy --workspace` -- no warnings
3. `cargo run -p capitoltraders_cli -- portfolio --help` -- shows expected flags and descriptions
4. `cargo run -p capitoltraders_cli -- enrich-prices --help` -- still works (regression check)
5. Verify PortfolioRow has 8 columns matching success criteria 4
6. Verify option note displays for table/markdown output
7. Verify all 5 output formats have corresponding print functions
</verification>

<success_criteria>
- portfolio subcommand compiles and shows correct --help
- All 5 output formats (table, JSON, CSV, markdown, XML) have print functions
- PortfolioRow includes: politician_id, ticker, shares_held, avg_cost_basis, current_price, current_value, unrealized_pnl, unrealized_pnl_pct
- Option trades note appears in table/markdown output when count > 0
- Filter validation uses validation module functions (not raw string ops)
- All workspace tests pass including new output formatting tests
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-commands-output/06-01-SUMMARY.md`
</output>
