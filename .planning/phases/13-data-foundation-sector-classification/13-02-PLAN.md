---
phase: 13-data-foundation-sector-classification
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - capitoltraders_lib/src/sector_mapping.rs
  - capitoltraders_lib/src/lib.rs
  - capitoltraders_lib/src/db.rs
  - seed_data/gics_sector_mapping.yml
  - schema/sqlite.sql
autonomous: true

must_haves:
  truths:
    - "User can map top 200 traded tickers to GICS sectors via static YAML classification"
    - "All YAML sector names are validated against the 11 official GICS sectors"
    - "Invalid sector names in YAML cause a clear error before any DB writes"
    - "Issuers table gics_sector column is updated for tickers present in the YAML"
  artifacts:
    - path: "capitoltraders_lib/src/sector_mapping.rs"
      provides: "GICS_SECTORS constant, SectorMapping types, parse and validate functions"
      exports: ["GICS_SECTORS", "SectorMappingFile", "SectorMapping", "SectorMappingError", "parse_sector_mappings", "validate_sector", "load_sector_mappings"]
    - path: "seed_data/gics_sector_mapping.yml"
      provides: "Static YAML file with 200 ticker-to-sector mappings"
      min_lines: 400
    - path: "capitoltraders_lib/src/db.rs"
      provides: "update_issuer_sectors DB operation"
      contains: "fn update_issuer_sectors"
    - path: "capitoltraders_lib/src/lib.rs"
      provides: "pub mod sector_mapping re-export"
      contains: "pub mod sector_mapping"
  key_links:
    - from: "capitoltraders_lib/src/sector_mapping.rs"
      to: "seed_data/gics_sector_mapping.yml"
      via: "include_str! at compile time"
      pattern: "include_str!"
    - from: "capitoltraders_lib/src/sector_mapping.rs"
      to: "capitoltraders_lib/src/db.rs"
      via: "SectorMapping type used by update_issuer_sectors"
      pattern: "SectorMapping"
    - from: "capitoltraders_lib/src/lib.rs"
      to: "capitoltraders_lib/src/sector_mapping.rs"
      via: "pub mod declaration and pub use re-exports"
      pattern: "pub mod sector_mapping"
---

<objective>
Create the GICS sector mapping module with static YAML classification data and DB update operations.

Purpose: Enables mapping the top 200 most-traded tickers to their GICS sectors, which is required for Phase 15 sector-relative performance scoring and Phase 16 committee-sector conflict detection. The YAML file is version-controlled and auditable, following the same compile-time inclusion pattern as employer_issuers.toml.

Output: New sector_mapping.rs module, gics_sector_mapping.yml data file, update_issuer_sectors DB method, and comprehensive tests.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-data-foundation-sector-classification/13-RESEARCH.md
@.planning/phases/13-data-foundation-sector-classification/13-01-SUMMARY.md
@capitoltraders_lib/src/lib.rs
@capitoltraders_lib/src/fec_mapping.rs
@capitoltraders_lib/src/employer_mapping.rs
@capitoltraders_lib/src/db.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sector mapping module and YAML data file</name>
  <files>capitoltraders_lib/src/sector_mapping.rs, capitoltraders_lib/src/lib.rs, seed_data/gics_sector_mapping.yml, capitoltraders_lib/src/db.rs</files>
  <action>
1. Create `capitoltraders_lib/src/sector_mapping.rs` following the pattern from `fec_mapping.rs` and `employer_mapping.rs`:

   - Define error type:
     ```rust
     #[derive(Error, Debug)]
     pub enum SectorMappingError {
         #[error("Invalid GICS sector: {0}")]
         InvalidSector(String),
         #[error("Failed to parse sector mapping YAML: {0}")]
         YamlParse(#[from] serde_yml::Error),
         #[error("Duplicate ticker in mapping: {0}")]
         DuplicateTicker(String),
     }
     ```

   - Define the 11 official GICS sectors as a const:
     ```rust
     pub const GICS_SECTORS: &[&str] = &[
         "Communication Services",
         "Consumer Discretionary",
         "Consumer Staples",
         "Energy",
         "Financials",
         "Health Care",
         "Industrials",
         "Information Technology",
         "Materials",
         "Real Estate",
         "Utilities",
     ];
     ```

   - Define types:
     ```rust
     #[derive(Deserialize, Debug)]
     pub struct SectorMappingFile {
         pub mappings: Vec<SectorMapping>,
     }

     #[derive(Deserialize, Debug, Clone)]
     pub struct SectorMapping {
         pub ticker: String,
         pub sector: String,
     }
     ```

   - Implement `validate_sector(sector: &str) -> Result<String, SectorMappingError>`:
     Case-insensitive comparison against GICS_SECTORS, returns the official capitalization.

   - Implement `parse_sector_mappings(yaml_content: &str) -> Result<Vec<SectorMapping>, SectorMappingError>`:
     Parse YAML, then validate every sector name, normalize sector to official capitalization, check for duplicate tickers (using HashSet). Return the validated mappings.

   - Implement `load_sector_mappings() -> Result<Vec<SectorMapping>, SectorMappingError>`:
     Use `include_str!("../../seed_data/gics_sector_mapping.yml")` to load at compile time. Call parse_sector_mappings on the content. This follows the exact pattern from employer_mapping.rs::load_seed_data().

   Imports needed: serde::Deserialize, thiserror::Error, std::collections::HashSet.

2. Create `seed_data/gics_sector_mapping.yml` with the top 200 most-traded tickers in Congress mapped to GICS sectors. Use the following structure:
   ```yaml
   mappings:
     - ticker: AAPL
       sector: Information Technology
     - ticker: MSFT
       sector: Information Technology
   ```

   Include at minimum these well-known congressional trading tickers organized by sector. The file should have approximately 200 entries. Here are the tickers to include (research confirmed these as top congressional trades):

   **Information Technology (~40 tickers):** AAPL, MSFT, NVDA, GOOG, GOOGL, META, AVGO, CRM, CSCO, ORCL, ACN, AMD, ADBE, TXN, INTC, QCOM, IBM, NOW, AMAT, INTU, MU, ADI, LRCX, KLAC, SNPS, CDNS, MRVL, FTNT, PANW, PLTR, CRWD, HPE, HPQ, DELL, ANET, NXPI, ON, MCHP, KEYS, IT

   **Financials (~25 tickers):** JPM, BAC, WFC, GS, MS, BLK, SCHW, C, AXP, USB, PNC, COF, CME, ICE, SPGI, MSCI, MCO, TFC, BK, AIG, MET, PRU, AFL, ALL, TRV

   **Health Care (~25 tickers):** UNH, JNJ, LLY, ABBV, MRK, PFE, TMO, ABT, DHR, AMGN, BMY, MDT, ISRG, GILD, VRTX, REGN, CI, ELV, HCA, ZTS, BSX, SYK, BDX, A, DXCM

   **Consumer Discretionary (~20 tickers):** AMZN, TSLA, HD, MCD, NKE, SBUX, LOW, TJX, BKNG, MAR, CMG, ABNB, ROST, DHI, LEN, GM, F, YUM, DPZ, APTV

   **Communication Services (~10 tickers):** DIS, NFLX, CMCSA, T, VZ, TMUS, CHTR, EA, TTWO, WBD

   **Energy (~15 tickers):** XOM, CVX, COP, EOG, SLB, MPC, PSX, VLO, OXY, PXD, DVN, HES, FANG, KMI, WMB

   **Industrials (~20 tickers):** HON, UNP, UPS, CAT, RTX, BA, DE, LMT, GE, GD, NOC, MMM, WM, RSG, EMR, ETN, ITW, FDX, CSX, NSC

   **Consumer Staples (~15 tickers):** PG, KO, PEP, COST, WMT, PM, MO, MDLZ, CL, KMB, EL, GIS, K, SJM, HSY

   **Materials (~10 tickers):** LIN, APD, SHW, ECL, FCX, NEM, NUE, DOW, DD, VMC

   **Utilities (~10 tickers):** NEE, SO, DUK, D, SRE, AEP, EXC, XEL, ES, WEC

   **Real Estate (~10 tickers):** AMT, PLD, CCI, EQIX, PSA, O, WELL, SPG, DLR, VICI

   That is ~200 tickers total. Ensure YAML syntax is valid (consistent indentation, no trailing commas).

3. In `capitoltraders_lib/src/db.rs`, add `update_issuer_sectors` method:
   ```rust
   pub fn update_issuer_sectors(&self, mappings: &[crate::sector_mapping::SectorMapping]) -> Result<usize, DbError> {
   ```
   - Use unchecked_transaction
   - Prepare: `UPDATE issuers SET gics_sector = ?1 WHERE issuer_ticker = ?2`
   - Loop over mappings, execute for each, accumulate rows affected
   - Commit transaction
   - Return total updated count
   - Use `crate::sector_mapping::SectorMapping` for the type (do NOT add a new import of SectorMapping to the top of db.rs -- use the fully qualified path in the function signature, or add a targeted use statement near the function).

4. In `capitoltraders_lib/src/lib.rs`:
   - Add `pub mod sector_mapping;` in the module list (alphabetical order, after `pub mod pricing;`)
   - Add re-exports: `pub use sector_mapping::{SectorMapping, SectorMappingError, GICS_SECTORS, load_sector_mappings, parse_sector_mappings, validate_sector};`
  </action>
  <verify>
    `cargo check -p capitoltraders_lib` compiles without errors.
    `cargo clippy -p capitoltraders_lib` passes with no warnings on new code.
  </verify>
  <done>
    - sector_mapping.rs exists with GICS_SECTORS, types, parse, validate, and load functions
    - gics_sector_mapping.yml exists with ~200 ticker-to-sector entries
    - load_sector_mappings() compiles and loads YAML at compile time
    - update_issuer_sectors accepts SectorMapping slice and updates issuers table
    - lib.rs re-exports sector_mapping module
  </done>
</task>

<task type="auto">
  <name>Task 2: Sector mapping and DB update tests</name>
  <files>capitoltraders_lib/src/sector_mapping.rs, capitoltraders_lib/src/db.rs</files>
  <action>
1. Add tests in `sector_mapping.rs` inside a `#[cfg(test)] mod tests` block:

   a. `test_gics_sectors_count` - GICS_SECTORS has exactly 11 entries.

   b. `test_validate_sector_exact` - validate_sector("Information Technology") returns Ok("Information Technology").

   c. `test_validate_sector_case_insensitive` - validate_sector("information technology") returns Ok("Information Technology").

   d. `test_validate_sector_invalid` - validate_sector("Tech") returns Err(SectorMappingError::InvalidSector).

   e. `test_parse_minimal_yaml` - Parse a small YAML string with 2 entries, verify count and values.

   f. `test_parse_invalid_sector_rejected` - Parse YAML with sector "FakeStuff", verify it returns Err.

   g. `test_parse_duplicate_ticker_rejected` - Parse YAML with "AAPL" appearing twice, verify Err(DuplicateTicker).

   h. `test_load_sector_mappings_succeeds` - Call load_sector_mappings(), verify Ok, verify count >= 190 (approximately 200), verify all sectors are in GICS_SECTORS.

   i. `test_load_sector_mappings_no_duplicates` - Call load_sector_mappings(), collect tickers into HashSet, verify set.len() == vec.len() (no duplicates).

2. Add tests in `db.rs` inside the existing `#[cfg(test)] mod tests` block:

   a. `test_update_issuer_sectors` - Create test DB with init(), insert 3 issuers (AAPL, MSFT, GOOG) manually, create SectorMapping entries for AAPL -> "Information Technology" and MSFT -> "Information Technology", call update_issuer_sectors, verify:
      - Returns Ok(2) (2 rows updated)
      - SELECT gics_sector FROM issuers WHERE issuer_ticker = 'AAPL' returns "Information Technology"
      - SELECT gics_sector FROM issuers WHERE issuer_ticker = 'GOOG' returns NULL (not in mappings)

   b. `test_update_issuer_sectors_no_match` - Create test DB, insert issuer with ticker "ZZZZ", call update_issuer_sectors with mapping for "AAPL", verify returns Ok(0).

   c. `test_update_issuer_sectors_idempotent` - Call update_issuer_sectors twice with same data, second call should succeed and return same count.

For the db.rs tests, use `crate::sector_mapping::SectorMapping` to construct test data (do not create a separate SectorMapping struct).
  </action>
  <verify>
    `cargo test -p capitoltraders_lib validate_sector` passes.
    `cargo test -p capitoltraders_lib parse_` passes (for parse tests).
    `cargo test -p capitoltraders_lib load_sector_mappings` passes.
    `cargo test -p capitoltraders_lib update_issuer_sectors` passes.
    `cargo test --workspace` passes (all existing tests + new tests).
  </verify>
  <done>
    - 9 sector_mapping unit tests pass (GICS constant, validation, parsing, loading)
    - 3 DB operation tests pass (update, no-match, idempotent)
    - YAML file validates successfully (all sectors valid, no duplicates)
    - All existing 520+ tests still pass (from Plan 01)
    - Total test count approximately 532+ (513 original + 7 from Plan 01 + 12 from Plan 02)
  </done>
</task>

</tasks>

<verification>
- `cargo test --workspace` passes with 530+ tests
- `cargo clippy --workspace` passes
- load_sector_mappings() returns ~200 validated mappings
- All YAML sectors match official GICS capitalization
- update_issuer_sectors correctly sets gics_sector on issuers table
- No duplicate tickers in YAML file
</verification>

<success_criteria>
- FOUND-01 fully satisfied (combined with Plan 01): schema v6 migration exists, is idempotent, adds benchmark and sector tables
- FOUND-04 satisfied: user can map issuers to GICS sectors via static YAML classification with validation
- FOUND-02 satisfied (from Plan 01): sector_benchmarks reference table queryable with 12 rows
- Phase 13 complete: all three requirements (FOUND-01, FOUND-02, FOUND-04) covered
</success_criteria>

<output>
After completion, create `.planning/phases/13-data-foundation-sector-classification/13-02-SUMMARY.md`
</output>
