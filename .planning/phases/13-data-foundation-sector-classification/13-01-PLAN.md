---
phase: 13-data-foundation-sector-classification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - capitoltraders_lib/src/db.rs
  - schema/sqlite.sql
autonomous: true

must_haves:
  truths:
    - "User can run schema v6 migration adding gics_sector column and sector_benchmarks table"
    - "User can query sector_benchmarks reference table showing 12 rows (SPY + 11 GICS sectors)"
    - "Schema migration is idempotent (running init() twice has no side effects)"
    - "Fresh database includes gics_sector column and sector_benchmarks table"
  artifacts:
    - path: "capitoltraders_lib/src/db.rs"
      provides: "migrate_v6, populate_sector_benchmarks, get_sector_benchmarks, get_top_traded_tickers"
      contains: "fn migrate_v6"
    - path: "schema/sqlite.sql"
      provides: "Base schema with gics_sector column and sector_benchmarks table"
      contains: "sector_benchmarks"
  key_links:
    - from: "capitoltraders_lib/src/db.rs"
      to: "schema/sqlite.sql"
      via: "include_str! for fresh DB creation"
      pattern: "include_str!"
    - from: "db.rs init()"
      to: "db.rs migrate_v6()"
      via: "version < 6 check in init()"
      pattern: "version < 6"
---

<objective>
Add schema v6 migration with GICS sector infrastructure and benchmark reference data.

Purpose: Establishes the data foundation for v1.3 analytics by adding sector classification columns and a reference table for S&P 500 plus 11 GICS sector ETF benchmarks. This enables Phase 14 (benchmark price enrichment) and Phase 15 (sector-relative performance scoring).

Output: Updated db.rs with migrate_v6, sector benchmark population, query helpers; updated sqlite.sql base schema.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-data-foundation-sector-classification/13-RESEARCH.md
@schema/sqlite.sql
@capitoltraders_lib/src/db.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema v6 migration and base schema update</name>
  <files>capitoltraders_lib/src/db.rs, schema/sqlite.sql</files>
  <action>
1. In `schema/sqlite.sql`:
   - Add `gics_sector TEXT` column to the existing `issuers` CREATE TABLE statement (after `enriched_at TEXT`).
   - Add a new `sector_benchmarks` table definition after `employer_lookup`:
     ```sql
     CREATE TABLE IF NOT EXISTS sector_benchmarks (
         sector TEXT PRIMARY KEY,
         etf_ticker TEXT NOT NULL,
         etf_name TEXT NOT NULL
     );
     ```
   - Add index: `CREATE INDEX IF NOT EXISTS idx_issuers_gics_sector ON issuers(gics_sector);`
     Note: Use `idx_issuers_gics_sector` (NOT `idx_issuers_sector` which already exists for the upstream `sector` column).

2. In `capitoltraders_lib/src/db.rs`:
   - Add `migrate_v6(&self)` method following the exact pattern of migrate_v3/v4/v5:
     - ALTER TABLE issuers ADD COLUMN gics_sector TEXT (with duplicate column name error handling matching migrate_v1/v2 pattern)
     - CREATE TABLE IF NOT EXISTS sector_benchmarks (sector TEXT PRIMARY KEY, etf_ticker TEXT NOT NULL, etf_name TEXT NOT NULL)
     - CREATE INDEX IF NOT EXISTS idx_issuers_gics_sector ON issuers(gics_sector)
   - Add the v6 migration call in `init()` after the v5 block:
     ```rust
     if version < 6 {
         self.migrate_v6()?;
         self.conn.pragma_update(None, "user_version", 6)?;
     }
     ```
   - Add `populate_sector_benchmarks(&self)` method:
     - Check `SELECT COUNT(*) FROM sector_benchmarks` -- if > 0, return Ok(()) early
     - Insert 12 rows using unchecked_transaction:
       ("Market", "SPY", "SPDR S&P 500 ETF Trust"),
       ("Communication Services", "XLC", "Communication Services Select Sector SPDR Fund"),
       ("Consumer Discretionary", "XLY", "Consumer Discretionary Select Sector SPDR Fund"),
       ("Consumer Staples", "XLP", "Consumer Staples Select Sector SPDR Fund"),
       ("Energy", "XLE", "Energy Select Sector SPDR Fund"),
       ("Financials", "XLF", "Financial Select Sector SPDR Fund"),
       ("Health Care", "XLV", "Health Care Select Sector SPDR Fund"),
       ("Industrials", "XLI", "Industrial Select Sector SPDR Fund"),
       ("Information Technology", "XLK", "Technology Select Sector SPDR Fund"),
       ("Materials", "XLB", "Materials Select Sector SPDR Fund"),
       ("Real Estate", "XLRE", "Real Estate Select Sector SPDR Fund"),
       ("Utilities", "XLU", "Utilities Select Sector SPDR Fund")
   - Call `self.populate_sector_benchmarks()?;` at the end of `init()`, AFTER the schema DDL execute_batch (same position as it would run for fresh DBs too).

3. Add `get_sector_benchmarks(&self)` method returning `Result<Vec<(String, String, String)>, DbError>`:
   - Query: SELECT sector, etf_ticker, etf_name FROM sector_benchmarks ORDER BY sector
   - Return vec of (sector, etf_ticker, etf_name) tuples

4. Add `get_top_traded_tickers(&self, limit: usize)` method returning `Result<Vec<(String, i64)>, DbError>`:
   - Query:
     ```sql
     SELECT i.issuer_ticker, COUNT(*) as trade_count
     FROM trades t
     JOIN issuers i ON t.issuer_id = i.issuer_id
     WHERE i.issuer_ticker IS NOT NULL AND i.issuer_ticker != ''
     GROUP BY i.issuer_ticker
     ORDER BY trade_count DESC
     LIMIT ?1
     ```
   - Cast limit to i64 for the parameter binding.

All new methods should be `pub` and placed logically near existing similar methods (migration methods near other migrations, query methods near other query methods).
  </action>
  <verify>
    `cargo check -p capitoltraders_lib` compiles without errors.
    `cargo clippy -p capitoltraders_lib` passes with no warnings on new code.
  </verify>
  <done>
    - migrate_v6 exists and creates gics_sector column + sector_benchmarks table + index
    - populate_sector_benchmarks inserts 12 rows only when table is empty
    - get_sector_benchmarks returns 12 rows ordered by sector
    - get_top_traded_tickers returns ticker counts sorted descending
    - schema/sqlite.sql includes gics_sector column and sector_benchmarks table for fresh DBs
    - init() calls migrate_v6 when version < 6 and populate_sector_benchmarks after schema DDL
  </done>
</task>

<task type="auto">
  <name>Task 2: Migration and benchmark tests</name>
  <files>capitoltraders_lib/src/db.rs</files>
  <action>
Add tests in the existing `#[cfg(test)] mod tests` block at the end of db.rs. Follow the exact patterns from test_migrate_v5_from_v4, test_migrate_v5_idempotent, test_fresh_db_has_employer_tables, and test_v5_version_check.

Write these tests:

1. `test_migrate_v6_from_v5` - Set user_version to 5 manually, run init(), verify version is 6, verify gics_sector column exists on issuers (INSERT then SELECT with gics_sector), verify sector_benchmarks table exists.

2. `test_migrate_v6_idempotent` - Run init() twice, second must not fail, version still 6.

3. `test_v6_version_check` - Fresh DB init(), verify user_version == 6.

4. `test_fresh_db_has_sector_benchmarks` - Fresh DB init(), SELECT COUNT(*) FROM sector_benchmarks == 12.

5. `test_sector_benchmarks_populated_once` - Fresh DB init(), verify 12 rows, call populate_sector_benchmarks() again, still 12 rows (not 24).

6. `test_get_sector_benchmarks` - Fresh DB init(), call get_sector_benchmarks(), verify 12 results, verify SPY is in the list with sector "Market", verify XLK is "Information Technology".

7. `test_get_top_traded_tickers` - Create test DB, insert test issuers and trades, call get_top_traded_tickers(3), verify ordering by count descending, verify limit respected.

For test_get_top_traded_tickers, you need to insert into politicians, assets, issuers, and trades tables since trades has foreign keys. Use the open_test_db() helper if it exists, or Db::open_in_memory() + init(). Insert minimal rows:
- 1 politician, 1 asset
- 3 issuers with tickers "AAPL", "MSFT", "GOOG"
- 5 trades for AAPL, 3 for MSFT, 1 for GOOG
- Verify get_top_traded_tickers(2) returns [("AAPL", 5), ("MSFT", 3)]
  </action>
  <verify>
    `cargo test -p capitoltraders_lib migrate_v6` passes.
    `cargo test -p capitoltraders_lib sector_benchmark` passes.
    `cargo test -p capitoltraders_lib top_traded_tickers` passes.
    `cargo test --workspace` passes (all existing 513+ tests still pass).
  </verify>
  <done>
    - 7 new tests all pass
    - Migration from v5 to v6 verified
    - Idempotency verified (double init)
    - Fresh DB has correct version and benchmark data
    - Benchmark population is insert-once (not duplicating)
    - get_sector_benchmarks returns correct 12 rows
    - get_top_traded_tickers respects limit and ordering
    - All existing tests still pass
  </done>
</task>

</tasks>

<verification>
- `cargo test --workspace` passes with 520+ tests (513 existing + 7 new)
- `cargo clippy --workspace` passes
- Schema version is 6 on fresh DB
- sector_benchmarks has exactly 12 rows after init()
- gics_sector column exists on issuers table
- idx_issuers_gics_sector index exists
</verification>

<success_criteria>
- FOUND-01 partially satisfied: schema v6 migration exists and is idempotent
- FOUND-02 satisfied: sector_benchmarks reference table has 12 rows (SPY + 11 sector ETFs) queryable via get_sector_benchmarks()
- Schema foundation ready for Phase 13 Plan 02 (sector mapping module)
</success_criteria>

<output>
After completion, create `.planning/phases/13-data-foundation-sector-classification/13-01-SUMMARY.md`
</output>
