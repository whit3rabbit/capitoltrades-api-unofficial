---
phase: 08-openfec-api-client
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - capitoltraders_lib/src/openfec/mod.rs
  - capitoltraders_lib/src/openfec/error.rs
  - capitoltraders_lib/src/openfec/types.rs
  - capitoltraders_lib/src/openfec/client.rs
  - capitoltraders_lib/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "OpenFecClient can search candidates by name and return structured Candidate records"
    - "OpenFecClient can fetch committees for a given candidate ID"
    - "OpenFecClient can fetch Schedule A contributions using keyset pagination cursors"
    - "A 429 HTTP response is mapped to OpenFecError::RateLimited"
    - "A 403 HTTP response is mapped to OpenFecError::InvalidApiKey"
    - "API key is passed as query parameter, never as a header"
    - "Schedule A never sends a page parameter (keyset only)"
  artifacts:
    - path: "capitoltraders_lib/src/openfec/error.rs"
      provides: "OpenFecError enum with RateLimited, InvalidApiKey, InvalidRequest, ParseFailed, Network variants"
      contains: "pub enum OpenFecError"
    - path: "capitoltraders_lib/src/openfec/types.rs"
      provides: "Candidate, Committee, Contribution, CandidateSearchQuery, CommitteeQuery, ScheduleAQuery, pagination types"
      contains: "pub struct Candidate"
    - path: "capitoltraders_lib/src/openfec/client.rs"
      provides: "OpenFecClient with search_candidates, get_candidate_committees, get_schedule_a methods"
      exports: ["OpenFecClient"]
    - path: "capitoltraders_lib/src/openfec/mod.rs"
      provides: "Module re-exports"
      contains: "pub mod client"
    - path: "capitoltraders_lib/src/lib.rs"
      provides: "openfec module exported from lib crate"
      contains: "pub mod openfec"
  key_links:
    - from: "capitoltraders_lib/src/openfec/client.rs"
      to: "capitoltraders_lib/src/openfec/types.rs"
      via: "use super::types"
      pattern: "use super::types::"
    - from: "capitoltraders_lib/src/openfec/client.rs"
      to: "capitoltraders_lib/src/openfec/error.rs"
      via: "use super::error"
      pattern: "use super::error::OpenFecError"
    - from: "capitoltraders_lib/src/openfec/client.rs"
      to: "https://api.open.fec.gov/v1"
      via: "reqwest HTTP calls with api_key query param"
      pattern: "api_key"
---

<objective>
Create the OpenFEC API client module with types, error handling, and three endpoint methods.

Purpose: Establish the typed Rust client that downstream phases (9, 10) will use to fetch candidate, committee, and donation data from the OpenFEC API.
Output: `capitoltraders_lib/src/openfec/` module with client.rs, types.rs, error.rs, mod.rs, plus lib.rs export.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-openfec-api-client/08-RESEARCH.md
@capitoltraders_lib/src/yahoo.rs
@capitoltraders_lib/src/lib.rs
@capitoltraders_lib/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenFEC error and type definitions</name>
  <files>
    capitoltraders_lib/src/openfec/error.rs
    capitoltraders_lib/src/openfec/types.rs
    capitoltraders_lib/src/openfec/mod.rs
  </files>
  <action>
Create directory `capitoltraders_lib/src/openfec/`.

**error.rs:** Define OpenFecError enum using thiserror (mirror YahooError pattern from yahoo.rs):
- `RateLimited` -- "Rate limited by OpenFEC API (HTTP 429)"
- `InvalidApiKey` -- "Invalid API key (HTTP 403)"
- `InvalidRequest(String)` -- "Invalid request: {0}"
- `ParseFailed(String)` -- "Failed to parse response: {0}"
- `Network(#[from] reqwest::Error)` -- "Network error"

**types.rs:** Define all request/response types with serde Deserialize + Serialize + Debug + Clone:

Response wrapper (all OpenFEC endpoints return this shape):
- `ApiResponse<T>` generic: `results: Vec<T>`, `pagination: P` (parameterized on pagination type too, or use an enum -- simpler: two response types)

Candidate types:
- `CandidateSearchResponse` { results: Vec<Candidate>, pagination: StandardPagination }
- `Candidate` { candidate_id: String, name: String, party: Option<String>, office: Option<String>, state: Option<String>, district: Option<String>, cycles: Option<Vec<i32>>, candidate_status: Option<String>, incumbent_challenge: Option<String> }
- `StandardPagination` { count: i64, page: Option<i64>, pages: Option<i64>, per_page: i64 }

Committee types:
- `CommitteeResponse` { results: Vec<Committee>, pagination: StandardPagination }
- `Committee` { committee_id: String, name: String, committee_type: Option<String>, designation: Option<String>, party: Option<String>, state: Option<String>, cycles: Option<Vec<i32>> }

Schedule A types:
- `ScheduleAResponse` { results: Vec<Contribution>, pagination: ScheduleAPagination }
- `Contribution` { sub_id: Option<String>, committee: Option<CommitteeRef>, contributor_name: Option<String>, contributor_state: Option<String>, contributor_employer: Option<String>, contributor_occupation: Option<String>, contribution_receipt_date: Option<String>, contribution_receipt_amount: Option<f64> }
- `CommitteeRef` { committee_id: Option<String>, name: Option<String> } -- nested committee info in contribution
- `ScheduleAPagination` { count: i64, per_page: i64, last_indexes: Option<LastIndexes> }
- `LastIndexes` { last_index: i64, last_contribution_receipt_date: String }

Query builders (fluent builder pattern, mirror TradeQuery from capitoltrades_api):
- `CandidateSearchQuery` { name: Option<String>, office: Option<String>, state: Option<String>, party: Option<String>, cycle: Option<i32>, page: Option<i32>, per_page: Option<i32> } with Default, with_name(), with_office(), with_state(), with_party(), with_cycle(), with_page(), with_per_page() methods. Add `to_query_pairs(&self) -> Vec<(String, String)>` that builds query parameter pairs (excluding None values).
- `ScheduleAQuery` { committee_id: Option<String>, contributor_name: Option<String>, two_year_transaction_period: Option<i32>, per_page: Option<i32>, last_index: Option<i64>, last_contribution_receipt_date: Option<String>, sort: Option<String>, sort_hide_null: Option<bool> } with Default, with_committee_id(), with_contributor_name(), with_cycle(), with_per_page(), with_last_index(), with_last_contribution_receipt_date(), with_sort() methods. Add `to_query_pairs(&self) -> Vec<(String, String)>`. CRITICAL: The `to_query_pairs()` method must NEVER emit a "page" parameter. Schedule A uses keyset pagination only.

Use `#[serde(default)]` on Vec fields (cycles) to handle missing fields gracefully.
Use `Option` liberally -- the OpenFEC API has many nullable fields.
Derive Clone on all response types so they can be cached.

**mod.rs:**
```rust
pub mod client;
pub mod error;
pub mod types;

pub use client::OpenFecClient;
pub use error::OpenFecError;
```

Add unit tests in types.rs for query builder `to_query_pairs()`:
- CandidateSearchQuery::default().to_query_pairs() returns empty vec
- CandidateSearchQuery with name "Pelosi" produces ("name", "Pelosi") pair
- ScheduleAQuery with committee_id and last_index produces correct pairs
- ScheduleAQuery NEVER produces a "page" parameter even if explicitly set (there should be no page field)
  </action>
  <verify>
`cargo check -p capitoltraders_lib` compiles without errors. Unit tests for query builders pass: `cargo test -p capitoltraders_lib openfec::types::tests`
  </verify>
  <done>
OpenFecError enum has 5 variants matching research spec. All request/response types compile with serde derives. Query builder to_query_pairs() produces correct parameter lists. Schedule A query has no page field. At least 4 unit tests pass for query builder behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OpenFEC client with three endpoint methods</name>
  <files>
    capitoltraders_lib/src/openfec/client.rs
    capitoltraders_lib/src/lib.rs
  </files>
  <action>
**client.rs:** Create OpenFecClient struct mirroring YahooClient pattern from yahoo.rs:

```rust
pub struct OpenFecClient {
    client: reqwest::Client,
    api_key: String,
    base_url: String,
    // No DashMap cache in client itself -- caching decisions belong to the caller (Phase 9/10).
    // YahooClient caches because it wraps a third-party connector that doesn't support caching.
    // OpenFecClient uses reqwest directly, and downstream phases will cache at the DB level.
}
```

Constructor methods:
- `pub fn new(api_key: String) -> Result<Self, OpenFecError>` -- uses default base URL "https://api.open.fec.gov/v1"
- `pub fn with_base_url(base_url: &str, api_key: String) -> Result<Self, OpenFecError>` -- for wiremock tests (mirrors capitoltrades_api Client::with_base_url pattern)

Private helper:
- `async fn get<T: DeserializeOwned>(&self, path: &str, params: &[(String, String)]) -> Result<T, OpenFecError>` that:
  1. Builds URL from self.base_url + path
  2. Adds ("api_key", self.api_key.clone()) to params
  3. Calls reqwest GET with all query params
  4. Maps HTTP 429 -> OpenFecError::RateLimited
  5. Maps HTTP 403 -> OpenFecError::InvalidApiKey
  6. Maps other non-2xx -> OpenFecError::InvalidRequest with status code and body snippet
  7. Deserializes JSON body -> T, mapping serde errors to OpenFecError::ParseFailed
  8. IMPORTANT: Do NOT log or debug-print the full URL (contains api_key). If logging is needed, redact the api_key parameter.

Three public endpoint methods:

1. `pub async fn search_candidates(&self, query: &CandidateSearchQuery) -> Result<CandidateSearchResponse, OpenFecError>`
   - Path: "/candidates/search/"
   - Params: query.to_query_pairs()
   - Returns: CandidateSearchResponse

2. `pub async fn get_candidate_committees(&self, candidate_id: &str) -> Result<CommitteeResponse, OpenFecError>`
   - Path: format!("/candidate/{}/committees/", candidate_id)
   - Params: empty (just api_key added by helper)
   - Returns: CommitteeResponse

3. `pub async fn get_schedule_a(&self, query: &ScheduleAQuery) -> Result<ScheduleAResponse, OpenFecError>`
   - Path: "/schedules/schedule_a/"
   - Params: query.to_query_pairs()
   - Returns: ScheduleAResponse

**lib.rs:** Add `pub mod openfec;` to module list. Add re-exports:
```rust
pub use openfec::{OpenFecClient, OpenFecError};
```

Do NOT add DashMap cache to the client. The research suggests it, but for this crate the right caching layer is the DB (Phase 9 uses three-tier cache: memory -> SQLite -> API). Adding a DashMap here would create a redundant cache that complicates cache invalidation. Keep the client thin -- it translates HTTP to typed Rust, nothing more.
  </action>
  <verify>
`cargo check -p capitoltraders_lib` compiles. `cargo clippy -p capitoltraders_lib` has zero new warnings. `cargo test -p capitoltraders_lib` passes all existing 385+ tests plus new query builder tests.
  </verify>
  <done>
OpenFecClient compiles with new(), with_base_url(), search_candidates(), get_candidate_committees(), get_schedule_a(). HTTP status codes 429 and 403 are mapped to typed errors. API key is passed as query parameter. lib.rs exports OpenFecClient and OpenFecError. All existing tests still pass. Zero clippy warnings.
  </done>
</task>

</tasks>

<verification>
- `cargo check --workspace` compiles without errors
- `cargo clippy --workspace` has zero warnings
- `cargo test --workspace` passes all existing tests plus new query builder unit tests
- `capitoltraders_lib/src/openfec/` directory exists with mod.rs, error.rs, types.rs, client.rs
- `OpenFecClient` and `OpenFecError` are exported from `capitoltraders_lib`
</verification>

<success_criteria>
- OpenFecError enum has 5 variants (RateLimited, InvalidApiKey, InvalidRequest, ParseFailed, Network)
- All response types deserialize with serde (Candidate, Committee, Contribution, pagination)
- Query builders produce correct parameter pairs with to_query_pairs()
- Schedule A query has NO page field
- OpenFecClient has with_base_url constructor for testing
- Three endpoint methods compile and accept correct query/return types
- HTTP 429 -> RateLimited, 403 -> InvalidApiKey error mapping in client
- API key passed as query parameter ?api_key=..., not as header
- All existing tests pass, zero clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/08-openfec-api-client/08-01-SUMMARY.md`
</output>
