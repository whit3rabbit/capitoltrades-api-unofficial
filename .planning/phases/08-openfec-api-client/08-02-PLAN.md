---
phase: 08-openfec-api-client
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - capitoltraders_lib/tests/openfec_integration.rs
  - capitoltraders_lib/tests/fixtures/openfec_candidates.json
  - capitoltraders_lib/tests/fixtures/openfec_committees.json
  - capitoltraders_lib/tests/fixtures/openfec_schedule_a.json
  - capitoltraders_lib/tests/fixtures/openfec_schedule_a_page2.json
autonomous: true

must_haves:
  truths:
    - "Candidate search success response deserializes into CandidateSearchResponse with correct field values"
    - "Committee lookup success response deserializes into CommitteeResponse with correct field values"
    - "Schedule A success response deserializes into ScheduleAResponse with Contribution records"
    - "A 429 response from any endpoint returns OpenFecError::RateLimited"
    - "A 403 response from any endpoint returns OpenFecError::InvalidApiKey"
    - "Schedule A keyset pagination works: first page returns cursor, second page uses cursor params"
    - "Malformed JSON response returns OpenFecError::ParseFailed"
  artifacts:
    - path: "capitoltraders_lib/tests/openfec_integration.rs"
      provides: "Wiremock integration tests for all 3 endpoints with success, error, and pagination scenarios"
      min_lines: 200
    - path: "capitoltraders_lib/tests/fixtures/openfec_candidates.json"
      provides: "Candidate search response fixture"
      contains: "candidate_id"
    - path: "capitoltraders_lib/tests/fixtures/openfec_committees.json"
      provides: "Committee lookup response fixture"
      contains: "committee_id"
    - path: "capitoltraders_lib/tests/fixtures/openfec_schedule_a.json"
      provides: "Schedule A first page response fixture with cursor"
      contains: "last_indexes"
    - path: "capitoltraders_lib/tests/fixtures/openfec_schedule_a_page2.json"
      provides: "Schedule A second page response fixture with null cursor"
      contains: "last_indexes"
  key_links:
    - from: "capitoltraders_lib/tests/openfec_integration.rs"
      to: "capitoltraders_lib/src/openfec/client.rs"
      via: "OpenFecClient::with_base_url pointed at MockServer"
      pattern: "OpenFecClient::with_base_url.*mock_server"
    - from: "capitoltraders_lib/tests/openfec_integration.rs"
      to: "capitoltraders_lib/src/openfec/types.rs"
      via: "Assertions on deserialized Candidate, Committee, Contribution fields"
      pattern: "assert.*candidate_id"
    - from: "capitoltraders_lib/tests/openfec_integration.rs"
      to: "capitoltraders_lib/src/openfec/error.rs"
      via: "matches! assertions on OpenFecError variants"
      pattern: "matches!.*OpenFecError::RateLimited"
---

<objective>
Create comprehensive wiremock integration tests and JSON fixtures validating all three OpenFEC endpoints.

Purpose: Prove the client handles success, rate limits, invalid keys, malformed responses, and keyset pagination correctly -- without hitting the real OpenFEC API. These tests are the safety net for Phase 9 and 10.
Output: Integration test file + 4 JSON fixtures covering all endpoint scenarios.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-openfec-api-client/08-RESEARCH.md
@.planning/phases/08-openfec-api-client/08-01-SUMMARY.md
@capitoltrades_api/tests/client_integration.rs
@capitoltraders_lib/src/openfec/client.rs
@capitoltraders_lib/src/openfec/types.rs
@capitoltraders_lib/src/openfec/error.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JSON fixtures for OpenFEC response types</name>
  <files>
    capitoltraders_lib/tests/fixtures/openfec_candidates.json
    capitoltraders_lib/tests/fixtures/openfec_committees.json
    capitoltraders_lib/tests/fixtures/openfec_schedule_a.json
    capitoltraders_lib/tests/fixtures/openfec_schedule_a_page2.json
  </files>
  <action>
Create `capitoltraders_lib/tests/fixtures/` directory if it does not exist.

**openfec_candidates.json:** A realistic CandidateSearchResponse for searching "Pelosi":
```json
{
  "results": [
    {
      "candidate_id": "H8CA05035",
      "name": "PELOSI, NANCY",
      "party": "DEM",
      "office": "H",
      "state": "CA",
      "district": "11",
      "cycles": [2020, 2022, 2024],
      "candidate_status": "C",
      "incumbent_challenge": "I"
    }
  ],
  "pagination": {
    "count": 1,
    "page": 1,
    "pages": 1,
    "per_page": 20
  }
}
```

**openfec_committees.json:** A CommitteeResponse for candidate H8CA05035 with 2 committees (campaign + leadership PAC):
```json
{
  "results": [
    {
      "committee_id": "C00345777",
      "name": "NANCY PELOSI FOR CONGRESS",
      "committee_type": "H",
      "designation": "P",
      "party": "DEM",
      "state": "CA",
      "cycles": [2020, 2022, 2024]
    },
    {
      "committee_id": "C00410118",
      "name": "PAC TO THE FUTURE",
      "committee_type": "N",
      "designation": "D",
      "party": "DEM",
      "state": "CA",
      "cycles": [2020, 2022, 2024]
    }
  ],
  "pagination": {
    "count": 2,
    "page": 1,
    "pages": 1,
    "per_page": 20
  }
}
```

**openfec_schedule_a.json:** First page of Schedule A contributions with keyset cursor:
```json
{
  "results": [
    {
      "sub_id": "4062820241724544081",
      "committee": {
        "committee_id": "C00345777",
        "name": "NANCY PELOSI FOR CONGRESS"
      },
      "contributor_name": "SMITH, JOHN",
      "contributor_state": "CA",
      "contributor_employer": "GOOGLE LLC",
      "contributor_occupation": "SOFTWARE ENGINEER",
      "contribution_receipt_date": "2024-03-15",
      "contribution_receipt_amount": 2800.0
    },
    {
      "sub_id": "4062820241724544082",
      "committee": {
        "committee_id": "C00345777",
        "name": "NANCY PELOSI FOR CONGRESS"
      },
      "contributor_name": "DOE, JANE",
      "contributor_state": "NY",
      "contributor_employer": "GOLDMAN SACHS",
      "contributor_occupation": "ANALYST",
      "contribution_receipt_date": "2024-03-14",
      "contribution_receipt_amount": 1000.0
    }
  ],
  "pagination": {
    "count": 150,
    "per_page": 2,
    "last_indexes": {
      "last_index": 230880619,
      "last_contribution_receipt_date": "2024-03-14"
    }
  }
}
```

**openfec_schedule_a_page2.json:** Second (final) page with null cursor indicating no more pages:
```json
{
  "results": [
    {
      "sub_id": "4062820241724544083",
      "committee": {
        "committee_id": "C00345777",
        "name": "NANCY PELOSI FOR CONGRESS"
      },
      "contributor_name": "JOHNSON, BOB",
      "contributor_state": "TX",
      "contributor_employer": "SELF-EMPLOYED",
      "contributor_occupation": "CONSULTANT",
      "contribution_receipt_date": "2024-03-10",
      "contribution_receipt_amount": 500.0
    }
  ],
  "pagination": {
    "count": 150,
    "per_page": 2,
    "last_indexes": null
  }
}
```

Also write a standalone deserialization unit test file or add tests at the bottom of the integration test (next task) that load each fixture with `include_str!` and verify serde deserialization succeeds with correct field values. This validates the types match real API shape before wiremock tests run.

Deserialization tests (at least 3):
1. Load openfec_candidates.json, deserialize to CandidateSearchResponse, assert candidate_id == "H8CA05035" and name == "PELOSI, NANCY"
2. Load openfec_committees.json, deserialize to CommitteeResponse, assert len == 2 and first committee_type == "H"
3. Load openfec_schedule_a.json, deserialize to ScheduleAResponse, assert len == 2, first amount == 2800.0, last_indexes.last_index == 230880619
4. Load openfec_schedule_a_page2.json, deserialize to ScheduleAResponse, assert last_indexes is None
  </action>
  <verify>
JSON files exist at `capitoltraders_lib/tests/fixtures/openfec_*.json`. Each is valid JSON (`cargo test -p capitoltraders_lib openfec` compiles).
  </verify>
  <done>
4 JSON fixture files exist with realistic OpenFEC response data. Deserialization tests confirm all 4 fixtures parse correctly into typed structs with expected field values.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create wiremock integration tests for all three endpoints</name>
  <files>
    capitoltraders_lib/tests/openfec_integration.rs
  </files>
  <action>
Create integration test file following the pattern from `capitoltrades_api/tests/client_integration.rs`.

Add wiremock as a dev-dependency to `capitoltraders_lib/Cargo.toml` if not already present:
```toml
[dev-dependencies]
wiremock = "0.6"
tokio = { workspace = true, features = ["rt-multi-thread", "macros"] }
serde_json = { workspace = true }
```

**Test structure:** Use `wiremock::MockServer`, mount mocks per test, create client with `OpenFecClient::with_base_url(&mock_server.uri(), "test-key".to_string())`.

Load fixtures with `include_str!("fixtures/openfec_candidates.json")` etc.

**Required tests (minimum 10):**

Candidate search:
1. `candidate_search_success` -- Mount 200 with candidates fixture, call search_candidates with name "Pelosi", assert 1 result with correct candidate_id
2. `candidate_search_rate_limited` -- Mount 429, assert OpenFecError::RateLimited
3. `candidate_search_invalid_key` -- Mount 403, assert OpenFecError::InvalidApiKey
4. `candidate_search_malformed_json` -- Mount 200 with invalid JSON body, assert OpenFecError::ParseFailed
5. `candidate_search_sends_query_params` -- Mount 200 with candidates fixture, call with name + state + office, verify mock received all query params (use wiremock query_param matchers)

Committee lookup:
6. `get_committees_success` -- Mount 200 at `/v1/candidate/H8CA05035/committees/` with committees fixture, call get_candidate_committees("H8CA05035"), assert 2 results
7. `get_committees_rate_limited` -- Mount 429 at committee path, assert RateLimited

Schedule A:
8. `schedule_a_success` -- Mount 200 with schedule_a fixture, call get_schedule_a with committee_id, assert 2 results and last_indexes present
9. `schedule_a_keyset_pagination` -- Mount two mocks: first without last_index param returns page 1 fixture, second with last_index=230880619 and last_contribution_receipt_date=2024-03-14 returns page 2 fixture. Call get_schedule_a twice (first without cursor, second with cursor from first response). Assert page 1 has 2 results with cursor, page 2 has 1 result with null cursor.
10. `schedule_a_rate_limited` -- Mount 429, assert RateLimited

**Verification of API key passing:**
11. `api_key_sent_as_query_param` -- Mount a mock matching query_param("api_key", "test-key") with 200 response. If mock receives request without api_key param, it won't match and test fails. This proves api_key is sent as query parameter.

**Important patterns:**
- Use `Mock::given(method("GET")).and(path("/v1/candidates/search/"))` -- include /v1 prefix since client base_url is `{mock_uri}/v1` but with_base_url receives just mock_uri. Check how client.rs builds URLs -- if base_url already includes /v1, then path matcher should be `/v1/candidates/search/`. Match the actual implementation.
- Use `query_param("api_key", "test-key")` in mock matchers where API key verification matters
- For keyset pagination test, use `query_param("last_index", "230880619")` matcher on second mock
- Assert specific field values from fixtures, not just result counts
  </action>
  <verify>
`cargo test -p capitoltraders_lib --test openfec_integration` passes all 11+ tests. `cargo test --workspace` passes all existing + new tests. `cargo clippy --workspace` zero warnings.
  </verify>
  <done>
At least 11 wiremock integration tests pass covering: candidate search (success, 429, 403, malformed JSON, query params), committee lookup (success, 429), Schedule A (success, keyset pagination with cursor, 429), API key as query parameter. All existing 385+ tests still pass. Zero clippy warnings.
  </done>
</task>

</tasks>

<verification>
- `cargo test -p capitoltraders_lib --test openfec_integration` passes all tests
- `cargo test --workspace` passes all existing + new tests (target: 400+ total)
- `cargo clippy --workspace` has zero warnings
- JSON fixtures exist and load correctly via include_str!
- Keyset pagination test proves cursor-based fetching works end-to-end
- Error mapping tests prove 429 -> RateLimited and 403 -> InvalidApiKey
</verification>

<success_criteria>
- 4 JSON fixture files exist with realistic OpenFEC response shapes
- At least 11 integration tests pass (3 candidate, 2 committee, 3 schedule_a, 1 api_key, 2+ deserialization)
- Keyset pagination test fetches page 1, extracts cursor, fetches page 2 with cursor
- 429 and 403 error mapping verified for at least 2 endpoints each
- Malformed JSON produces ParseFailed error
- API key confirmed sent as query parameter via mock matcher
- All existing workspace tests still pass
- Zero clippy warnings across workspace
</success_criteria>

<output>
After completion, create `.planning/phases/08-openfec-api-client/08-02-SUMMARY.md`
</output>
