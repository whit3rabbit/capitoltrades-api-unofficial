---
phase: 04-politician-enrichment
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - capitoltraders_lib/src/db.rs
  - capitoltraders_lib/src/lib.rs
  - capitoltraders_cli/src/commands/politicians.rs
  - capitoltraders_cli/src/main.rs
  - capitoltraders_cli/src/output.rs
  - capitoltraders_cli/src/xml_output.rs
  - capitoltraders_cli/src/output_tests.rs
autonomous: true

must_haves:
  truths:
    - "Running `capitoltraders politicians --db trades.db` shows enriched politician data with committees"
    - "All 5 output formats (table, json, csv, md, xml) display committee memberships"
    - "Unsupported filters on --db path bail with helpful error listing supported filters"
  artifacts:
    - path: "capitoltraders_lib/src/db.rs"
      provides: "DbPoliticianRow struct and query_politicians() method with LEFT JOIN on politician_committees"
      contains: "pub fn query_politicians"
    - path: "capitoltraders_cli/src/output.rs"
      provides: "DbPoliticianOutputRow and print_db_politicians_* functions for all 5 formats"
      contains: "pub fn print_db_politicians_table"
    - path: "capitoltraders_cli/src/commands/politicians.rs"
      provides: "--db flag and run_db() function for DB-backed politician output"
      contains: "pub async fn run_db"
    - path: "capitoltraders_cli/src/xml_output.rs"
      provides: "db_politicians_to_xml() function"
      contains: "pub fn db_politicians_to_xml"
  key_links:
    - from: "politicians.rs::run_db"
      to: "db.rs::query_politicians"
      via: "builds DbPoliticianFilter and calls query"
      pattern: "query_politicians"
    - from: "main.rs"
      to: "politicians.rs::run_db"
      via: "--db flag routing"
      pattern: "run_db"
    - from: "output.rs::print_db_politicians_table"
      to: "db.rs::DbPoliticianRow"
      via: "maps DbPoliticianRow to DbPoliticianOutputRow"
      pattern: "DbPoliticianRow"
---

<objective>
Add --db flag to the politicians command with committee-aware output in all 5 formats.

Purpose: OUT-02 requires committee memberships to be visible in politician output. The live-scrape path cannot show committee data (detail pages lack it, and committee-filter iteration is a separate scrape pass). The DB path reads from SQLite after sync+enrichment and JOINs on politician_committees to include committee data. This follows the exact pattern established in Phase 3 for trades --db.

Output: DbPoliticianRow, query_politicians(), --db flag on politicians command, output functions for all 5 formats, and tests.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-politician-enrichment/04-RESEARCH.md
@.planning/phases/04-politician-enrichment/04-01-SUMMARY.md
@.planning/phases/03-trade-sync-and-output/03-02-SUMMARY.md
@.planning/phases/03-trade-sync-and-output/03-03-SUMMARY.md
@capitoltraders_lib/src/db.rs
@capitoltraders_lib/src/lib.rs
@capitoltraders_cli/src/commands/politicians.rs
@capitoltraders_cli/src/commands/trades.rs
@capitoltraders_cli/src/main.rs
@capitoltraders_cli/src/output.rs
@capitoltraders_cli/src/xml_output.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DbPoliticianRow, query_politicians, --db flag, and output functions</name>
  <files>
    capitoltraders_lib/src/db.rs
    capitoltraders_lib/src/lib.rs
    capitoltraders_cli/src/commands/politicians.rs
    capitoltraders_cli/src/main.rs
    capitoltraders_cli/src/output.rs
    capitoltraders_cli/src/xml_output.rs
  </files>
  <action>
1. **db.rs -- Add DbPoliticianRow struct** (following DbTradeRow pattern):
   ```rust
   #[derive(Debug, Clone, Serialize)]
   pub struct DbPoliticianRow {
       pub politician_id: String,
       pub name: String,
       pub party: String,
       pub state: String,
       pub chamber: String,
       pub gender: String,
       pub committees: Vec<String>,
       pub trades: i64,
       pub issuers: i64,
       pub volume: i64,
       pub last_traded: Option<String>,
       pub enriched_at: Option<String>,
   }
   ```

2. **db.rs -- Add DbPoliticianFilter struct**:
   ```rust
   #[derive(Debug, Default)]
   pub struct DbPoliticianFilter {
       pub party: Option<String>,
       pub state: Option<String>,
       pub name: Option<String>,
       pub chamber: Option<String>,
       pub limit: Option<i64>,
   }
   ```

3. **db.rs -- Add query_politicians() method** (following query_trades pattern):
   ```rust
   pub fn query_politicians(&self, filter: &DbPoliticianFilter) -> Result<Vec<DbPoliticianRow>, DbError>
   ```
   SQL:
   ```sql
   SELECT p.politician_id, p.first_name || ' ' || p.last_name AS name,
          p.party, p.state_id, p.chamber, p.gender, p.enriched_at,
          COALESCE(ps.count_trades, 0) AS trades,
          COALESCE(ps.count_issuers, 0) AS issuers,
          COALESCE(ps.volume, 0) AS volume,
          ps.date_last_traded,
          COALESCE(GROUP_CONCAT(DISTINCT pc.committee), '') AS committees
   FROM politicians p
   LEFT JOIN politician_stats ps ON p.politician_id = ps.politician_id
   LEFT JOIN politician_committees pc ON p.politician_id = pc.politician_id
   WHERE 1=1
   {dynamic filters}
   GROUP BY p.politician_id
   ORDER BY COALESCE(ps.volume, 0) DESC
   {LIMIT}
   ```
   - Use the same dynamic filter pattern as query_trades (Vec of Box dyn ToSql, param_idx).
   - Filters: party (p.party = ?), state (UPPER(p.state_id) = UPPER(?)), name (first_name || ' ' || last_name LIKE %?%), chamber (p.chamber = ?).
   - Parse committees string the same way as DbTradeRow (split on comma, empty string = empty vec).

4. **lib.rs -- Re-export new types**:
   Add `DbPoliticianRow` and `DbPoliticianFilter` to the pub use db::{...} line.

5. **politicians.rs -- Add --db flag and run_db()**:
   - Add `--db` arg to PoliticiansArgs (same pattern as TradesArgs):
     ```rust
     /// Read politicians from local SQLite database (requires prior sync)
     #[arg(long)]
     pub db: Option<PathBuf>,
     ```
   - Add `use std::path::PathBuf;` import.
   - Add `run_db()` function (following trades.rs::run_db pattern):
     ```rust
     pub async fn run_db(
         args: &PoliticiansArgs,
         db_path: &std::path::Path,
         format: &OutputFormat,
     ) -> Result<()>
     ```
   - Unsupported filter detection: committee and issuer_id are not supported on DB path. Bail with explicit message listing supported filters (party, state, name, chamber).
   - Build DbPoliticianFilter from validated args. Use capitalize_party() (copy from trades.rs, or factor out into a shared utility -- simplest is to copy the 6-line function into politicians.rs).
   - Call db.query_politicians(&filter), print count to stderr, dispatch to format-specific output functions.
   - Import the new output functions and types.

6. **main.rs -- Route --db to run_db**:
   Update the `Commands::Politicians` match arm:
   ```rust
   Commands::Politicians(args) => {
       if let Some(ref db_path) = args.db {
           commands::politicians::run_db(args, db_path, &format).await?
       } else {
           commands::politicians::run(args, &scraper, &format).await?
       }
   }
   ```

7. **output.rs -- Add DB politician output functions**:
   - Add DbPoliticianOutputRow struct (Tabled + Serialize):
     ```rust
     #[derive(Tabled, Serialize)]
     struct DbPoliticianOutputRow {
         #[tabled(rename = "Name")]  #[serde(rename = "Name")]
         name: String,
         #[tabled(rename = "Party")]  #[serde(rename = "Party")]
         party: String,
         #[tabled(rename = "State")]  #[serde(rename = "State")]
         state: String,
         #[tabled(rename = "Chamber")]  #[serde(rename = "Chamber")]
         chamber: String,
         #[tabled(rename = "Committees")]  #[serde(rename = "Committees")]
         committees: String,
         #[tabled(rename = "Trades")]  #[serde(rename = "Trades")]
         trades: i64,
         #[tabled(rename = "Volume")]  #[serde(rename = "Volume")]
         volume: String,
     }
     ```
   - Add `build_db_politician_rows()` function mapping DbPoliticianRow -> DbPoliticianOutputRow. Join committees with ", " separator.
   - Add `print_db_politicians_table()`, `print_db_politicians_markdown()`, `print_db_politicians_csv()`, `print_db_politicians_xml()` functions (same pattern as db trades output).
   - CSV: sanitize name and committees fields with sanitize_csv_field.
   - Import DbPoliticianRow from capitoltraders_lib.

8. **xml_output.rs -- Add db_politicians_to_xml()**:
   ```rust
   pub fn db_politicians_to_xml(politicians: &[DbPoliticianRow]) -> String {
       items_to_xml("politicians", "politician", politicians)
   }
   ```
   Import DbPoliticianRow. The existing singular() function already maps "committees" -> "committee".
  </action>
  <verify>
    `cargo build --workspace` compiles without errors.
    `cargo clippy --workspace` produces no warnings.
    `cargo test --workspace` -- all tests pass.
  </verify>
  <done>
    politicians --db flag routes to run_db() which queries SQLite with LEFT JOIN on politician_committees. DbPoliticianOutputRow includes Committees column. All 5 output formats (table, json, csv, md, xml) display committee data. Unsupported filters bail with helpful message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for DB politician query and output</name>
  <files>
    capitoltraders_lib/src/db.rs
    capitoltraders_cli/src/output_tests.rs
  </files>
  <action>
1. **db.rs tests** -- Add query_politicians tests (following the query_trades test pattern):
   - `test_query_politicians_no_filter`: Insert 2 politicians with stats, verify query returns both ordered by volume DESC.
   - `test_query_politicians_party_filter`: Insert democrat and republican, filter by party, verify only matching returned.
   - `test_query_politicians_name_filter`: Insert politicians, filter by name substring, verify LIKE matching works.
   - `test_query_politicians_with_committees`: Insert politician, add committee memberships via replace_all_politician_committees, verify committees Vec is populated in query result.
   - `test_query_politicians_limit`: Insert 3 politicians, query with limit=2, verify only 2 returned.

   Use the existing test helpers (make_test_trade or similar patterns that populate politicians and politician_stats tables). If no helper exists for politicians specifically, insert directly via SQL in the test setup (INSERT INTO politicians ... and INSERT INTO politician_stats ...).

2. **output_tests.rs** -- Add DB politician output tests (following the db trade output test pattern):
   - `test_db_politician_row_mapping`: Create a DbPoliticianRow with committees, verify DbPoliticianOutputRow has correct committees string (comma-separated).
   - `test_db_politician_empty_committees`: Create DbPoliticianRow with empty committees vec, verify empty string in output.
   - `test_db_politician_json_serialization`: Create DbPoliticianRow with committees, serialize to JSON, verify committees array is present.
   - `test_db_politician_csv_headers`: Verify CSV output contains expected header columns (Name, Party, State, Chamber, Committees, Trades, Volume).
  </action>
  <verify>
    `cargo test -p capitoltraders_lib query_politicians` passes.
    `cargo test -p capitoltraders_cli db_politician` passes.
    `cargo test --workspace` -- all tests pass, no regressions.
    `cargo clippy --workspace` -- no warnings.
  </verify>
  <done>
    5 DB query tests verify filtering, committee JOIN, and ordering. 4 output tests verify row mapping, empty committees, JSON serialization, and CSV headers. All tests pass with no regressions.
  </done>
</task>

</tasks>

<verification>
- `cargo test --workspace` -- all tests pass
- `cargo clippy --workspace` -- no warnings
- `capitoltraders politicians --help` shows --db flag
- DbPoliticianRow includes committees Vec populated from politician_committees JOIN
- All 5 output formats render committee data
- Unsupported filters on --db path produce clear error messages
</verification>

<success_criteria>
- `capitoltraders politicians --db trades.db` works and shows politicians with committee data
- `capitoltraders politicians --db trades.db --output json` includes committees array per politician
- `capitoltraders politicians --db trades.db --output csv` includes Committees header and data
- `capitoltraders politicians --db trades.db --output md` renders committee column in markdown table
- `capitoltraders politicians --db trades.db --output xml` includes <committees><committee>...</committee></committees> structure
- query_politicians() supports filtering by party, state, name, chamber
- Unsupported filters (--committee, --issuer-id) bail with helpful message on --db path
- All new and existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-politician-enrichment/04-03-SUMMARY.md`
</output>
