---
phase: 15-performance-scoring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - capitoltraders_lib/src/db.rs
autonomous: true

must_haves:
  truths:
    - "DB method returns stock trades with benchmark_price and gics_sector for analytics processing"
    - "Query filters to stock assets with non-null estimated_shares and trade_date_price"
    - "Results ordered chronologically (tx_date ASC, tx_id ASC) for deterministic FIFO"
    - "gics_sector presence indicates whether benchmark_price is sector ETF or SPY"
  artifacts:
    - path: "capitoltraders_lib/src/db.rs"
      provides: "Analytics trade query method and row type"
      contains: "query_trades_for_analytics"
  key_links:
    - from: "capitoltraders_lib/src/db.rs"
      to: "trades table + issuers table"
      via: "SQL JOIN with asset_type filter"
      pattern: "query_trades_for_analytics"
---

<objective>
Add a DB query method that returns enriched trade data suitable for analytics processing: stock trades with benchmark prices and sector information.

Purpose: The analytics CLI command needs trade data that includes benchmark_price and gics_sector (to determine benchmark type). The existing query_trades_for_portfolio returns TradeFIFO without these fields. A new query method extends the same pattern with additional columns.

Output: New `query_trades_for_analytics()` method and `AnalyticsTradeRow` type in db.rs.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@capitoltraders_lib/src/db.rs
@capitoltraders_lib/src/portfolio.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AnalyticsTradeRow type and query_trades_for_analytics DB method</name>
  <files>capitoltraders_lib/src/db.rs</files>
  <action>
    Add a new struct `AnalyticsTradeRow` near the existing `BenchmarkEnrichmentRow` and `PriceEnrichmentRow` definitions. Fields:
    - tx_id: i64
    - politician_id: String
    - issuer_ticker: String
    - tx_type: String
    - tx_date: String
    - estimated_shares: f64
    - trade_date_price: f64
    - benchmark_price: Option<f64>
    - gics_sector: Option<String>

    Derive Debug, Clone on AnalyticsTradeRow.

    Add `pub fn query_trades_for_analytics(&self) -> Result<Vec<AnalyticsTradeRow>, DbError>` method to the Db impl block, near the existing `query_trades_for_portfolio()` method. The SQL query follows the exact same pattern as `query_trades_for_portfolio` but adds benchmark_price from trades and gics_sector from issuers:

    ```sql
    SELECT t.tx_id, t.politician_id, i.issuer_ticker, t.tx_type, t.tx_date,
           t.estimated_shares, t.trade_date_price, t.benchmark_price, i.gics_sector
    FROM trades t
    JOIN issuers i ON t.issuer_id = i.issuer_id
    JOIN assets a ON t.asset_id = a.asset_id
    WHERE t.estimated_shares IS NOT NULL
      AND t.trade_date_price IS NOT NULL
      AND a.asset_type = 'stock'
    ORDER BY t.tx_date ASC, t.tx_id ASC
    ```

    Important: This query intentionally does NOT filter on benchmark_price IS NOT NULL. Trades without benchmark prices are still needed for FIFO matching -- they just won't have alpha metrics. The analytics module handles None benchmark_price gracefully.

    Also add `AnalyticsTradeRow` to the pub use exports in lib.rs (add it to the existing `pub use db::{...}` block).
  </action>
  <verify>
    ```bash
    cargo check -p capitoltraders_lib
    ```
  </verify>
  <done>AnalyticsTradeRow type exists, query_trades_for_analytics compiles and returns trade rows with benchmark_price and gics_sector fields.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for query_trades_for_analytics</name>
  <files>capitoltraders_lib/src/db.rs</files>
  <action>
    Add tests in the existing `#[cfg(test)] mod tests` block in db.rs, following the exact pattern of the existing `test_query_trades_for_portfolio_*` tests. Place them right after those tests.

    Test 1: `test_query_trades_for_analytics_empty`
    - Open test DB, call query_trades_for_analytics(), assert empty vec.

    Test 2: `test_query_trades_for_analytics_includes_benchmark_and_sector`
    - Insert politician, issuer (with gics_sector = 'Information Technology'), stock asset, and a trade with benchmark_price = 150.0
    - Call query_trades_for_analytics()
    - Assert 1 result, verify benchmark_price = Some(150.0), gics_sector = Some("Information Technology")

    Test 3: `test_query_trades_for_analytics_includes_null_benchmark`
    - Insert politician, issuer (no gics_sector), stock asset, and a trade without benchmark_price
    - Call query_trades_for_analytics()
    - Assert 1 result, verify benchmark_price = None, gics_sector = None

    Test 4: `test_query_trades_for_analytics_filters_options`
    - Insert a stock trade and a stock-option trade (asset_type = 'stock-option')
    - Call query_trades_for_analytics()
    - Assert only 1 result (stock trade), stock-option excluded

    Test 5: `test_query_trades_for_analytics_ordering`
    - Insert 3 trades with different tx_dates (out of order)
    - Call query_trades_for_analytics()
    - Assert results ordered by tx_date ASC, tx_id ASC

    Follow the existing test patterns exactly: use open_test_db(), raw SQL INSERT for test data, assert on returned fields. When inserting trades, include the full column list matching the trades table schema (tx_id, politician_id, asset_id, issuer_id, pub_date, filing_date, tx_date, tx_type, has_capital_gains, owner, chamber, value, filing_id, filing_url, reporting_gap, estimated_shares, trade_date_price, benchmark_price).

    For inserting issuer with gics_sector, use:
    ```sql
    INSERT INTO issuers (issuer_id, issuer_name, issuer_ticker, gics_sector)
    VALUES (1, 'Apple Inc.', 'AAPL', 'Information Technology')
    ```
  </action>
  <verify>
    ```bash
    cargo test -p capitoltraders_lib query_trades_for_analytics -- --nocapture
    cargo clippy --workspace -- -D warnings
    ```
  </verify>
  <done>All 5 analytics query tests pass. Tests verify: empty case, benchmark + sector inclusion, null benchmark handling, options filtering, chronological ordering.</done>
</task>

</tasks>

<verification>
```bash
cargo test -p capitoltraders_lib query_trades_for_analytics -- --nocapture
cargo test --workspace
cargo clippy --workspace -- -D warnings
```
All existing 519+ tests still pass. New tests pass. No clippy warnings.
</verification>

<success_criteria>
- AnalyticsTradeRow struct defined with all 9 fields
- query_trades_for_analytics() method compiles and returns correct data
- 5 new tests all pass
- No regression in existing tests
- Type exported via lib.rs pub use block
</success_criteria>

<output>
After completion, create `.planning/phases/15-performance-scoring/15-02-SUMMARY.md`
</output>
