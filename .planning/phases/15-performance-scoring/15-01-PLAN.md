---
phase: 15-performance-scoring
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - capitoltraders_lib/src/analytics.rs
  - capitoltraders_lib/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "FIFO closed trade matching produces ClosedTrade records from chronologically-ordered trades"
    - "Absolute return calculation produces correct percentage from buy/sell prices"
    - "Annualized return returns None for holding periods under 30 days"
    - "Alpha calculation correctly computes excess return vs benchmark"
    - "Politician-level aggregation produces win rate, average return, and average alpha"
    - "Multiple politicians with same ticker are tracked independently"
  artifacts:
    - path: "capitoltraders_lib/src/analytics.rs"
      provides: "Pure analytics calculation module"
      exports: ["AnalyticsTrade", "ClosedTrade", "TradeMetrics", "PoliticianMetrics", "calculate_closed_trades", "compute_trade_metrics", "aggregate_politician_metrics", "absolute_return", "annualized_return", "holding_period_days", "simple_alpha"]
      min_lines: 200
    - path: "capitoltraders_lib/src/lib.rs"
      provides: "Module registration and public re-exports"
      contains: "pub mod analytics"
  key_links:
    - from: "capitoltraders_lib/src/analytics.rs"
      to: "capitoltraders_lib/src/portfolio.rs"
      via: "Same FIFO matching pattern (VecDeque lots, EPSILON comparisons)"
      pattern: "VecDeque.*Lot"
    - from: "capitoltraders_lib/src/lib.rs"
      to: "capitoltraders_lib/src/analytics.rs"
      via: "pub mod analytics + pub use re-exports"
      pattern: "pub mod analytics"
---

<objective>
Create a pure Rust analytics module with FIFO closed trade matching and performance metric calculations via TDD.

Purpose: This module provides the core computation layer for Phase 15. By separating pure calculation functions from DB and CLI concerns, we get testable, composable logic. TDD ensures correctness of financial formulas before integration.

Output: `capitoltraders_lib/src/analytics.rs` with tested functions for closed trade matching, absolute/annualized return, alpha, holding period, and politician-level aggregation.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-performance-scoring/15-RESEARCH.md
@capitoltraders_lib/src/portfolio.rs
@capitoltraders_lib/src/lib.rs
</context>

<feature>
  <name>Analytics Calculation Module (TDD)</name>
  <files>capitoltraders_lib/src/analytics.rs, capitoltraders_lib/src/lib.rs</files>
  <behavior>
    The analytics module provides two layers of computation:

    **Layer 1: FIFO Closed Trade Matching**
    Extends the portfolio.rs FIFO pattern to emit ClosedTrade records when sells match against buy lots.

    Input type (AnalyticsTrade):
    - tx_id: i64
    - politician_id: String
    - ticker: String
    - tx_type: String ("buy", "sell", "receive", "exchange")
    - tx_date: String (YYYY-MM-DD)
    - estimated_shares: f64
    - trade_date_price: f64
    - benchmark_price: Option<f64> (SPY or sector ETF price on trade date)
    - has_sector_benchmark: bool (true if benchmark_price is sector ETF, false if SPY)

    Output (ClosedTrade):
    - politician_id: String
    - ticker: String
    - shares: f64
    - buy_price: f64
    - sell_price: f64
    - buy_date: String
    - sell_date: String
    - buy_benchmark: Option<f64>
    - sell_benchmark: Option<f64>
    - buy_has_sector: bool
    - sell_has_sector: bool

    Cases:
    - buy(100 @ $50) then sell(100 @ $75) -> 1 ClosedTrade(shares=100, buy=50, sell=75)
    - buy(100 @ $40), buy(100 @ $60), sell(150 @ $80) -> 2 ClosedTrades (100 shares from first lot, 50 from second)
    - buy(100 @ $50), sell(100 @ $30) -> 1 ClosedTrade (losing trade)
    - exchange -> skip (no-op, same as portfolio.rs)
    - sell without prior buy -> warning, skip (same as portfolio.rs)
    - Two politicians buying same ticker -> independent tracking, no cross-contamination

    **Layer 2: Metric Calculations**

    Pure functions (no state, no IO):

    absolute_return(buy_price: f64, sell_price: f64) -> f64
    - (50.0, 75.0) -> 50.0 (percent)
    - (100.0, 80.0) -> -20.0
    - (50.0, 50.0) -> 0.0

    holding_period_days(buy_date: &str, sell_date: &str) -> Option<i64>
    - ("2024-01-01", "2024-07-01") -> Some(182)
    - ("2024-01-01", "2024-01-01") -> Some(0)
    - ("bad-date", "2024-01-01") -> None

    annualized_return(absolute_return_pct: f64, holding_days: i64) -> Option<f64>
    - (50.0, 365) -> Some(50.0) (1 year, 50% return annualizes to 50%)
    - (10.0, 182) -> Some(~20.6) (half year, 10% compounds)
    - (5.0, 15) -> None (< 30 days, too short for meaningful annualization)
    - (5.0, 0) -> None
    - (5.0, -1) -> None

    simple_alpha(trade_return_pct: f64, benchmark_return_pct: f64) -> f64
    - (15.0, 10.0) -> 5.0
    - (5.0, 10.0) -> -5.0
    - (10.0, 10.0) -> 0.0

    compute_trade_metrics(closed: &ClosedTrade) -> TradeMetrics
    - Combines the above functions into a single TradeMetrics struct
    - Computes benchmark_return from buy_benchmark/sell_benchmark (if both present)
    - Computes alpha = absolute_return - benchmark_return (if benchmark available)
    - benchmark_type: "sector" if both buy/sell have sector, "spy" if both have spy, None if mixed or missing

    **Layer 3: Politician Aggregation**

    aggregate_politician_metrics(metrics: &[TradeMetrics]) -> Vec<PoliticianMetrics>
    - Groups by politician_id
    - Computes: total_trades, win_count (absolute_return > 0), win_rate, avg_return, avg_alpha_spy, avg_alpha_sector, avg_holding_days
    - Sorts by avg_return descending
    - Computes percentile_rank for each politician using (rank - 1) / (n - 1)
  </behavior>
  <implementation>
    1. Create capitoltraders_lib/src/analytics.rs with module doc comment
    2. Add `pub mod analytics;` to lib.rs and pub use exports
    3. Define types: AnalyticsTrade, ClosedTrade, TradeMetrics, PoliticianMetrics
    4. Implement AnalyticsPosition with FIFO queue (VecDeque) matching portfolio.rs pattern
       - Key difference from portfolio.rs: Position.sell() also records buy lot info (date, price, benchmark) into ClosedTrade
       - Use EPSILON = 0.0001 from portfolio.rs
       - Handle exchange as no-op, unknown tx_type as warning via eprintln
    5. Implement calculate_closed_trades(trades: Vec<AnalyticsTrade>) -> Vec<ClosedTrade>
       - HashMap<(politician_id, ticker), AnalyticsPosition> for partitioning
       - Process trades in order (caller must provide chronological order)
    6. Implement pure metric functions: absolute_return, holding_period_days, annualized_return, simple_alpha
       - Use chrono::NaiveDate for date parsing in holding_period_days
       - annualized_return uses formula: ((1 + r/100)^(1/years) - 1) * 100
       - Minimum 30 days for annualization (return None if < 30)
    7. Implement compute_trade_metrics(closed: &ClosedTrade) -> TradeMetrics
       - benchmark_return: ((sell_benchmark - buy_benchmark) / buy_benchmark) * 100 when both present and buy > 0
       - alpha: absolute_return - benchmark_return when benchmark available
       - benchmark_type: determine from has_sector flags on buy/sell side
    8. Implement aggregate_politician_metrics(metrics: &[TradeMetrics]) -> Vec<PoliticianMetrics>
       - Group by politician_id using HashMap
       - win_rate = (trades with absolute_return > 0.0 / total) * 100
       - avg_alpha_spy: average alpha for trades where benchmark_type is "spy"
       - avg_alpha_sector: average alpha for trades where benchmark_type is "sector"
       - avg_holding_days: average of holding_days (exclude None values)
       - Sort by avg_return descending
       - Compute percentile: (rank - 1) / (total_politicians - 1), handle edge case of 1 politician -> 1.0
  </implementation>
</feature>

<verification>
```bash
cargo test -p capitoltraders_lib analytics -- --nocapture
cargo clippy --workspace -- -D warnings
```
</verification>

<success_criteria>
- analytics.rs exists with all public types and functions
- All TDD tests pass (RED -> GREEN -> REFACTOR complete)
- FIFO matching correctly handles multi-lot sell, partial sell, oversold, exchange, cross-politician isolation
- Pure metric functions produce correct results for all edge cases
- Politician aggregation groups correctly and computes percentile ranks
- cargo clippy clean
</success_criteria>

<output>
After completion, create `.planning/phases/15-performance-scoring/15-01-SUMMARY.md`
</output>
