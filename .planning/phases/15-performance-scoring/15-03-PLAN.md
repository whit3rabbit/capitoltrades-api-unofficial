---
phase: 15-performance-scoring
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - capitoltraders_cli/src/commands/analytics.rs
  - capitoltraders_cli/src/commands/mod.rs
  - capitoltraders_cli/src/main.rs
  - capitoltraders_cli/src/output.rs
autonomous: true

must_haves:
  truths:
    - "User can run 'capitoltraders analytics --db path' to see politician performance rankings"
    - "User can see absolute return, win rate, alpha, and holding period per politician"
    - "User can filter by time period (ytd, 1y, 2y, all)"
    - "User can filter by minimum trade count to exclude low-activity politicians"
    - "User can see percentile rank for each politician"
    - "User can sort by different metrics (return, win-rate, alpha)"
    - "Output supports all 5 formats (table, JSON, CSV, markdown, XML)"
    - "User can filter by party and state"
  artifacts:
    - path: "capitoltraders_cli/src/commands/analytics.rs"
      provides: "Analytics CLI subcommand"
      min_lines: 100
    - path: "capitoltraders_cli/src/output.rs"
      provides: "Leaderboard output formatting (table, CSV, markdown, XML)"
      contains: "print_leaderboard"
    - path: "capitoltraders_cli/src/commands/mod.rs"
      provides: "Module registration"
      contains: "pub mod analytics"
    - path: "capitoltraders_cli/src/main.rs"
      provides: "Command dispatch"
      contains: "Analytics"
  key_links:
    - from: "capitoltraders_cli/src/commands/analytics.rs"
      to: "capitoltraders_lib::analytics"
      via: "calculate_closed_trades, compute_trade_metrics, aggregate_politician_metrics"
      pattern: "calculate_closed_trades|compute_trade_metrics|aggregate_politician_metrics"
    - from: "capitoltraders_cli/src/commands/analytics.rs"
      to: "capitoltraders_lib::Db"
      via: "query_trades_for_analytics"
      pattern: "query_trades_for_analytics"
    - from: "capitoltraders_cli/src/main.rs"
      to: "capitoltraders_cli/src/commands/analytics.rs"
      via: "Commands::Analytics dispatch"
      pattern: "Commands::Analytics"
---

<objective>
Create the analytics CLI subcommand that wires DB queries, FIFO matching, metric calculation, and output formatting into a user-facing leaderboard command.

Purpose: This is the user-visible surface of Phase 15. Users run `capitoltraders analytics --db path/to/db.sqlite` to see politician performance rankings. The command queries enriched trade data, runs FIFO closed trade matching, computes performance metrics, aggregates by politician, and displays ranked results.

Output: Working `analytics` CLI subcommand with filtering (time period, min trades, party, state, sort-by) and all 5 output formats.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-performance-scoring/15-01-SUMMARY.md
@.planning/phases/15-performance-scoring/15-02-SUMMARY.md
@capitoltraders_cli/src/commands/portfolio.rs
@capitoltraders_cli/src/commands/donations.rs
@capitoltraders_cli/src/commands/mod.rs
@capitoltraders_cli/src/main.rs
@capitoltraders_cli/src/output.rs
@capitoltraders_lib/src/analytics.rs
@capitoltraders_lib/src/db.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics CLI subcommand and wire into main</name>
  <files>
    capitoltraders_cli/src/commands/analytics.rs
    capitoltraders_cli/src/commands/mod.rs
    capitoltraders_cli/src/main.rs
  </files>
  <action>
    **1. Create capitoltraders_cli/src/commands/analytics.rs**

    Follow the pattern from portfolio.rs and donations.rs. Define:

    ```rust
    #[derive(Args)]
    pub struct AnalyticsArgs {
        /// SQLite database path (required)
        #[arg(long)]
        pub db: PathBuf,

        /// Time period filter: ytd, 1y, 2y, all (default: all)
        #[arg(long, default_value = "all")]
        pub period: String,

        /// Minimum closed trades for inclusion (default: 5)
        #[arg(long, default_value = "5")]
        pub min_trades: usize,

        /// Sort by metric: return, win-rate, alpha (default: return)
        #[arg(long, default_value = "return")]
        pub sort_by: String,

        /// Filter by party: democrat (d), republican (r)
        #[arg(long)]
        pub party: Option<String>,

        /// Filter by state (e.g., CA, TX)
        #[arg(long)]
        pub state: Option<String>,

        /// Number of results to show (default: 25)
        #[arg(long, default_value = "25")]
        pub top: usize,
    }
    ```

    Implement `pub fn run(args: &AnalyticsArgs, format: &OutputFormat) -> Result<()>`:

    a. Open DB: `let db = Db::open(&args.db)?;`

    b. Validate filters:
       - period: match against "ytd", "1y", "2y", "all" (case-insensitive). Bail with helpful message on invalid.
       - sort_by: match against "return", "win-rate", "alpha". Bail on invalid.
       - party: if present, validate via `validation::validate_party()`
       - state: if present, validate via `validation::validate_state()`

    c. Query trades: `let trade_rows = db.query_trades_for_analytics()?;`
       - If empty, print hint: "No enriched stock trades found. Run `capitoltraders sync --db ...` then `capitoltraders enrich-prices --db ...` first."
       - Return Ok(())

    d. Convert DB rows to analytics input: Map each AnalyticsTradeRow to AnalyticsTrade.
       - has_sector_benchmark: true if gics_sector.is_some() AND benchmark_price.is_some()
       - When gics_sector is None, benchmark_price (if present) is SPY

    e. Run FIFO matching: `let closed_trades = calculate_closed_trades(analytics_trades);`

    f. Compute per-trade metrics: `let trade_metrics: Vec<TradeMetrics> = closed_trades.iter().map(compute_trade_metrics).collect();`

    g. Apply time period filter: Filter trade_metrics by sell_date.
       - Parse sell_date as NaiveDate
       - "ytd": sell_date >= Jan 1 of current year (use chrono::Local::now().naive_local().date() to get current year)
       - "1y": sell_date >= today - 365 days
       - "2y": sell_date >= today - 730 days
       - "all": no filter

    h. Aggregate: `let mut politician_metrics = aggregate_politician_metrics(&filtered_metrics);`

    i. Apply politician-level filters:
       - min_trades: retain only politicians with total_trades >= args.min_trades
       - party: if specified, need to look up politician party from DB. Use a separate query: `SELECT politician_id, party FROM politicians` into a HashMap. Filter politician_metrics to those matching party.
       - state: same approach, filter by state_id.
       - After filtering, re-compute percentile ranks (since the pool changed).

    j. Sort by selected metric:
       - "return": sort by avg_return descending (already default from aggregate)
       - "win-rate": sort by win_rate descending
       - "alpha": sort by avg_alpha descending (prefer spy alpha, fall back to sector)

    k. Truncate to args.top results.

    l. Build LeaderboardRow vec for output (enrich with politician name, party, state from DB):
       ```rust
       pub struct LeaderboardRow {
           pub rank: usize,
           pub politician_name: String,
           pub party: String,
           pub state: String,
           pub total_trades: usize,
           pub win_rate: f64,
           pub avg_return: f64,
           pub avg_alpha: Option<f64>,
           pub avg_holding_days: Option<f64>,
           pub percentile: f64,
       }
       ```
       Query politician info: SELECT politician_id, first_name, last_name, party, state_id FROM politicians into HashMap.
       Map politician_metrics to LeaderboardRow with rank = index + 1.

    m. Dispatch to output formatter (same pattern as donations.rs):
       ```rust
       match format {
           OutputFormat::Table => print_leaderboard_table(&rows),
           OutputFormat::Json => print_json(&rows),
           OutputFormat::Csv => print_leaderboard_csv(&rows)?,
           OutputFormat::Markdown => print_leaderboard_markdown(&rows),
           OutputFormat::Xml => print_leaderboard_xml(&rows),
       }
       ```

    n. Print summary line to stderr:
       `eprintln!("Showing {}/{} politicians ({} closed trades analyzed, period: {})", rows.len(), total_politicians, total_trades, args.period);`

    **2. Register in mod.rs**
    Add `pub mod analytics;` to capitoltraders_cli/src/commands/mod.rs.

    **3. Wire in main.rs**
    Add to Commands enum:
    ```rust
    /// View politician performance rankings and analytics
    Analytics(commands::analytics::AnalyticsArgs),
    ```

    Add dispatch in match block (follows Portfolio pattern -- no Box needed unless clippy warns):
    ```rust
    Commands::Analytics(args) => commands::analytics::run(args, &format)?,
    ```

    **Important notes:**
    - Use `Serialize` derive on LeaderboardRow for JSON output via print_json
    - For politician name lookup, keep it simple: single query into HashMap at start of run(), not per-row
    - Do NOT use SQL window functions -- all aggregation and ranking happens in Rust via the analytics module
    - The analytics command is DB-only (no scrape mode), same as portfolio and donations
  </action>
  <verify>
    ```bash
    cargo check --workspace
    cargo run -p capitoltraders_cli -- analytics --help
    ```
  </verify>
  <done>
    `capitoltraders analytics --help` shows all flags (db, period, min-trades, sort-by, party, state, top).
    The command compiles and can be invoked.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add leaderboard output formatters</name>
  <files>capitoltraders_cli/src/output.rs</files>
  <action>
    Add 4 output functions for LeaderboardRow, following the exact pattern of existing print_portfolio_* and print_donations_* functions. Place them after the donation output functions at the end of the file.

    Import LeaderboardRow at the top of output.rs (add to the existing use block from the commands module or define the type in a shared location -- since LeaderboardRow is defined in analytics.rs, import it: `use crate::commands::analytics::LeaderboardRow;`).

    **print_leaderboard_table(rows: &[LeaderboardRow])**
    Use tabled crate (already used for all other table outputs). Columns:
    - Rank (#)
    - Politician (name)
    - Party (D/R)
    - State
    - Trades (total_trades)
    - Win Rate (formatted as "XX.X%")
    - Avg Return (formatted as "+XX.X%" or "-XX.X%")
    - Alpha (formatted as "+XX.X%" or "N/A" if None)
    - Avg Hold (formatted as "XX days" or "N/A")
    - Pctl (percentile as "XX%")

    Follow the existing Tabled pattern: implement tabled::Tabled trait or use Builder. Match the style used by print_portfolio_table.

    **print_leaderboard_csv(rows: &[LeaderboardRow]) -> Result<()>**
    Headers: rank,politician,party,state,trades,win_rate,avg_return,alpha,avg_holding_days,percentile
    Use csv::Writer following existing patterns. Apply sanitize_csv_field to politician name (user-generated content). Format numbers to 2 decimal places.

    **print_leaderboard_markdown(rows: &[LeaderboardRow])**
    Markdown table with same columns as table output. Follow print_portfolio_markdown pattern with header row and separator.

    **print_leaderboard_xml(rows: &[LeaderboardRow])**
    Follow print_portfolio_xml pattern. Root element: `<leaderboard>`, row element: `<politician>`.

    **Note:** JSON output uses the existing generic `print_json` function (already works with any Serialize type). No new JSON function needed.

    All formatters handle the empty case gracefully (print header only or empty element).
  </action>
  <verify>
    ```bash
    cargo check --workspace
    cargo clippy --workspace -- -D warnings
    ```
  </verify>
  <done>
    All 4 leaderboard output functions compile. print_leaderboard_table shows formatted columns.
    print_leaderboard_csv writes valid CSV. print_leaderboard_markdown produces valid markdown table.
    print_leaderboard_xml produces valid XML.
  </done>
</task>

</tasks>

<verification>
```bash
cargo check --workspace
cargo test --workspace
cargo clippy --workspace -- -D warnings
cargo run -p capitoltraders_cli -- analytics --help
```

The analytics --help output should show:
- --db (required)
- --period (default: all, options: ytd/1y/2y/all)
- --min-trades (default: 5)
- --sort-by (default: return, options: return/win-rate/alpha)
- --party (optional)
- --state (optional)
- --top (default: 25)
</verification>

<success_criteria>
- `capitoltraders analytics --db test.db` runs without error (shows empty result hint or actual rankings)
- All 5 output formats work (table, JSON, CSV, markdown, XML)
- Time period filter correctly limits to ytd/1y/2y/all
- Min-trades filter excludes politicians below threshold
- Party and state filters work
- Sort-by changes ordering (return vs win-rate vs alpha)
- Percentile rank displayed for each politician
- All existing tests pass (no regression)
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/15-performance-scoring/15-03-SUMMARY.md`
</output>
