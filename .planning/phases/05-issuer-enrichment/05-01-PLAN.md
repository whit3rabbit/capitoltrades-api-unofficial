---
phase: 05-issuer-enrichment
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - capitoltraders_lib/tests/fixtures/issuer_detail_with_performance.html
  - capitoltraders_lib/tests/fixtures/issuer_detail_no_performance.html
  - capitoltraders_lib/src/db.rs
  - capitoltraders_lib/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "issuer_detail() extracts performance data (mcap, trailing returns, EOD prices) from a fixture with performance"
    - "issuer_detail() gracefully handles a fixture without performance data (returns None)"
    - "update_issuer_detail() persists performance rows to issuer_performance table and EOD prices to issuer_eod_prices table"
    - "update_issuer_detail() sets enriched_at so the issuer leaves the unenriched queue"
    - "count_unenriched_issuers() returns the correct count of issuers needing enrichment"
  artifacts:
    - path: "capitoltraders_lib/tests/fixtures/issuer_detail_with_performance.html"
      provides: "Synthetic HTML fixture with full performance and EOD price data"
    - path: "capitoltraders_lib/tests/fixtures/issuer_detail_no_performance.html"
      provides: "Synthetic HTML fixture for issuer without market data (performance: null)"
    - path: "capitoltraders_lib/src/db.rs"
      provides: "update_issuer_detail(), count_unenriched_issuers() methods"
      contains: "fn update_issuer_detail"
  key_links:
    - from: "capitoltraders_lib/src/scrape.rs"
      to: "issuer_detail_with_performance.html"
      via: "extract_rsc_payload + extract_json_object_after"
      pattern: "issuerData"
    - from: "capitoltraders_lib/src/db.rs"
      to: "issuer_performance table"
      via: "update_issuer_detail unchecked_transaction"
      pattern: "INSERT INTO issuer_performance"
---

<objective>
Create synthetic HTML fixtures for issuer detail pages and add DB persistence methods for issuer enrichment data.

Purpose: Establish the extraction + persistence layer that the sync pipeline (05-02) and CLI output (05-03) will build on. Test that the existing issuer_detail() scraper correctly extracts performance and EOD data from RSC payloads, and that update_issuer_detail() correctly writes to issuer_performance and issuer_eod_prices tables.

Output: 2 HTML fixtures, update_issuer_detail() and count_unenriched_issuers() methods in db.rs, fixture-based extraction tests and DB persistence tests.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-issuer-enrichment/05-RESEARCH.md
@.planning/phases/02-trade-extraction/02-01-SUMMARY.md
@.planning/phases/02-trade-extraction/02-02-SUMMARY.md

Key source files to reference:
@capitoltraders_lib/src/scrape.rs (issuer_detail method at line ~268, ScrapedIssuerDetail, extract_json_object_after)
@capitoltraders_lib/src/db.rs (upsert_issuers at line ~661 for performance/EOD SQL pattern, update_trade_detail for unchecked_transaction pattern, get_unenriched_issuer_ids at line ~973)
@capitoltraders_cli/src/commands/issuers.rs (scraped_issuer_detail_to_detail at line ~184, normalize_performance at line ~206 for field names)
@capitoltrades_api/src/types/issuer.rs (IssuerDetail, Performance, EodPrice, Stats types)
@schema/sqlite.sql (issuer_performance and issuer_eod_prices table schemas at lines 107-137)
@capitoltraders_lib/tests/fixtures/ (existing trade detail fixtures for structural reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create synthetic fixtures and fixture-based extraction tests</name>
  <files>
    capitoltraders_lib/tests/fixtures/issuer_detail_with_performance.html
    capitoltraders_lib/tests/fixtures/issuer_detail_no_performance.html
    capitoltraders_lib/src/scrape.rs
  </files>
  <action>
1. Create `issuer_detail_with_performance.html` -- a synthetic HTML page modeling the RSC payload structure for an issuer with full performance data. Structure:
   - Use `self.__next_f.push([1,"..."])` script tags matching existing fixture patterns
   - Embed `"issuerData":{ ... }` JSON with:
     - `_issuerId`: 12345
     - `_stateId`: "ca"
     - `c2iq`: "AAPL"
     - `country`: "us"
     - `issuerName`: "Apple Inc."
     - `issuerTicker`: "AAPL"
     - `sector`: "information-technology"
     - `stats`: `{ "countTrades": 450, "countPoliticians": 85, "volume": 25000000, "dateLastTraded": "2026-01-10" }`
     - `performance`: full object with all 20 fields:
       - mcap: 3500000000000 (i64)
       - trailing1, trailing1Change, trailing7, trailing7Change, trailing30, trailing30Change, trailing90, trailing90Change, trailing365, trailing365Change (all f64)
       - wtd, wtdChange, mtd, mtdChange, qtd, qtdChange, ytd, ytdChange (all f64)
       - eodPrices: array of [date_string, price_float] pairs, e.g. `[["2026-01-15", 225.5], ["2026-01-16", 227.3], ["2026-01-17", 228.1]]`
   - IMPORTANT: Study the existing trade detail fixtures for the exact RSC script tag format. The issuerData key must appear inside a `self.__next_f.push` call.

2. Create `issuer_detail_no_performance.html` -- same structure but with `"performance": null`. Use a different issuer (e.g., issuer_id 99999, name "PrivateCo Holdings", no ticker, sector null).

3. Add fixture-based tests in scrape.rs (in the existing `#[cfg(test)] mod tests` block):
   - `test_issuer_detail_with_performance`: Load fixture via include_str!, run through extract_rsc_payload, then use the same extraction logic as issuer_detail() to extract issuerData. Verify:
     - issuer_name == "Apple Inc."
     - issuer_ticker == Some("AAPL")
     - sector == Some("information-technology")
     - performance is Some (not null)
     - stats.count_trades == 450
   - `test_issuer_detail_no_performance`: Load no-performance fixture, verify performance is None, verify issuer_name == "PrivateCo Holdings".
   - `test_issuer_detail_performance_eod_prices`: Load performance fixture, parse performance JSON, verify eodPrices array has 3 entries.

Note: The existing issuer_detail() method uses `extract_json_object_after(payload, "\"issuerData\":")`. The test should mimic this extraction path. Look at existing `test_extract_trade_detail_*` tests for the pattern: include_str fixture -> extract_rsc_payload -> extract function -> assert fields.

If the existing issuer_detail() method is not easily testable with raw HTML (because it does the HTTP fetch internally), create a helper function `parse_issuer_detail(html: &str) -> Result<ScrapedIssuerDetail>` that the test can call, and have issuer_detail() delegate to it after fetching. This matches the pattern from trade detail extraction where extract_trade_detail operates on the payload string.
  </action>
  <verify>
    `cargo test -p capitoltraders_lib issuer_detail -- --nocapture` passes with all 3 new fixture-based tests green.
  </verify>
  <done>
    Synthetic fixtures exist and issuer_detail extraction is tested against both performance and no-performance variants. EOD price array extraction is verified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add update_issuer_detail and count_unenriched_issuers DB methods with tests</name>
  <files>
    capitoltraders_lib/src/db.rs
    capitoltraders_lib/src/lib.rs
  </files>
  <action>
1. Add `count_unenriched_issuers(&self) -> Result<i64, DbError>` to Db in db.rs:
   - `SELECT COUNT(*) FROM issuers WHERE enriched_at IS NULL`
   - Simple single-value query, same pattern as count_unenriched_trades().

2. Add `update_issuer_detail(&self, issuer_id: i64, detail: &ScrapedIssuerDetail) -> Result<(), DbError>` to Db in db.rs:
   - Use `self.conn.unchecked_transaction()` for &self (matching update_trade_detail pattern).
   - Step 1: UPDATE issuers base row -- set state_id, c2iq, country, issuer_name, issuer_ticker, sector using COALESCE (don't overwrite non-null values with null), and SET enriched_at = datetime('now').
   - Step 2: UPSERT issuer_stats -- INSERT OR REPLACE with count_trades, count_politicians, volume, date_last_traded from detail.stats.
   - Step 3: Parse performance JSON. Use the normalize_performance() logic inline (check all 20 required fields are non-null). If performance is valid:
     a. INSERT OR REPLACE INTO issuer_performance with all 20 columns (mcap, trailing1, trailing1_change, ..., ytd, ytd_change). Extract each field from the serde_json::Value object using .get("fieldName") and .as_f64() / .as_i64().
     b. DELETE FROM issuer_eod_prices WHERE issuer_id = ?1 (clear old prices).
     c. Parse eodPrices array. Each entry is a 2-element array: [date_string_or_float, price_float]. Use the same eod_pair() logic from upsert_issuers -- the array elements can be either strings or floats (DbEodValue untagged enum). For each valid (date, price) pair, INSERT INTO issuer_eod_prices.
     - IMPORTANT: Study the existing eod_pair() helper function and DbEodValue enum in db.rs. The EOD price structure is `Vec<Vec<DbEodValue>>` where DbEodValue is an untagged enum of NaiveDate or f64. The eod_pair function extracts (NaiveDate, f64) from each inner vec.
   - Step 4: If performance is None/null, DELETE existing issuer_performance and issuer_eod_prices rows for this issuer (clean up stale data if re-enriched).
   - Step 5: tx.commit().

3. Re-export ScrapedIssuerDetail from lib.rs if not already exported (check existing re-exports).

4. Add tests in the `#[cfg(test)] mod tests` block of db.rs:
   - `test_update_issuer_detail_with_performance`: Create test DB, insert a bare issuer row (via upsert_issuers with a minimal IssuerDetail), then call update_issuer_detail with a ScrapedIssuerDetail that has performance data. Verify: enriched_at is set, issuer_performance row exists with correct mcap and trailing values, issuer_eod_prices rows exist with correct dates and prices.
   - `test_update_issuer_detail_no_performance`: Same but with performance: None. Verify enriched_at is still set, no issuer_performance row, no issuer_eod_prices rows.
   - `test_update_issuer_detail_preserves_existing_fields`: Insert an issuer with sector "financials", then call update_issuer_detail with sector: None. Verify sector is still "financials" (COALESCE protection).
   - `test_count_unenriched_issuers`: Insert 3 issuers, enrich 1, verify count returns 2.
   - `test_update_issuer_detail_replaces_eod_prices`: Enrich once with 3 EOD prices, enrich again with 2 different EOD prices. Verify only 2 EOD prices remain (DELETE + INSERT pattern).

For constructing test ScrapedIssuerDetail values, build them directly from the struct fields. Reference the ScrapedIssuerDetail definition in scrape.rs for the field names.
  </action>
  <verify>
    `cargo test -p capitoltraders_lib update_issuer_detail -- --nocapture` and `cargo test -p capitoltraders_lib count_unenriched_issuers -- --nocapture` pass. Then `cargo test --workspace` confirms no regressions.
  </verify>
  <done>
    update_issuer_detail() persists performance + EOD data and sets enriched_at. count_unenriched_issuers() correctly counts the queue. All 5 tests pass. No regressions in the 271-test workspace.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p capitoltraders_lib issuer_detail` -- fixture-based extraction tests pass
2. `cargo test -p capitoltraders_lib update_issuer_detail` -- DB persistence tests pass
3. `cargo test -p capitoltraders_lib count_unenriched_issuers` -- count test passes
4. `cargo test --workspace` -- all existing tests still pass (no regressions)
5. `cargo clippy --workspace` -- no new warnings
</verification>

<success_criteria>
- 2 synthetic HTML fixtures exist and correctly model issuer detail RSC payload structure
- issuer_detail() extraction is tested for both performance and no-performance variants
- update_issuer_detail() writes performance to issuer_performance table (20 columns) and EOD prices to issuer_eod_prices table
- update_issuer_detail() sets enriched_at timestamp so issuers leave the unenriched queue
- count_unenriched_issuers() returns accurate count
- All new tests pass, all existing 271 workspace tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-issuer-enrichment/05-01-SUMMARY.md`
</output>
