---
phase: 05-issuer-enrichment
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - capitoltraders_cli/src/commands/sync.rs
autonomous: true

must_haves:
  truths:
    - "Running sync --enrich triggers issuer enrichment after trade enrichment"
    - "Issuer enrichment respects --batch-size and --dry-run flags"
    - "Progress is reported to stderr during issuer enrichment (every 50 issuers)"
    - "Issuers that fail to fetch are logged but do not abort the run"
  artifacts:
    - path: "capitoltraders_cli/src/commands/sync.rs"
      provides: "enrich_issuers() async function and wiring into run()"
      contains: "async fn enrich_issuers"
  key_links:
    - from: "capitoltraders_cli/src/commands/sync.rs"
      to: "capitoltraders_lib/src/db.rs"
      via: "db.update_issuer_detail() and db.count_unenriched_issuers()"
      pattern: "update_issuer_detail"
    - from: "capitoltraders_cli/src/commands/sync.rs"
      to: "capitoltraders_lib/src/scrape.rs"
      via: "scraper.issuer_detail(issuer_id)"
      pattern: "issuer_detail"
---

<objective>
Wire issuer enrichment into the sync pipeline so that `sync --enrich` triggers both trade and issuer enrichment.

Purpose: After this plan, running `sync --enrich` populates issuer_performance and issuer_eod_prices tables from issuer detail pages, completing the data pipeline before CLI output (05-03) surfaces the data.

Output: enrich_issuers() function in sync.rs, wired into run() after trade enrichment.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-issuer-enrichment/05-RESEARCH.md
@.planning/phases/03-trade-sync-and-output/03-01-SUMMARY.md (enrich_trades pattern)
@.planning/phases/04-politician-enrichment/04-02-SUMMARY.md (enrich_politician_committees pattern)

Key source files:
@capitoltraders_cli/src/commands/sync.rs (enrich_trades at line ~163, enrich_politician_committees at line ~240, run() at line ~63, SyncArgs struct, EnrichmentResult struct)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enrich_issuers function and wire into sync run</name>
  <files>capitoltraders_cli/src/commands/sync.rs</files>
  <action>
1. Add `async fn enrich_issuers(scraper: &ScrapeClient, db: &Db, batch_size: Option<i64>, detail_delay_ms: u64, dry_run: bool) -> Result<EnrichmentResult>` in sync.rs, after the existing enrich_trades function. Follow the exact same structure as enrich_trades:

   a. **Dry-run path:** If dry_run, call `db.count_unenriched_issuers()`, compute selected count as min(batch_size, total), print message to stderr: `"{total} issuers would be enriched ({selected} selected)"`, return EnrichmentResult with enriched=0.

   b. **Queue fetch:** Call `db.get_unenriched_issuer_ids(batch_size)`. If empty, print `"No issuers need enrichment"` and return early.

   c. **Enrichment loop:** For each issuer_id in queue:
      - Call `scraper.issuer_detail(issuer_id).await`
      - On success: call `db.update_issuer_detail(issuer_id, &detail)?`, increment enriched counter
      - On error: log warning to stderr `"  Warning: issuer {issuer_id} failed: {err}"`, increment failed counter
      - Apply throttle delay between requests (skip after last item)
      - Progress reporting every 50 items AND at completion: `"  Progress: {i+1}/{total} ({enriched} enriched, {failed} failed)"`

   d. Return EnrichmentResult { enriched, skipped: 0, failed, total: queue.len() }.

2. Wire into run() -- add issuer enrichment call AFTER the existing trade enrichment block (inside the `if should_enrich { ... }` block), but BEFORE the politician committee enrichment. Specifically:

   ```
   if should_enrich {
       // existing trade enrichment ...

       // NEW: issuer enrichment
       let issuer_result = enrich_issuers(
           &scraper,
           &db,
           args.batch_size,
           args.details_delay_ms,
           args.dry_run,
       ).await?;
       eprintln!(
           "Issuer enrichment: {}/{} issuers processed ({} failed)",
           issuer_result.enriched, issuer_result.total, issuer_result.failed
       );
   }
   ```

   The order is: trade sync -> trade enrichment -> issuer enrichment -> politician committee enrichment. This makes sense because trades create issuer references, so enriching issuers after trades ensures all relevant issuers are in the DB.

3. Update the `--enrich` arg help text from "Enrich trade details after sync (fetches individual trade pages)" to "Enrich trade and issuer details after sync (fetches individual detail pages)".

4. Update the `--batch-size` arg help text from "Maximum trades to enrich per run (default: all)" to "Maximum items to enrich per run (default: all)" since it now applies to both trades and issuers.

5. Update the `--dry-run` help text from "Show how many trades would be enriched without fetching" to "Show how many items would be enriched without fetching".

Note: The `--batch-size` parameter is shared between trade and issuer enrichment. Each enrichment pass gets its own batch_size limit independently. If batch_size is 50, up to 50 trades AND up to 50 issuers will be enriched in one run.

Do NOT add any new SyncArgs fields. Reuse existing --enrich, --dry-run, --batch-size, --details-delay-ms flags.
  </action>
  <verify>
    `cargo check -p capitoltraders_cli` compiles without errors. `cargo clippy --workspace` has no new warnings. `cargo test --workspace` passes all existing tests (this plan adds no new tests since the enrichment function requires network access for meaningful integration testing; the DB methods it calls are tested in 05-01).
  </verify>
  <done>
    `sync --enrich` triggers issuer enrichment after trade enrichment. Dry-run reports issuer count. Batch-size limits issuer enrichment. Progress reports every 50 issuers. Failed issuers are logged but do not abort. All 271+ workspace tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p capitoltraders_cli` -- compiles cleanly
2. `cargo clippy --workspace` -- no new warnings
3. `cargo test --workspace` -- all tests pass (no regressions)
4. Manual review: enrich_issuers function signature matches enrich_trades pattern
5. Manual review: run() calls enrich_issuers inside should_enrich block after trade enrichment
</verification>

<success_criteria>
- enrich_issuers() exists in sync.rs with the same structure as enrich_trades()
- --enrich flag triggers both trade and issuer enrichment
- --dry-run reports both trade and issuer counts
- --batch-size limits both trade and issuer enrichment independently
- All existing tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-issuer-enrichment/05-02-SUMMARY.md`
</output>
