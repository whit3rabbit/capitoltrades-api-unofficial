---
phase: 05-issuer-enrichment
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - capitoltraders_lib/src/db.rs
  - capitoltraders_lib/src/lib.rs
  - capitoltraders_cli/src/commands/issuers.rs
  - capitoltraders_cli/src/main.rs
  - capitoltraders_cli/src/output.rs
  - capitoltraders_cli/src/xml_output.rs
  - capitoltraders_cli/src/output_tests.rs
autonomous: true

must_haves:
  truths:
    - "Running `capitoltraders issuers --db` displays enriched issuers with performance metrics from SQLite"
    - "Table output shows Name, Ticker, Sector, Mcap, Trailing 30D, Trades, Volume, Last Traded columns"
    - "JSON output includes all performance fields (mcap, all trailing/period returns)"
    - "CSV output includes all performance fields as columns"
    - "Markdown and XML output render correctly with performance data"
    - "Filters --search, --sector, --state, --country work on the DB path"
    - "Issuers without performance data show dashes or empty values (not 'null' or crashes)"
  artifacts:
    - path: "capitoltraders_lib/src/db.rs"
      provides: "DbIssuerRow, DbIssuerFilter, query_issuers() method"
      contains: "fn query_issuers"
    - path: "capitoltraders_cli/src/commands/issuers.rs"
      provides: "--db flag and run_db() function"
      contains: "fn run_db"
    - path: "capitoltraders_cli/src/output.rs"
      provides: "DbIssuerOutputRow and print_db_issuers_* functions"
      contains: "fn print_db_issuers_table"
    - path: "capitoltraders_cli/src/xml_output.rs"
      provides: "db_issuers_to_xml() function"
      contains: "fn db_issuers_to_xml"
  key_links:
    - from: "capitoltraders_cli/src/commands/issuers.rs"
      to: "capitoltraders_lib/src/db.rs"
      via: "db.query_issuers(&filter)"
      pattern: "query_issuers"
    - from: "capitoltraders_cli/src/output.rs"
      to: "capitoltraders_lib/src/db.rs"
      via: "DbIssuerRow fields mapped to DbIssuerOutputRow"
      pattern: "DbIssuerOutputRow"
---

<objective>
Add the `--db` flag to the issuers command with full output support (table, json, csv, md, xml) for enriched issuer data including performance metrics.

Purpose: This is the user-facing output layer for Phase 5. After this plan, users can query enriched issuers from SQLite and see market cap, trailing returns, and trade statistics in all output formats.

Output: query_issuers() DB method, --db flag on issuers command, DbIssuerOutputRow for all 5 output formats, tests.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-issuer-enrichment/05-RESEARCH.md
@.planning/phases/03-trade-sync-and-output/03-02-SUMMARY.md (query_trades + DbTradeRow pattern)
@.planning/phases/03-trade-sync-and-output/03-03-SUMMARY.md (trades --db CLI output pattern)
@.planning/phases/04-politician-enrichment/04-03-SUMMARY.md (politicians --db CLI output pattern)

Key source files:
@capitoltraders_lib/src/db.rs (DbTradeRow, DbTradeFilter, query_trades at existing lines; DbPoliticianRow, DbPoliticianFilter, query_politicians for pattern reference)
@capitoltraders_lib/src/lib.rs (re-exports for DbTradeRow, DbPoliticianRow, etc.)
@capitoltraders_cli/src/commands/issuers.rs (current issuers command, IssuersArgs struct)
@capitoltraders_cli/src/commands/politicians.rs (--db flag pattern, run_db function, capitalize_party)
@capitoltraders_cli/src/commands/trades.rs (--db flag pattern for reference)
@capitoltraders_cli/src/main.rs (command routing with --db flag)
@capitoltraders_cli/src/output.rs (IssuerRow, print_issuers_table, DbTradeOutputRow, DbPoliticianOutputRow for pattern reference)
@capitoltraders_cli/src/xml_output.rs (db_trades_to_xml, db_politicians_to_xml for pattern reference)
@capitoltraders_cli/src/output_tests.rs (existing DB output tests for pattern reference)
@schema/sqlite.sql (issuer_performance columns at lines 107-129, issuer_stats at lines 96-105)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DbIssuerRow, DbIssuerFilter, query_issuers, --db flag, and output functions</name>
  <files>
    capitoltraders_lib/src/db.rs
    capitoltraders_lib/src/lib.rs
    capitoltraders_cli/src/commands/issuers.rs
    capitoltraders_cli/src/main.rs
    capitoltraders_cli/src/output.rs
    capitoltraders_cli/src/xml_output.rs
  </files>
  <action>
**A. DB layer (db.rs + lib.rs):**

1. Add `DbIssuerRow` struct (derive Debug, Clone, Serialize):
   ```
   pub struct DbIssuerRow {
       pub issuer_id: i64,
       pub issuer_name: String,
       pub issuer_ticker: Option<String>,
       pub sector: Option<String>,
       pub state: Option<String>,
       pub country: Option<String>,
       pub trades: i64,
       pub politicians: i64,
       pub volume: i64,
       pub last_traded: Option<String>,
       pub mcap: Option<i64>,
       pub trailing1: Option<f64>,
       pub trailing1_change: Option<f64>,
       pub trailing7: Option<f64>,
       pub trailing7_change: Option<f64>,
       pub trailing30: Option<f64>,
       pub trailing30_change: Option<f64>,
       pub trailing90: Option<f64>,
       pub trailing90_change: Option<f64>,
       pub trailing365: Option<f64>,
       pub trailing365_change: Option<f64>,
       pub enriched_at: Option<String>,
   }
   ```

2. Add `DbIssuerFilter` struct (derive Debug, Default):
   ```
   pub struct DbIssuerFilter {
       pub search: Option<String>,
       pub sector: Option<Vec<String>>,
       pub state: Option<Vec<String>>,
       pub country: Option<Vec<String>>,
       pub limit: Option<i64>,
   }
   ```

3. Add `query_issuers(&self, filter: &DbIssuerFilter) -> Result<Vec<DbIssuerRow>, DbError>`:
   - SQL query:
     ```sql
     SELECT i.issuer_id, i.issuer_name, i.issuer_ticker, i.sector,
            i.state_id, i.country, i.enriched_at,
            COALESCE(s.count_trades, 0),
            COALESCE(s.count_politicians, 0),
            COALESCE(s.volume, 0),
            s.date_last_traded,
            p.mcap, p.trailing1, p.trailing1_change,
            p.trailing7, p.trailing7_change,
            p.trailing30, p.trailing30_change,
            p.trailing90, p.trailing90_change,
            p.trailing365, p.trailing365_change
     FROM issuers i
     LEFT JOIN issuer_stats s ON i.issuer_id = s.issuer_id
     LEFT JOIN issuer_performance p ON i.issuer_id = p.issuer_id
     WHERE 1=1
     ```
   - Dynamic filter builder (same Vec<Box<dyn ToSql>> pattern as query_trades/query_politicians):
     - `search`: `AND (i.issuer_name LIKE ?N OR i.issuer_ticker LIKE ?N)` with `%needle%`
     - `sector`: `AND i.sector IN (...)` with positional params
     - `state`: `AND i.state_id IN (...)` with positional params
     - `country`: `AND i.country IN (...)` with positional params
   - ORDER BY: `COALESCE(s.volume, 0) DESC` (highest volume first)
   - LIMIT if filter.limit is set
   - Map rows to DbIssuerRow, handling Option columns with `row.get::<_, Option<T>>()`.

4. Re-export DbIssuerRow and DbIssuerFilter from lib.rs (add to existing `pub use db::{ ... }` block).

**B. CLI command (issuers.rs + main.rs):**

5. Add `--db` flag to IssuersArgs:
   ```rust
   /// Read from local SQLite database instead of scraping
   #[arg(long)]
   pub db: Option<PathBuf>,
   ```
   Add `use std::path::PathBuf;` import.

6. Add `--limit` flag to IssuersArgs:
   ```rust
   /// Maximum results to return (DB mode only)
   #[arg(long)]
   pub limit: Option<i64>,
   ```

7. Add `run_db(args: &IssuersArgs, db_path: &PathBuf, format: &OutputFormat) -> Result<()>` function:
   - Open DB: `let db = Db::open(db_path)?;`
   - Build DbIssuerFilter from args:
     - search: from args.search (validate with validate_search)
     - sector: from args.sector (split comma, validate each with validate_sector)
     - state: from args.state (split comma, validate each with validate_issuer_state -- note: issuer states are lowercase, use validate_issuer_state not validate_state)
     - country: from args.country (split comma, validate each with validate_country)
     - limit: from args.limit
   - Unsupported filters check: if args.market_cap, args.politician_id, or args.id are set, bail with: `"--market-cap, --politician-id, and --id are not supported with --db. Supported filters: --search, --sector, --state, --country, --limit"`
   - Call `db.query_issuers(&filter)?`
   - Print count to stderr: `eprintln!("{} issuers", rows.len())`
   - Route to output functions by format (see output functions below)

8. In main.rs, update the issuers command routing to check for --db flag first:
   ```rust
   Commands::Issuers(args) => {
       if let Some(ref db_path) = args.db {
           issuers::run_db(args, db_path, &format)?
       } else {
           issuers::run(args, &scraper, &format).await?
       }
   }
   ```

**C. Output layer (output.rs + xml_output.rs):**

9. Add `DbIssuerOutputRow` struct in output.rs (derive Tabled, Serialize):
   ```rust
   #[derive(Tabled, Serialize)]
   struct DbIssuerOutputRow {
       #[tabled(rename = "Name")]
       name: String,
       #[tabled(rename = "Ticker")]
       ticker: String,
       #[tabled(rename = "Sector")]
       sector: String,
       #[tabled(rename = "Mcap")]
       mcap: String,
       #[tabled(rename = "30D Return")]
       trailing30: String,
       #[tabled(rename = "YTD")]
       ytd_trailing365: String,
       #[tabled(rename = "Trades")]
       trades: i64,
       #[tabled(rename = "Volume")]
       volume: String,
       #[tabled(rename = "Last Traded")]
       last_traded: String,
   }
   ```

   Wait -- the research recommends a curated subset for table output but all fields for JSON/CSV. To handle this cleanly:
   - Use DbIssuerOutputRow for table/markdown (curated: 9 columns).
   - For JSON, serialize the full DbIssuerRow directly (it already has Serialize).
   - For CSV, use a wider struct or serialize DbIssuerRow directly.

   Actually, follow the established pattern from trades and politicians: one OutputRow struct used for table/markdown, and the same struct for CSV (the CSV might include more columns via serde). For consistency, create ONE DbIssuerOutputRow used across all formats, but with enough columns to be useful.

   The table output struct should include:
   - name, ticker, sector, mcap (formatted as "$X.XB" or "$X.XM"), trailing30 (formatted as "+X.X%" or "-X.X%"), trailing365 (same format), trades (i64), volume (formatted with commas or as "$X.XM"), last_traded

   For JSON and CSV, serialize the DbIssuerRow directly (it has all performance fields). This differs from trades/politicians which use the same OutputRow for all formats, but it makes more sense for issuers where performance data has many columns.

   Revised approach -- match existing pattern exactly:
   - DbIssuerOutputRow for table/markdown (curated columns)
   - For JSON: serialize Vec<DbIssuerRow> directly via print_json (already generic)
   - For CSV: write DbIssuerRow fields directly (all columns)
   - For XML: serialize DbIssuerRow via JSON bridge

10. Add `build_db_issuer_rows(rows: &[DbIssuerRow]) -> Vec<DbIssuerOutputRow>` helper:
    - Map each DbIssuerRow to DbIssuerOutputRow
    - Format mcap: None -> "-", Some(v) -> format as human-readable (e.g., "$3.5T", "$500B", "$1.2M"). Use simple thresholds: >= 1T -> "T", >= 1B -> "B", >= 1M -> "M", else raw number.
    - Format trailing30: None -> "-", Some(v) -> format as "+X.X%" or "-X.X%" (1 decimal)
    - Format trailing365: Same pattern
    - Format volume: format as human-readable (same as mcap formatting)
    - ticker: unwrap_or("-".to_string())
    - sector: unwrap_or("-".to_string())
    - last_traded: unwrap_or("-".to_string())

11. Add output functions:
    - `pub fn print_db_issuers_table(rows: &[DbIssuerRow])` -- build_db_issuer_rows, Table::new, Style::modern, println
    - `pub fn print_db_issuers_csv(rows: &[DbIssuerRow]) -> Result<()>` -- write DbIssuerRow fields directly with csv::Writer (all performance columns as headers), handle None as empty
    - `pub fn print_db_issuers_markdown(rows: &[DbIssuerRow])` -- build_db_issuer_rows, Table::new, Style::markdown, println

12. In xml_output.rs, add `pub fn db_issuers_to_xml(rows: &[DbIssuerRow])` -- reuse the `items_to_xml` generic function, same pattern as db_trades_to_xml and db_politicians_to_xml. The XML serialization goes through serde_json -> JSON bridge -> XML, which handles all DbIssuerRow fields automatically.

13. Wire output routing in issuers.rs run_db():
    ```rust
    match format {
        OutputFormat::Table => print_db_issuers_table(&rows),
        OutputFormat::Json => print_json(&rows),
        OutputFormat::Csv => print_db_issuers_csv(&rows)?,
        OutputFormat::Markdown => print_db_issuers_markdown(&rows),
        OutputFormat::Xml => print_db_issuers_xml(&rows),
    }
    ```

Import all necessary functions in issuers.rs.
  </action>
  <verify>
    `cargo check --workspace` compiles. `cargo clippy --workspace` has no new warnings.
  </verify>
  <done>
    --db flag on issuers command routes to DB-backed output. Table shows curated performance columns. JSON/CSV/XML include all performance fields. Filters --search, --sector, --state, --country work. Unsupported filters bail with helpful message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for DB issuer query and output</name>
  <files>
    capitoltraders_lib/src/db.rs
    capitoltraders_cli/src/output_tests.rs
  </files>
  <action>
1. Add query_issuers tests in db.rs `#[cfg(test)] mod tests` block:

   - `test_query_issuers_no_filter`: Insert 2 issuers (one enriched with performance, one not), call query_issuers with default filter. Verify both returned, ordered by volume DESC. Enriched issuer has mcap and trailing values; unenriched has None for performance fields.

   - `test_query_issuers_search_filter`: Insert 3 issuers with different names. Filter with search "Apple". Verify only matching issuer returned.

   - `test_query_issuers_sector_filter`: Insert 3 issuers in different sectors. Filter by sector vec with one sector. Verify only matching issuers returned.

   - `test_query_issuers_state_filter`: Insert issuers with different state_ids. Filter by state. Verify correct filtering.

   - `test_query_issuers_limit`: Insert 5 issuers. Query with limit=2. Verify exactly 2 returned.

   For each test, use the Db::open_in_memory() constructor, db.init(), then insert test data via upsert_issuers() with minimal IssuerDetail values. For the enriched issuer, call update_issuer_detail() to populate performance data.

2. Add output tests in output_tests.rs:

   - `test_db_issuer_output_row_mapping`: Create a DbIssuerRow with performance data, call build_db_issuer_rows, verify mcap is formatted correctly (e.g., "$3.5T"), trailing30 is formatted as percentage.

   - `test_db_issuer_output_no_performance`: Create a DbIssuerRow without performance (all None), verify output shows "-" for mcap and trailing columns.

   - `test_db_issuer_json_serialization`: Create a DbIssuerRow with performance, serialize to JSON, verify all performance fields present in output.

   - `test_db_issuer_csv_headers`: Call print_db_issuers_csv with a single row, capture output, verify CSV header line includes performance column names.
  </action>
  <verify>
    `cargo test -p capitoltraders_lib query_issuers -- --nocapture` passes all 5 DB query tests. `cargo test -p capitoltraders_cli db_issuer -- --nocapture` passes all 4 output tests. `cargo test --workspace` passes all tests.
  </verify>
  <done>
    5 DB query tests and 4 output tests pass. query_issuers correctly handles no-filter, search, sector, state, and limit. Output correctly formats performance data and handles None gracefully. All workspace tests pass with no regressions.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p capitoltraders_lib query_issuers` -- all 5 DB query tests pass
2. `cargo test -p capitoltraders_cli db_issuer` -- all 4 output tests pass
3. `cargo test --workspace` -- all tests pass (no regressions)
4. `cargo clippy --workspace` -- no new warnings
5. Manual review: issuers --db outputs table with performance columns, JSON includes all fields
</verification>

<success_criteria>
- query_issuers() returns issuer rows with LEFT JOINed performance data
- --db flag on issuers routes to run_db() with DB-backed output
- Table output shows curated columns (Name, Ticker, Sector, Mcap, 30D Return, YTD, Trades, Volume, Last Traded)
- JSON/CSV/XML include all performance fields
- None performance values render as "-" in table, null in JSON, empty in CSV
- Filters --search, --sector, --state, --country work; unsupported filters bail with clear message
- 9 new tests pass, all existing workspace tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-issuer-enrichment/05-03-SUMMARY.md`
</output>
