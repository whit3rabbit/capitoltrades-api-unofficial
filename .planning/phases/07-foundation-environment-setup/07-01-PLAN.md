---
phase: 07-foundation-environment-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - capitoltraders_lib/Cargo.toml
  - capitoltraders_cli/Cargo.toml
  - capitoltraders_cli/src/main.rs
  - capitoltraders_lib/src/db.rs
  - schema/sqlite.sql
  - .env.example
autonomous: true
user_setup:
  - service: OpenFEC / api.data.gov
    why: "FEC donation data requires an API key (free, instant signup)"
    env_vars:
      - name: OPENFEC_API_KEY
        source: "https://api.data.gov/signup/ -- check email for key after registration"

must_haves:
  truths:
    - "Running any donation-related command without OPENFEC_API_KEY set produces a clear error message explaining how to get and configure the key"
    - ".env file is loaded at startup before command dispatch"
    - ".gitignore already excludes .env files (verified, no change needed)"
    - "Schema v3 migration adds fec_mappings table to existing v2 databases without breaking existing data"
    - "Fresh database creation includes fec_mappings table in base DDL"
  artifacts:
    - path: ".env.example"
      provides: "Template showing OPENFEC_API_KEY placeholder"
      contains: "OPENFEC_API_KEY"
    - path: "schema/sqlite.sql"
      provides: "fec_mappings table DDL for fresh databases"
      contains: "fec_mappings"
    - path: "capitoltraders_lib/src/db.rs"
      provides: "migrate_v3 method and user_version 3 bump"
      contains: "migrate_v3"
    - path: "capitoltraders_cli/src/main.rs"
      provides: "dotenvy .env loading at startup"
      contains: "dotenvy"
  key_links:
    - from: "capitoltraders_cli/src/main.rs"
      to: ".env file on disk"
      via: "dotenvy::EnvLoader or #[dotenvy::load] attribute"
      pattern: "dotenvy"
    - from: "capitoltraders_lib/src/db.rs"
      to: "schema/sqlite.sql"
      via: "include_str! in init() after migration chain"
      pattern: "migrate_v3"
---

<objective>
Add dotenvy and serde_yml workspace dependencies, implement .env loading at CLI startup, create .env.example template, and add schema v3 migration with fec_mappings table for storing politician-to-FEC-ID crosswalk data.

Purpose: Establish the foundation layer that all subsequent FEC donation integration phases depend on -- API key management and the schema for FEC ID storage.
Output: Working .env loading, fec_mappings table in SQLite (via migration and base schema), and helper function for requiring the OpenFEC API key with user-friendly error messages.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-foundation-environment-setup/07-RESEARCH.md
@.planning/phases/01-schema-migration-data-model/01-01-SUMMARY.md
@capitoltraders_cli/src/main.rs
@capitoltraders_lib/src/db.rs
@schema/sqlite.sql
@Cargo.toml
@capitoltraders_lib/Cargo.toml
@capitoltraders_cli/Cargo.toml
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace dependencies, .env loading, and .env.example</name>
  <files>
    Cargo.toml
    capitoltraders_lib/Cargo.toml
    capitoltraders_cli/Cargo.toml
    capitoltraders_cli/src/main.rs
    .env.example
  </files>
  <action>
1. Add dotenvy and serde_yml to workspace Cargo.toml [workspace.dependencies]:
   ```toml
   dotenvy = "0.15"
   serde_yml = "0.0.12"
   ```
   Note: Check the actual latest serde_yml version via `cargo search serde_yml` before adding. The research doc says 0.3 but verify.

2. Add dotenvy to capitoltraders_cli/Cargo.toml [dependencies] (this is where main.rs lives):
   ```toml
   dotenvy = { workspace = true }
   ```

3. Add serde_yml to capitoltraders_lib/Cargo.toml [dependencies] (this is where YAML parsing will happen in Plan 02):
   ```toml
   serde_yml = { workspace = true }
   ```

4. Modify capitoltraders_cli/src/main.rs to load .env at startup:
   - Add `use std::path::Path;` if not already present
   - Before `#[tokio::main]`, add the dotenvy loading. Two options:
     - Option A (preferred, simple): Call `dotenvy::dotenv().ok();` as the first line inside main(). Use `.ok()` because missing .env is fine -- the error is deferred to when donation commands actually need the key.
     - Option B (attribute macro): Add `#[dotenvy::load]` before `#[tokio::main]`. However, this panics if .env is missing, which is too aggressive -- non-donation commands should work without .env.
   - Use Option A: add `let _ = dotenvy::dotenv();` as first line of main(), before tracing init.

5. Add a public helper function in capitoltraders_lib (e.g., in a new section of lib.rs or a small fec_config.rs -- put it in lib.rs for now since it is small):
   Actually, do NOT add this to lib.rs yet. Instead, add a simple helper function at the bottom of main.rs or in a new commands/fec_util.rs:
   ```rust
   pub fn require_openfec_api_key() -> Result<String> {
       std::env::var("OPENFEC_API_KEY").map_err(|_| {
           anyhow::anyhow!(
               "OpenFEC API key not found.\n\n\
                To use donation-related features, you need an API key from api.data.gov:\n\
                1. Sign up at https://api.data.gov/signup/\n\
                2. Check your email for the API key\n\
                3. Create a .env file in the project root:\n\
                   echo 'OPENFEC_API_KEY=your_key_here' > .env\n\
                4. See .env.example for a template\n\n\
                Note: .env is gitignored and will not be committed."
           )
       })
   }
   ```
   Place this as a standalone function in main.rs (it will be called by donation-related command handlers in future phases). It is not called yet in Phase 7 -- it is wired in Phase 8+.

6. Create .env.example at the workspace root:
   ```
   # OpenFEC API Key
   # Get your key at https://api.data.gov/signup/
   # Check your email after registration for the key
   OPENFEC_API_KEY=your_api_key_here
   ```

7. Verify .gitignore already excludes .env files. It does (confirmed: `.env` and `.env.*` lines exist). The .env.example file does NOT match `.env.*` glob because it starts with `.env.` -- wait, actually `.env.*` would match `.env.example`. Check this carefully. If .gitignore excludes `.env.example`, we need to add a negation rule: `!.env.example`. Look at the existing .gitignore: it has `.env` and `.env.*`. The `.env.*` pattern WILL match `.env.example`. Add a negation line `!.env.example` after `.env.*` to ensure the template is tracked.
  </action>
  <verify>
    - `cargo check --workspace` compiles without errors
    - `grep dotenvy Cargo.toml` shows workspace dependency
    - `grep dotenvy capitoltraders_cli/Cargo.toml` shows crate dependency
    - `grep serde_yml capitoltraders_lib/Cargo.toml` shows crate dependency
    - `grep -n "dotenvy" capitoltraders_cli/src/main.rs` shows .env loading
    - `test -f .env.example && echo "exists"` confirms template exists
    - `git check-ignore .env.example` should produce NO output (not ignored)
    - `git check-ignore .env` should produce `.env` (still ignored)
  </verify>
  <done>
    dotenvy and serde_yml are workspace dependencies. CLI loads .env at startup silently (no panic if missing). .env.example exists with placeholder. .env.example is NOT gitignored. require_openfec_api_key() helper exists for future donation commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Schema v3 migration with fec_mappings table and tests</name>
  <files>
    schema/sqlite.sql
    capitoltraders_lib/src/db.rs
  </files>
  <action>
1. Add fec_mappings table to schema/sqlite.sql (base DDL for fresh databases), BEFORE the indexes section:
   ```sql
   CREATE TABLE IF NOT EXISTS fec_mappings (
       politician_id TEXT NOT NULL,
       fec_candidate_id TEXT NOT NULL,
       bioguide_id TEXT NOT NULL,
       election_cycle INTEGER,
       last_synced TEXT NOT NULL,
       PRIMARY KEY (politician_id, fec_candidate_id),
       FOREIGN KEY (politician_id) REFERENCES politicians(politician_id) ON DELETE CASCADE
   );
   ```
   Add indexes at the end of the indexes section:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_fec_mappings_fec_id ON fec_mappings(fec_candidate_id);
   CREATE INDEX IF NOT EXISTS idx_fec_mappings_bioguide ON fec_mappings(bioguide_id);
   ```

2. Add migrate_v3() to db.rs, following the exact pattern of migrate_v1/migrate_v2:
   ```rust
   fn migrate_v3(&self) -> Result<(), DbError> {
       self.conn.execute(
           "CREATE TABLE IF NOT EXISTS fec_mappings (
               politician_id TEXT NOT NULL,
               fec_candidate_id TEXT NOT NULL,
               bioguide_id TEXT NOT NULL,
               election_cycle INTEGER,
               last_synced TEXT NOT NULL,
               PRIMARY KEY (politician_id, fec_candidate_id),
               FOREIGN KEY (politician_id) REFERENCES politicians(politician_id) ON DELETE CASCADE
           )",
           [],
       )?;
       self.conn.execute(
           "CREATE INDEX IF NOT EXISTS idx_fec_mappings_fec_id ON fec_mappings(fec_candidate_id)",
           [],
       )?;
       self.conn.execute(
           "CREATE INDEX IF NOT EXISTS idx_fec_mappings_bioguide ON fec_mappings(bioguide_id)",
           [],
       )?;
       Ok(())
   }
   ```

3. Update init() in db.rs to call migrate_v3 after migrate_v2:
   ```rust
   if version < 3 {
       self.migrate_v3()?;
       self.conn.pragma_update(None, "user_version", 3)?;
   }
   ```

4. Add tests in db.rs (in the existing #[cfg(test)] mod tests block):

   a. Test fresh DB has fec_mappings table:
   ```rust
   #[test]
   fn test_fresh_db_has_fec_mappings_table() {
       let db = Db::open_in_memory().unwrap();
       db.init().unwrap();
       // Verify table exists by querying it
       let count: i64 = db.conn.query_row(
           "SELECT COUNT(*) FROM fec_mappings", [], |row| row.get(0)
       ).unwrap();
       assert_eq!(count, 0);
   }
   ```

   b. Test v2-to-v3 migration path:
   Create a V2_SCHEMA constant (or use the existing V1_SCHEMA pattern) that represents a post-v2 database, then verify migrate_v3 adds the fec_mappings table. Follow the existing test_migration_v2 pattern.

   c. Test user_version is 3 after fresh init:
   ```rust
   #[test]
   fn test_init_sets_version_3() {
       let db = Db::open_in_memory().unwrap();
       db.init().unwrap();
       let version: i32 = db.conn.pragma_query_value(None, "user_version", |row| row.get(0)).unwrap();
       assert_eq!(version, 3);
   }
   ```

   d. Test v3 migration idempotency (run init twice):
   ```rust
   #[test]
   fn test_migration_v3_idempotent() {
       let db = Db::open_in_memory().unwrap();
       db.init().unwrap();
       db.init().unwrap(); // Should not fail
       let version: i32 = db.conn.pragma_query_value(None, "user_version", |row| row.get(0)).unwrap();
       assert_eq!(version, 3);
   }
   ```

5. IMPORTANT: Update any existing tests that assert user_version == 2 to assert user_version == 3, since fresh init now runs all three migrations. Search for `user_version` assertions in the test module and update them. The Phase 1 summary mentions tests that expect version 2 -- these MUST be updated.
  </action>
  <verify>
    - `cargo test --workspace` -- all existing tests pass (366+), new tests pass
    - `cargo test -p capitoltraders_lib fec_mappings` -- new tests specifically
    - `cargo test -p capitoltraders_lib migration_v3` -- migration tests
    - `cargo test -p capitoltraders_lib test_init` -- init tests still pass
    - `cargo clippy --workspace` -- no warnings
  </verify>
  <done>
    fec_mappings table exists in both base schema.sql (fresh DBs) and via migrate_v3 (existing DBs). user_version bumped to 3. All existing tests updated to expect version 3. New tests verify fec_mappings table creation, v2-to-v3 migration path, and idempotency. All 366+ tests pass with zero clippy warnings.
  </done>
</task>

</tasks>

<verification>
1. `cargo check --workspace` compiles cleanly
2. `cargo test --workspace` passes all tests (366+ existing plus new migration tests)
3. `cargo clippy --workspace` produces no warnings
4. `.env.example` exists at workspace root with placeholder key
5. `git check-ignore .env.example` produces no output (template is tracked)
6. `git check-ignore .env` confirms .env is still ignored
7. `grep "fec_mappings" schema/sqlite.sql` returns table definition
8. `grep "migrate_v3" capitoltraders_lib/src/db.rs` returns migration function
</verification>

<success_criteria>
- dotenvy and serde_yml are workspace dependencies that compile
- .env loaded silently at CLI startup (no panic if missing)
- .env.example template exists and is git-tracked
- require_openfec_api_key() helper provides actionable error message
- fec_mappings table exists in schema (fresh and migrated DBs)
- user_version is 3 after init
- All existing + new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-foundation-environment-setup/07-01-SUMMARY.md`
</output>
