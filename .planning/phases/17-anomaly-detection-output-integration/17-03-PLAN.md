---
phase: 17-anomaly-detection-output-integration
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - capitoltraders_lib/src/db.rs
  - capitoltraders_cli/src/commands/anomalies.rs
  - capitoltraders_cli/src/commands/mod.rs
  - capitoltraders_cli/src/main.rs
  - capitoltraders_cli/src/output.rs
  - capitoltraders_cli/src/xml_output.rs
autonomous: true

must_haves:
  truths:
    - "User can run 'capitoltraders anomalies --db path' to see anomaly scores"
    - "User can see pre-move trade flags with price change percentage and direction"
    - "User can see unusual volume flags with volume ratio"
    - "User can see sector concentration (HHI) score per politician"
    - "User can see composite anomaly score combining all three signals"
    - "User can filter anomaly results by minimum confidence threshold (--min-confidence)"
    - "User can filter by politician name (--politician)"
    - "Anomaly output supports all 5 formats (table, JSON, CSV, markdown, XML)"
  artifacts:
    - path: "capitoltraders_lib/src/db.rs"
      provides: "DB query methods for anomaly signal data"
      contains: "query_pre_move_candidates"
    - path: "capitoltraders_cli/src/commands/anomalies.rs"
      provides: "Anomalies CLI subcommand"
      exports: ["AnomaliesArgs", "run"]
    - path: "capitoltraders_cli/src/output.rs"
      provides: "Anomaly output functions in 4 formats"
      contains: "print_anomaly"
    - path: "capitoltraders_cli/src/commands/mod.rs"
      provides: "Module registration for anomalies"
      contains: "pub mod anomalies"
    - path: "capitoltraders_cli/src/main.rs"
      provides: "CLI dispatch for anomalies command"
      contains: "Anomalies"
  key_links:
    - from: "capitoltraders_cli/src/commands/anomalies.rs"
      to: "capitoltraders_lib/src/anomaly.rs"
      via: "Import and call anomaly detection functions"
      pattern: "detect_pre_move_trades|detect_unusual_volume|calculate_sector_concentration|calculate_composite_anomaly_score"
    - from: "capitoltraders_cli/src/commands/anomalies.rs"
      to: "capitoltraders_lib/src/db.rs"
      via: "Query raw data for anomaly computation"
      pattern: "query_pre_move_candidates|query_trades_for_analytics|get_portfolio"
    - from: "capitoltraders_cli/src/commands/anomalies.rs"
      to: "capitoltraders_cli/src/output.rs"
      via: "Dispatch anomaly output to format-specific functions"
      pattern: "print_anomaly_table|print_anomaly_csv"
---

<objective>
Create DB query methods for anomaly signal data and build the anomalies CLI subcommand that wires anomaly detection functions (Plan 01) to database queries and formatted output.

Purpose: Give users a single command to detect unusual trading patterns across politicians, with filtering and confidence thresholds.
Output: `capitoltraders anomalies --db path` command with pre-move flags, volume signals, HHI scores, and composite anomaly scores.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-anomaly-detection-output-integration/17-RESEARCH.md
@.planning/phases/17-anomaly-detection-output-integration/17-01-SUMMARY.md
@.planning/phases/17-anomaly-detection-output-integration/17-02-SUMMARY.md
@capitoltraders_lib/src/anomaly.rs
@capitoltraders_lib/src/db.rs
@capitoltraders_lib/src/analytics.rs
@capitoltraders_cli/src/commands/conflicts.rs
@capitoltraders_cli/src/output.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB query methods for anomaly signal data</name>
  <files>
    capitoltraders_lib/src/db.rs
  </files>
  <action>
Add three new query methods to the Db impl block in db.rs:

**1. query_pre_move_candidates()**

Return type: `Result<Vec<PreMoveCandidateRow>, DbError>`

```rust
pub struct PreMoveCandidateRow {
    pub tx_id: i64,
    pub politician_id: String,
    pub politician_name: String,
    pub ticker: String,
    pub tx_type: String,
    pub tx_date: String,
    pub trade_price: f64,
    pub price_30d_later: Option<f64>,
}
```

SQL query:
- SELECT from trades t JOIN issuers i ON t.issuer_id = i.issuer_id JOIN politicians p ON t.politician_id = p.politician_id
- WHERE t.trade_date_price IS NOT NULL
- AND t.tx_date <= date('now', '-30 days') -- exclude recent trades without 30-day forward data
- AND a.asset_type = 'stock' (JOIN assets a ON t.asset_id = a.asset_id)
- For price_30d_later: use a correlated subquery:
  ```sql
  (SELECT t2.trade_date_price
   FROM trades t2
   JOIN issuers i2 ON t2.issuer_id = i2.issuer_id
   WHERE i2.issuer_ticker = i.issuer_ticker
     AND t2.tx_date >= DATE(t.tx_date, '+28 days')
     AND t2.tx_date <= DATE(t.tx_date, '+32 days')
     AND t2.trade_date_price IS NOT NULL
   ORDER BY ABS(JULIANDAY(t2.tx_date) - JULIANDAY(t.tx_date) - 30)
   LIMIT 1) as price_30d_later
  ```
  Note: Use a 28-32 day window (not exact 30) to find the nearest available price. If no trade of the same ticker happened near that date, price_30d_later will be NULL.

  Actually, a better approach that works even without same-ticker trades: use the current_price column or trade_date_price from ANY trade of the same ticker closest to 30 days later. But this is complex. The research suggests using the simpler self-join approach.

  Simplest reliable approach: Since we have trade_date_price for the original trade and current_price for the issuer, we can compute price change for recent-enough trades. But for true 30-day forward, we need historical prices which we have from the enrichment pipeline.

  PRAGMATIC APPROACH: For pre-move detection, use the benchmark/enrichment data. Query all trades with trade_date_price, and for the "30 days later" price, use a separate lookup. Actually, the simplest approach that works with existing data:

  Query all trades with trade_date_price. For each, find if there's another trade of the same ticker by any politician within 28-32 days that also has trade_date_price. This gives us the forward price from the enrichment pipeline.

  If no same-ticker trade exists near day 30, price_30d_later is NULL. This means we won't catch every pre-move signal but will catch ones where the same stock was actively traded ~30 days later by someone.

- ORDER BY t.tx_date DESC

Add a unit test: `test_query_pre_move_candidates_empty` using in-memory DB with no enriched trades.

**2. query_trade_volume_by_politician()**

Return type: `Result<Vec<TradeVolumeRow>, DbError>`

```rust
pub struct TradeVolumeRow {
    pub politician_id: String,
    pub politician_name: String,
    pub tx_date: String,
}
```

SQL: Simple query returning all trade dates per politician:
```sql
SELECT t.politician_id,
       p.first_name || ' ' || p.last_name AS politician_name,
       t.tx_date
FROM trades t
JOIN politicians p ON t.politician_id = p.politician_id
ORDER BY t.politician_id, t.tx_date
```

This feeds into detect_unusual_volume() which handles the date grouping and comparison logic.

Add a unit test: `test_query_trade_volume_empty` using in-memory DB.

**3. query_portfolio_positions_for_hhi()**

Return type: `Result<Vec<HHIPositionRow>, DbError>`

```rust
pub struct HHIPositionRow {
    pub politician_id: String,
    pub politician_name: String,
    pub ticker: String,
    pub gics_sector: Option<String>,
    pub estimated_value: f64,
}
```

SQL:
```sql
SELECT p2.politician_id,
       p2.first_name || ' ' || p2.last_name AS politician_name,
       p.issuer_ticker AS ticker,
       i.gics_sector,
       COALESCE(p.shares_held * p.current_price, p.shares_held * p.cost_basis, 0.0) AS estimated_value
FROM positions p
JOIN politicians p2 ON p.politician_id = p2.politician_id
JOIN issuers i ON p.issuer_ticker = i.issuer_ticker
WHERE p.shares_held > 0.01
ORDER BY p.politician_id, estimated_value DESC
```

Add a unit test: `test_query_portfolio_positions_for_hhi_empty` using in-memory DB.

**Export new types from lib.rs:**
Add to the `pub use db::{...}` block: `PreMoveCandidateRow, TradeVolumeRow, HHIPositionRow`
  </action>
  <verify>
```bash
cargo test -p capitoltraders_lib query_pre_move -- --nocapture
cargo test -p capitoltraders_lib query_trade_volume -- --nocapture
cargo test -p capitoltraders_lib query_portfolio_positions_for_hhi -- --nocapture
cargo test --workspace
cargo clippy --workspace -- -D warnings
```
  </verify>
  <done>
- Three new DB query methods exist: query_pre_move_candidates, query_trade_volume_by_politician, query_portfolio_positions_for_hhi
- Three new row types: PreMoveCandidateRow, TradeVolumeRow, HHIPositionRow
- Each method has a unit test with in-memory DB
- Types re-exported from lib.rs
- All workspace tests pass, no clippy warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Anomalies CLI subcommand with output formatting</name>
  <files>
    capitoltraders_cli/src/commands/anomalies.rs
    capitoltraders_cli/src/commands/mod.rs
    capitoltraders_cli/src/main.rs
    capitoltraders_cli/src/output.rs
    capitoltraders_cli/src/xml_output.rs
  </files>
  <action>
**Create anomalies CLI subcommand:**

Create `capitoltraders_cli/src/commands/anomalies.rs`:

1. Define AnomaliesArgs:
```rust
#[derive(Args)]
pub struct AnomaliesArgs {
    /// SQLite database path (required)
    #[arg(long)]
    pub db: PathBuf,

    /// Filter by politician name (partial match)
    #[arg(long)]
    pub politician: Option<String>,

    /// Minimum composite anomaly score (0.0-1.0, default: 0.0)
    #[arg(long, default_value = "0.0")]
    pub min_score: f64,

    /// Minimum confidence threshold (0.0-1.0, default: 0.0)
    #[arg(long, default_value = "0.0")]
    pub min_confidence: f64,

    /// Show detailed pre-move trade signals
    #[arg(long)]
    pub show_pre_move: bool,

    /// Number of results to show (default: 25)
    #[arg(long, default_value = "25")]
    pub top: usize,

    /// Sort by metric: score, volume, hhi, pre-move (default: score)
    #[arg(long, default_value = "score")]
    pub sort_by: String,
}
```

2. Define output row types:
```rust
#[derive(Debug, Clone, Serialize)]
pub struct AnomalyRow {
    pub rank: usize,
    pub politician_name: String,
    pub pre_move_count: usize,
    pub volume_ratio: f64,
    pub hhi_score: f64,
    pub composite_score: f64,
    pub confidence: f64,
}

#[derive(Debug, Clone, Serialize)]
pub struct PreMoveRow {
    pub politician_name: String,
    pub ticker: String,
    pub tx_date: String,
    pub tx_type: String,
    pub trade_price: f64,
    pub price_30d_later: f64,
    pub price_change_pct: f64,
}
```

3. Implement `run()` function:

```
pub fn run(args: &AnomaliesArgs, format: &OutputFormat) -> Result<()>
```

Flow:
a. Validate inputs:
   - min_score 0.0-1.0
   - min_confidence 0.0-1.0
   - sort_by is one of: score, volume, hhi, pre-move

b. Open DB

c. If --politician filter: resolve name via db.find_politician_by_name (same pattern as conflicts.rs)

d. Query all three data sources:
   - `db.query_pre_move_candidates()` -> convert to TradeWithFuturePrice -> `detect_pre_move_trades(trades, 10.0)`
   - `db.query_trade_volume_by_politician()` -> group by politician_id -> for each politician call `detect_unusual_volume(records, politician_id, today, 90, 365)`
   - `db.query_portfolio_positions_for_hhi()` -> group by politician_id -> for each politician call `calculate_sector_concentration(positions)`

e. Collect unique politician_ids from all three sources

f. For each politician, call `calculate_composite_anomaly_score()` with their signals

g. Apply filters:
   - politician filter (if specified)
   - min_score filter
   - min_confidence filter (ANOM-05)

h. Sort by selected metric:
   - "score": composite_score descending
   - "volume": volume_ratio descending
   - "hhi": hhi_score descending
   - "pre-move": pre_move_count descending

i. Truncate to --top

j. Build AnomalyRow vec with rank numbers

k. Output using format dispatch:
   ```rust
   match format {
       OutputFormat::Table => print_anomaly_table(&rows),
       OutputFormat::Json => print_json(&rows),
       OutputFormat::Csv => print_anomaly_csv(&rows)?,
       OutputFormat::Markdown => print_anomaly_markdown(&rows),
       OutputFormat::Xml => print_anomaly_xml(&rows),
   }
   ```

l. Print summary to stderr:
   ```
   "Showing {}/{} politicians (min score: {:.2}, min confidence: {:.2})"
   ```

m. If --show-pre-move: output detailed pre-move signals as second table:
   - Build PreMoveRow vec from pre_move_signals (filtered to matching politicians)
   - Output using separate format dispatch (same pattern as conflicts --include-donations)
   - Print "--- Pre-Move Trade Signals ---" header to stderr

**Add output functions to output.rs:**

Following the exact pattern from conflict output functions:

- `print_anomaly_table(rows: &[AnomalyRow])` -- Columns: # | Politician | Pre-Move | Vol Ratio | HHI | Score | Confidence
  - Format: pre_move_count as integer, volume_ratio as "X.Xx", hhi_score as "0.XXX", composite_score as "0.XXX", confidence as "XX%"
- `print_anomaly_csv(rows: &[AnomalyRow]) -> Result<()>` -- CSV with header, sanitized politician_name
- `print_anomaly_markdown(rows: &[AnomalyRow])` -- Markdown table via tabled
- `print_anomaly_xml(rows: &[AnomalyRow])` -- Via xml_output
- `print_pre_move_table(rows: &[PreMoveRow])` -- Columns: Politician | Ticker | Date | Type | Price | 30d Price | Change%
  - Format price_change_pct as "+X.X%" or "-X.X%", color-code would be nice but tabled doesn't do ANSI easily, just use text
- `print_pre_move_csv`, `print_pre_move_markdown`, `print_pre_move_xml` -- Same pattern

**Add XML functions to xml_output.rs:**

- `anomalies_to_xml(rows: &[AnomalyRow]) -> String` -- items_to_xml("anomalies", "anomaly", rows)
- `pre_move_signals_to_xml(rows: &[PreMoveRow]) -> String` -- items_to_xml("pre_move_signals", "signal", rows)

**Wire into CLI:**

In `commands/mod.rs`: Add `pub mod anomalies;`

In `main.rs`:
- Add `Anomalies(Box<commands::anomalies::AnomaliesArgs>)` variant to Commands enum (Box per clippy large-variant pattern)
- Add dispatch: `Commands::Anomalies(args) => commands::anomalies::run(args, &format)?`

**Important constraints:**
- Import anomaly types from capitoltraders_lib::anomaly (from Plan 01)
- Import DB query types from capitoltraders_lib (PreMoveCandidateRow, etc.)
- Convert DB rows to anomaly input types before calling detection functions
- Use chrono::Local::now().naive_local().date() for "today" in volume detection
- Handle empty data gracefully: if no trades/positions, print hint message and return Ok(())
- Do NOT use async -- all DB operations are synchronous (same as analytics/conflicts commands)
  </action>
  <verify>
```bash
cargo check --workspace
cargo test --workspace
cargo clippy --workspace -- -D warnings
cargo run -p capitoltraders_cli -- anomalies --help
cargo run -p capitoltraders_cli -- --help  # verify anomalies appears in subcommand list
```
  </verify>
  <done>
- `capitoltraders anomalies --db path` command exists and shows help
- AnomaliesArgs has 7 parameters: db, politician, min-score, min-confidence, show-pre-move, top, sort-by
- Output includes pre-move count, volume ratio, HHI score, composite score, confidence
- --min-confidence filter works (ANOM-05)
- --show-pre-move shows detailed pre-move trade signals
- All 5 output formats work (table, JSON, CSV, markdown, XML)
- All workspace tests pass, no clippy warnings
  </done>
</task>

</tasks>

<verification>
```bash
# Full workspace verification
cargo test --workspace
cargo clippy --workspace -- -D warnings
cargo build --workspace

# Verify all CLI commands
cargo run -p capitoltraders_cli -- anomalies --help
cargo run -p capitoltraders_cli -- --help
```
</verification>

<success_criteria>
- ANOM-01: Pre-move trade flags visible in anomalies output and --show-pre-move detail
- ANOM-02: Unusual volume flags visible as volume_ratio in anomaly scores
- ANOM-03: Sector concentration (HHI) visible per politician
- ANOM-04: Composite anomaly score combines all three signals
- ANOM-05: --min-confidence filter works to exclude low-confidence results
- All 5 output formats work for anomaly output
- 3 new DB query methods with unit tests
- anomalies CLI subcommand registered and dispatching correctly
- All workspace tests pass (no regression)
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/17-anomaly-detection-output-integration/17-03-SUMMARY.md`
</output>
