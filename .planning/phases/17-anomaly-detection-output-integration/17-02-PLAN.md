---
phase: 17-anomaly-detection-output-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - capitoltraders_cli/src/commands/trades.rs
  - capitoltraders_cli/src/commands/portfolio.rs
  - capitoltraders_cli/src/commands/politicians.rs
  - capitoltraders_cli/src/output.rs
  - capitoltraders_cli/src/xml_output.rs
  - capitoltraders_lib/src/db.rs
autonomous: true

must_haves:
  truths:
    - "User can see absolute_return and alpha columns in trades DB output for closed trades"
    - "User can see committee_trading_pct column in portfolio output"
    - "User can see avg_return, win_rate, and percentile columns in politicians DB output"
    - "All new columns render correctly in table, JSON, CSV, markdown, and XML formats"
    - "Existing output is unchanged when analytics/conflict data is not available"
  artifacts:
    - path: "capitoltraders_cli/src/commands/trades.rs"
      provides: "Extended trades DB run_db() with optional performance fields"
      contains: "absolute_return"
    - path: "capitoltraders_cli/src/commands/portfolio.rs"
      provides: "Extended portfolio run() with optional conflict flags"
      contains: "committee_trading_pct"
    - path: "capitoltraders_cli/src/commands/politicians.rs"
      provides: "Extended politicians DB run_db() with optional analytics scores"
      contains: "avg_return"
    - path: "capitoltraders_cli/src/output.rs"
      provides: "Updated output functions handling new optional fields"
      contains: "absolute_return"
    - path: "capitoltraders_lib/src/db.rs"
      provides: "New query method for politician analytics summary"
      contains: "query_politician_analytics_summary"
  key_links:
    - from: "capitoltraders_cli/src/commands/trades.rs"
      to: "capitoltraders_lib/src/analytics.rs"
      via: "Compute trade metrics from closed trades to enrich trade output"
      pattern: "compute_trade_metrics|calculate_closed_trades"
    - from: "capitoltraders_cli/src/commands/portfolio.rs"
      to: "capitoltraders_lib/src/conflict.rs"
      via: "Calculate committee trading score for portfolio display"
      pattern: "calculate_committee_trading_score"
    - from: "capitoltraders_cli/src/commands/politicians.rs"
      to: "capitoltraders_lib/src/db.rs"
      via: "Query pre-computed analytics summary for politician list enrichment"
      pattern: "query_politician_analytics_summary"
---

<objective>
Integrate existing analytics (Phase 15) and conflict (Phase 16) data into the trades, portfolio, and politicians CLI output commands so users see performance and conflict information in their regular workflow.

Purpose: Users should not need to run separate analytics/conflicts commands to see key metrics. Performance summary in trades, conflict flags in portfolio, and analytics scores in politicians output make insights visible in the primary workflow.
Output: Extended trades/portfolio/politicians DB output with optional analytics fields in all 5 formats.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-performance-scoring/15-03-SUMMARY.md
@.planning/phases/16-conflict-detection/16-02-SUMMARY.md
@capitoltraders_cli/src/commands/trades.rs
@capitoltraders_cli/src/commands/portfolio.rs
@capitoltraders_cli/src/commands/politicians.rs
@capitoltraders_cli/src/output.rs
@capitoltraders_cli/src/xml_output.rs
@capitoltraders_lib/src/db.rs
@capitoltraders_lib/src/analytics.rs
@capitoltraders_lib/src/conflict.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend trades and portfolio DB output with analytics and conflict data</name>
  <files>
    capitoltraders_cli/src/commands/trades.rs
    capitoltraders_cli/src/commands/portfolio.rs
    capitoltraders_cli/src/output.rs
    capitoltraders_cli/src/xml_output.rs
  </files>
  <action>
**OUTP-01: Performance summary in trades output (DB mode only)**

In `trades.rs`, modify the `run_db()` function to optionally compute performance metrics for trades:

1. After querying trades via `db.query_trades(&filter)`, attempt to load analytics data:
   - Call `db.query_trades_for_analytics()` (existing method)
   - Convert to AnalyticsTrade using the same `row_to_analytics_trade` pattern from analytics.rs command
   - Run `calculate_closed_trades()` to get closed trades
   - Run `compute_trade_metrics()` on each closed trade
   - Build a HashMap keyed by (politician_id, ticker, buy_date) mapping to TradeMetrics
   - Wrap this entire analytics loading in a best-effort block: if it fails (e.g., no price-enriched data), set the map to empty HashMap and continue

2. Create an `EnrichedDbTradeRow` struct in trades.rs (not public, just for output):
   ```rust
   #[derive(Serialize, Clone)]
   struct EnrichedDbTradeRow {
       // Copy all fields from DbTradeRow
       // Add:
       pub absolute_return: Option<f64>,
       pub alpha: Option<f64>,
   }
   ```

3. Map each DbTradeRow to EnrichedDbTradeRow, looking up metrics by matching (politician_id, ticker) in the metrics HashMap. Only sell trades can have return/alpha (since closed trades are recorded at sell time). Match by politician_id + ticker, taking the most recent matching metric.

4. Pass EnrichedDbTradeRow to output functions.

**OUTP-02: Conflict flags in portfolio output**

In `portfolio.rs`, modify `run()` to optionally compute committee trading percentage:

1. After querying portfolio positions via `db.get_portfolio(&filter)`, attempt to load conflict data:
   - Group positions by politician_id
   - For each politician, call `db.get_politician_committee_names(politician_id)` (existing Phase 16 method) -- returns empty Vec if no committees
   - If politician has committees, load `committee_jurisdictions` via `load_committee_jurisdictions()` and check if position's sector (look up via `db.conn()` query on issuers table for gics_sector by ticker) is in committee jurisdiction sectors
   - Build HashMap<(politician_id, ticker), bool> for `in_committee_sector` flag

2. Create an `EnrichedPortfolioPosition` struct in portfolio.rs:
   ```rust
   #[derive(Serialize, Clone)]
   struct EnrichedPortfolioPosition {
       // Copy all fields from PortfolioPosition
       // Add:
       pub gics_sector: Option<String>,
       pub in_committee_sector: Option<bool>,
   }
   ```

3. For each PortfolioPosition, look up the ticker's gics_sector from the issuers table. Determine if in_committee_sector by checking if the sector is in the politician's committee jurisdiction set. Use a single bulk query to get all (ticker, gics_sector) pairs to avoid N+1 queries.

4. Pass EnrichedPortfolioPosition to output functions.

**Output functions for both:**

In `output.rs`, add new output functions (following existing pattern from leaderboard/conflict output):

For trades (DB mode):
- Modify existing `print_db_trades_table()` to accept EnrichedDbTradeRow (or create new `print_enriched_db_trades_table/csv/markdown/xml` functions). The cleaner approach: create new functions `print_enriched_trades_table`, `print_enriched_trades_csv`, `print_enriched_trades_markdown`, `print_enriched_trades_xml` that include the extra columns. Keep original functions for non-DB-mode output.
- Table: Add "Return" and "Alpha" columns after existing columns. Format as "+X.X%" or "-X.X%" or blank if None.
- CSV: Add absolute_return and alpha columns at end. Empty string if None.
- Markdown: Same column additions as table.
- XML: Add return and alpha elements (skip_serializing_if None).
- JSON: Uses print_json (no change needed, Serialize handles it).

For portfolio:
- Similarly create enriched portfolio output functions or extend existing ones.
- Table: Add "Sector" and "Cmte?" columns. Cmte? shows "Y"/"N"/blank.
- CSV/Markdown/XML: Same pattern.

In `xml_output.rs`:
- Add `enriched_trades_to_xml` and `enriched_portfolio_to_xml` functions following existing items_to_xml pattern.

**Important constraints:**
- All new fields are Option types so existing output is backward-compatible
- When analytics data is unavailable (no price enrichment), fields are None and display as blank/omitted
- Do NOT modify the function signatures of existing output functions -- create NEW functions for enriched output
- The trades scrape mode (`run()` as opposed to `run_db()`) is NOT affected
- Import analytics types from capitoltraders_lib (already re-exported)
  </action>
  <verify>
```bash
cargo check --workspace
cargo test --workspace
cargo clippy --workspace -- -D warnings
cargo run -p capitoltraders_cli -- trades --help
cargo run -p capitoltraders_cli -- portfolio --help
```
  </verify>
  <done>
- trades DB mode output includes optional absolute_return and alpha columns for sell trades
- portfolio output includes optional gics_sector and in_committee_sector columns
- All 5 output formats work for both enriched outputs
- Existing scrape-mode trades output is unchanged
- When no analytics data available, enriched fields show as blank/None
- All workspace tests pass, no clippy warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend politicians DB output with analytics summary scores</name>
  <files>
    capitoltraders_cli/src/commands/politicians.rs
    capitoltraders_cli/src/output.rs
    capitoltraders_cli/src/xml_output.rs
    capitoltraders_lib/src/db.rs
  </files>
  <action>
**OUTP-03: Analytics scores in politicians output (DB mode only)**

1. Add a new DB query method `query_politician_analytics_summary` to `db.rs`:
   ```rust
   pub struct PoliticianAnalyticsSummary {
       pub politician_id: String,
       pub closed_trade_count: i64,
       pub avg_return: Option<f64>,
       pub win_rate: Option<f64>,
   }
   ```
   The query should aggregate from trades data directly (without needing the analytics pipeline). Use a SQL approach:
   - JOIN trades with issuers to get tickers
   - Self-join to match buy/sell pairs by (politician_id, ticker) where sell tx_date > buy tx_date
   - This is complex in SQL. SIMPLER APPROACH: just store the summary. Since analytics CLI already computes these, the simpler approach for output integration is:

   Actually, the simplest approach that avoids duplicating FIFO logic in SQL: in the politicians.rs `run_db()` function, load analytics data the same way analytics.rs CLI does (query_trades_for_analytics -> calculate_closed_trades -> compute_trade_metrics -> aggregate_politician_metrics), then build a HashMap<String, PoliticianMetrics> keyed by politician_id. This is the same pattern used in analytics.rs. Then enrich each DbPoliticianRow with the matching PoliticianMetrics.

   So instead of a new DB method, do it in-memory in politicians.rs run_db():

   a. After querying politicians via `db.query_politicians(&filter)`, attempt analytics enrichment:
      - `db.query_trades_for_analytics()` -> convert to AnalyticsTrade -> `calculate_closed_trades()` -> `compute_trade_metrics()` on each -> `aggregate_politician_metrics()`
      - Build HashMap<String, PoliticianMetrics> keyed by politician_id
      - Wrap in best-effort: if fails, empty map

   b. Create `EnrichedDbPoliticianRow` in politicians.rs:
      ```rust
      #[derive(Serialize, Clone)]
      struct EnrichedDbPoliticianRow {
          // Copy all fields from DbPoliticianRow
          // Add:
          pub closed_trades: Option<usize>,
          pub avg_return: Option<f64>,
          pub win_rate: Option<f64>,
          pub percentile: Option<f64>,
      }
      ```

   c. Map each DbPoliticianRow to EnrichedDbPoliticianRow using HashMap lookup

2. Create enriched politician output functions in output.rs:
   - `print_enriched_politicians_table`, `_csv`, `_markdown`, `_xml`
   - Table: Add "Closed" (trade count), "Avg Ret" (formatted as "+X.X%"), "Win%" (formatted as "XX.X%"), "Pctl" (formatted as "XX%") columns
   - CSV: Add closed_trades, avg_return, win_rate, percentile columns
   - Markdown/XML: Same pattern
   - JSON: Uses generic print_json

3. In xml_output.rs:
   - Add `enriched_politicians_to_xml` function

4. Wire the enriched output in politicians.rs `run_db()`:
   - If enriched data is available, use enriched output functions
   - If not available (empty HashMap), still use enriched functions but with all Option fields as None (displays as blank)

**Important constraints:**
- Only DB mode (`run_db()`) gets enrichment. Scrape mode (`run()`) is NOT affected.
- Analytics computation is best-effort: if query_trades_for_analytics fails (no enriched prices), all analytics fields are None
- Use existing imports: AnalyticsTrade, calculate_closed_trades, compute_trade_metrics, aggregate_politician_metrics are already re-exported from capitoltraders_lib
- Do NOT create a new DB method -- compute in-memory using existing FIFO pipeline
- Performance: This adds ~100ms overhead for analytics computation but is acceptable for CLI usage
  </action>
  <verify>
```bash
cargo check --workspace
cargo test --workspace
cargo clippy --workspace -- -D warnings
cargo run -p capitoltraders_cli -- politicians --help
```
  </verify>
  <done>
- politicians DB mode output includes optional closed_trades, avg_return, win_rate, percentile columns
- All 5 output formats work for enriched politicians output
- Existing scrape-mode politicians output is unchanged
- When no analytics data available, enriched fields show as blank/None
- All workspace tests pass, no clippy warnings
  </done>
</task>

</tasks>

<verification>
```bash
# Full workspace verification
cargo test --workspace
cargo clippy --workspace -- -D warnings
cargo build --workspace

# Verify help commands show correct arguments
cargo run -p capitoltraders_cli -- trades --help
cargo run -p capitoltraders_cli -- portfolio --help
cargo run -p capitoltraders_cli -- politicians --help
```
</verification>

<success_criteria>
- OUTP-01: trades DB output shows optional absolute_return and alpha for sell trades
- OUTP-02: portfolio output shows optional gics_sector and in_committee_sector
- OUTP-03: politicians DB output shows optional closed_trades, avg_return, win_rate, percentile
- OUTP-04: All enriched output works in table, JSON, CSV, markdown, XML formats
- All existing scrape-mode output is unchanged (backward compatible)
- All workspace tests pass (no regression)
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/17-anomaly-detection-output-integration/17-02-SUMMARY.md`
</output>
