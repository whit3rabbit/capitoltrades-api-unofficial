---
phase: 17-anomaly-detection-output-integration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - capitoltraders_lib/src/anomaly.rs
  - capitoltraders_lib/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Pre-move trade detection identifies trades followed by >10% price change within 30 days"
    - "Unusual volume detection compares recent 90-day trade count to 365-day historical baseline"
    - "HHI sector concentration score calculated from portfolio positions using decimal weights (0-1 scale)"
    - "Composite anomaly score combines timing, volume, and concentration signals with equal weights"
    - "Division-by-zero handled safely in volume ratio and HHI calculations"
    - "Confidence score reflects data availability (0.0 if no signals available)"
  artifacts:
    - path: "capitoltraders_lib/src/anomaly.rs"
      provides: "Anomaly detection types and pure computation functions"
      exports: ["PreMoveSignal", "VolumeSignal", "ConcentrationScore", "AnomalyScore", "detect_pre_move_trades", "detect_unusual_volume", "calculate_sector_concentration", "calculate_composite_anomaly_score"]
      min_lines: 150
    - path: "capitoltraders_lib/src/lib.rs"
      provides: "Module declaration and re-exports for anomaly types"
      contains: "pub mod anomaly"
  key_links:
    - from: "capitoltraders_lib/src/anomaly.rs"
      to: "capitoltraders_lib/src/analytics.rs"
      via: "No direct import needed -- anomaly.rs uses its own input types"
      pattern: "detect_pre_move_trades|detect_unusual_volume|calculate_sector_concentration"
---

<objective>
Create the anomaly detection computation module with pure functions for pre-move trade detection, unusual volume detection, HHI sector concentration scoring, and composite anomaly scoring.

Purpose: Establish testable, pure computation functions (no DB access, no CLI) that will be wired to DB queries and CLI output in later plans.
Output: capitoltraders_lib/src/anomaly.rs with comprehensive unit tests.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-anomaly-detection-output-integration/17-RESEARCH.md
@capitoltraders_lib/src/analytics.rs
@capitoltraders_lib/src/conflict.rs
@capitoltraders_lib/src/lib.rs
</context>

<feature>
  <name>Anomaly Detection Pure Functions (TDD)</name>
  <files>capitoltraders_lib/src/anomaly.rs, capitoltraders_lib/src/lib.rs</files>
  <behavior>
    Pre-move trade detection:
    - Input: slice of TradeWithFuturePrice (tx_id, politician_id, ticker, tx_date, tx_type, trade_price, price_30d_later: Option f64), threshold_pct: f64
    - Output: Vec of PreMoveSignal for trades where abs(price_change_pct) > threshold_pct
    - PreMoveSignal: tx_id, politician_id, ticker, tx_date, tx_type, trade_price, price_30d_later, price_change_pct, direction (buy_before_rise or sell_before_drop or buy_before_drop or sell_before_rise)
    - Trades without price_30d_later (None) are excluded
    - Default threshold: 10.0 (10%)

    Cases:
    - trade_price=100, price_30d_later=Some(115) -> price_change_pct=15.0, included (>10%)
    - trade_price=100, price_30d_later=Some(105) -> price_change_pct=5.0, excluded (<10%)
    - trade_price=100, price_30d_later=None -> excluded
    - trade_price=100, price_30d_later=Some(85) -> price_change_pct=-15.0, included (abs > 10%)
    - Empty input -> empty output

    Unusual volume detection:
    - Input: slice of (politician_id, tx_date) trade records, target politician_id, reference_date (NaiveDate), lookback_days (default 90), baseline_days (default 365)
    - Output: VolumeSignal with recent_trade_count, historical_avg (per lookback window), volume_ratio, is_unusual (ratio > 2.0)
    - Division by zero: if historical_avg == 0.0, volume_ratio = 0.0, is_unusual = false

    Cases:
    - 10 trades in 90d, 20 trades in prior 365d -> historical_avg = 20/(365/90) = 4.93, ratio = 10/4.93 = 2.03 -> is_unusual=true
    - 3 trades in 90d, 20 trades in prior 365d -> ratio ~0.61 -> is_unusual=false
    - 5 trades in 90d, 0 trades in prior 365d -> ratio=0.0, is_unusual=false
    - No trades at all -> recent=0, historical_avg=0.0, ratio=0.0, is_unusual=false

    HHI sector concentration:
    - Input: slice of (ticker, gics_sector: Option String, estimated_value: f64) position records for one politician
    - Output: ConcentrationScore with sector_weights (HashMap String f64 in 0-100 pct), hhi_score (0.0-1.0 using decimal form), dominant_sector (Some if hhi > 0.25), is_concentrated (hhi > 0.25)
    - Positions with None gics_sector are excluded from calculation
    - Positions with estimated_value <= 0.0 are excluded

    Cases:
    - All positions in one sector: HHI = 1.0 (100%^2 = 1.0), is_concentrated=true
    - Two equal sectors (50%/50%): HHI = 0.25^2 + 0.25^2... wait, (0.5)^2 + (0.5)^2 = 0.50, is_concentrated=true
    - Four equal sectors (25% each): HHI = 4 * (0.25)^2 = 0.25, is_concentrated=false (threshold is >0.25)
    - Five equal sectors: HHI = 5 * (0.2)^2 = 0.2, is_concentrated=false
    - No positions with sector -> HHI = 0.0, is_concentrated=false
    - One position with sector, rest None -> HHI = 1.0 (only the one with sector counts)

    Composite anomaly score:
    - Input: pre_move_count (usize), volume_ratio (f64), hhi_score (f64), data availability flags
    - Output: AnomalyScore with normalized components, composite (weighted average), confidence (0.0-1.0)
    - Normalization: pre_move: count/10 capped at 1.0; volume: ratio/5.0 capped at 1.0; concentration: hhi directly (already 0-1)
    - Weights: equal 33.3% each (per research recommendation)
    - Confidence: count of available signals / 3

    Cases:
    - pre_move=5, volume_ratio=3.0, hhi=0.4 -> norm: 0.5, 0.6, 0.4 -> composite = (0.5+0.6+0.4)/3 = 0.5, confidence=1.0
    - pre_move=0, volume_ratio=0.0, hhi=0.0 -> composite=0.0, confidence=0.0 (no meaningful signals)
    - pre_move=15, volume_ratio=10.0, hhi=1.0 -> capped: 1.0, 1.0, 1.0 -> composite=1.0, confidence=1.0
  </behavior>
  <implementation>
    Follow existing patterns from analytics.rs and conflict.rs:
    - Module doc comment explaining purpose
    - Derive Serialize, Debug, Clone on all public types
    - Pure functions taking slices/references, returning owned values
    - No DB access, no CLI logic
    - Use chrono::NaiveDate for date parsing and arithmetic
    - Use std::collections::HashMap for sector weights
    - Define input types in anomaly.rs (TradeWithFuturePrice, TradeVolumeRecord, PortfolioPositionForHHI) to decouple from DB row types

    Register module in lib.rs:
    - Add `pub mod anomaly;` to module declarations
    - Add `pub use anomaly::{...}` re-exports for all public types and functions

    Test structure (RED phase):
    - test_pre_move_basic_detection (buy at 100, 30d price 115 -> flagged)
    - test_pre_move_below_threshold (price change <10% -> not flagged)
    - test_pre_move_none_price_excluded (no 30d price -> excluded)
    - test_pre_move_negative_change (price drop >10% -> flagged)
    - test_pre_move_empty_input (empty vec -> empty result)
    - test_volume_unusual_spike (ratio > 2.0 -> is_unusual=true)
    - test_volume_normal (ratio < 2.0 -> is_unusual=false)
    - test_volume_no_historical (0 historical -> ratio=0.0, safe)
    - test_volume_no_recent (0 recent trades -> ratio=0.0)
    - test_hhi_single_sector (all one sector -> 1.0)
    - test_hhi_two_equal_sectors (50/50 -> 0.5)
    - test_hhi_four_equal_sectors (25/25/25/25 -> 0.25)
    - test_hhi_null_sectors_excluded (None sectors skipped)
    - test_hhi_empty_positions (no valid -> 0.0)
    - test_composite_all_signals
    - test_composite_no_signals (all zero -> 0.0, confidence 0.0)
    - test_composite_capped_at_one (extreme values capped)
  </implementation>
</feature>

<verification>
```bash
cargo test -p capitoltraders_lib anomaly -- --nocapture
cargo test --workspace
cargo clippy --workspace -- -D warnings
```
</verification>

<success_criteria>
- anomaly.rs module exists with 4 public types and 4 public functions
- All ~17 unit tests pass
- detect_pre_move_trades correctly filters by threshold with abs() comparison
- detect_unusual_volume handles division-by-zero safely
- calculate_sector_concentration excludes None sectors and computes HHI on 0-1 scale
- calculate_composite_anomaly_score normalizes and caps all signals
- All existing workspace tests pass (no regression)
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/17-anomaly-detection-output-integration/17-01-SUMMARY.md`
</output>
