---
phase: 14-benchmark-price-enrichment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - capitoltraders_lib/src/db.rs
  - schema/sqlite.sql
autonomous: true

must_haves:
  truths:
    - "Schema v7 migration adds benchmark_price REAL column to trades table on existing databases"
    - "Fresh databases include benchmark_price column in base schema"
    - "get_benchmark_unenriched_trades returns trades where benchmark_price IS NULL with gics_sector from issuers JOIN"
    - "update_benchmark_price writes benchmark_price for a single trade by tx_id"
  artifacts:
    - path: "capitoltraders_lib/src/db.rs"
      provides: "migrate_v7, BenchmarkEnrichmentRow, get_benchmark_unenriched_trades, update_benchmark_price"
      contains: "fn migrate_v7"
    - path: "schema/sqlite.sql"
      provides: "benchmark_price column in trades table, idx_trades_benchmark_price index"
      contains: "benchmark_price REAL"
  key_links:
    - from: "db.rs::init()"
      to: "db.rs::migrate_v7()"
      via: "version < 7 guard"
      pattern: "if version < 7"
    - from: "db.rs::get_benchmark_unenriched_trades"
      to: "issuers table"
      via: "JOIN issuers for gics_sector"
      pattern: "i\\.gics_sector"
---

<objective>
Add schema v7 migration and DB methods for benchmark price enrichment.

Purpose: Phase 14 requires storing benchmark prices (SPY/sector ETF) on trades. This plan creates the database infrastructure: the v7 migration adding benchmark_price column, a query to fetch trades needing benchmark enrichment (with GICS sector from issuers JOIN), and an update method for writing benchmark prices.

Output: Schema v7 migration, BenchmarkEnrichmentRow type, get_benchmark_unenriched_trades query, update_benchmark_price method, and tests for all of the above.
</objective>

<execution_context>
@/Users/whit3rabbit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whit3rabbit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-benchmark-price-enrichment/14-RESEARCH.md
@.planning/phases/13-data-foundation-sector-classification/13-01-SUMMARY.md

@schema/sqlite.sql
@capitoltraders_lib/src/db.rs (focus: migrate_v6, PriceEnrichmentRow, get_unenriched_price_trades, update_trade_prices, update_current_price, init method version checks)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema v7 migration and benchmark DB methods</name>
  <files>capitoltraders_lib/src/db.rs, schema/sqlite.sql</files>
  <action>
**schema/sqlite.sql changes:**
- Add `benchmark_price REAL` column to the trades CREATE TABLE statement (after estimated_value, before the FOREIGN KEY lines)
- Add `CREATE INDEX IF NOT EXISTS idx_trades_benchmark_price ON trades(benchmark_price);` in the index section

**db.rs changes -- migrate_v7 method:**
- Add `fn migrate_v7(&self) -> Result<(), DbError>` following the exact pattern of migrate_v6:
  - `ALTER TABLE trades ADD COLUMN benchmark_price REAL` with duplicate column name error handling
  - `CREATE INDEX IF NOT EXISTS idx_trades_benchmark_price ON trades(benchmark_price)` with no-such-table error handling
- Add version 7 guard in `init()` after the version 6 block: `if version < 7 { self.migrate_v7()?; self.conn.pragma_update(None, "user_version", 7)?; }`

**db.rs changes -- BenchmarkEnrichmentRow struct:**
- Add a new struct (NOT modify PriceEnrichmentRow, which other code depends on):
```rust
pub struct BenchmarkEnrichmentRow {
    pub tx_id: i64,
    pub issuer_ticker: String,
    pub tx_date: String,
    pub gics_sector: Option<String>,
}
```
This is separate from PriceEnrichmentRow because benchmark enrichment has different data needs (needs gics_sector, does NOT need size_range_low/high/value).

**db.rs changes -- get_benchmark_unenriched_trades:**
- Add `pub fn get_benchmark_unenriched_trades(&self, limit: Option<i64>) -> Result<Vec<BenchmarkEnrichmentRow>, DbError>`
- SQL query:
```sql
SELECT t.tx_id, i.issuer_ticker, t.tx_date, i.gics_sector
FROM trades t
JOIN issuers i ON t.issuer_id = i.issuer_id
WHERE i.issuer_ticker IS NOT NULL
  AND i.issuer_ticker <> ''
  AND t.tx_date IS NOT NULL
  AND t.benchmark_price IS NULL
ORDER BY t.tx_id
```
- If limit is Some(n), append `LIMIT {n}` (same pattern as get_unenriched_price_trades)
- Map rows to BenchmarkEnrichmentRow

**db.rs changes -- update_benchmark_price:**
- Add `pub fn update_benchmark_price(&self, tx_id: i64, benchmark_price: Option<f64>) -> Result<(), DbError>`
- SQL: `UPDATE trades SET benchmark_price = ?1 WHERE tx_id = ?2`
- Note: Does NOT set price_enriched_at. Benchmark enrichment is independent of trade price enrichment.
  </action>
  <verify>
Run `cargo check -p capitoltraders_lib` -- must compile without errors.
Run `cargo clippy -p capitoltraders_lib` -- must pass with no warnings.
  </verify>
  <done>
migrate_v7 exists in db.rs with benchmark_price ALTER TABLE. init() calls it for version < 7. BenchmarkEnrichmentRow struct exists. get_benchmark_unenriched_trades and update_benchmark_price methods exist. schema/sqlite.sql includes benchmark_price column and index. Compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Schema v7 migration and benchmark DB method tests</name>
  <files>capitoltraders_lib/src/db.rs</files>
  <action>
Add tests in the existing `#[cfg(test)] mod tests` block in db.rs. Follow the established patterns from v6 migration tests.

**Test 1: test_migrate_v7_from_v6**
- Create in-memory DB, run init()
- Verify user_version is 7
- Verify trades table has benchmark_price column (use has_column helper)
- Insert a trade row, verify benchmark_price is NULL by default
- Update benchmark_price to Some(450.0), verify it reads back correctly

**Test 2: test_migrate_v7_idempotent**
- Create in-memory DB, run init() twice
- Verify user_version is 7 after both calls
- No errors on second call

**Test 3: test_v7_version_check**
- Fresh DB via init()
- Assert user_version == 7

**Test 4: test_get_benchmark_unenriched_trades**
- Create in-memory DB, init()
- Insert 1 politician, 2 issuers (one with gics_sector "Information Technology", one with NULL gics_sector), 3 trades (2 for first issuer, 1 for second)
- Call get_benchmark_unenriched_trades(None) -- should return 3 trades
- Verify first trade has gics_sector = Some("Information Technology")
- Verify third trade has gics_sector = None
- Call update_benchmark_price on first trade
- Call get_benchmark_unenriched_trades(None) again -- should return 2 trades (first excluded since benchmark_price is no longer NULL)

**Test 5: test_get_benchmark_unenriched_trades_with_limit**
- Same setup as test 4 but call with limit Some(1)
- Should return exactly 1 trade

**Test 6: test_update_benchmark_price**
- Create in-memory DB, init()
- Insert politician, issuer, trade
- Call update_benchmark_price(tx_id, Some(455.23))
- SELECT benchmark_price from trades WHERE tx_id = ? -- assert 455.23
- Call update_benchmark_price(tx_id, None) -- sets to NULL
- SELECT again -- assert NULL

**IMPORTANT:** Update ALL existing tests that assert `user_version == 6` to assert `user_version == 7`. Search db.rs for `assert_eq!(version, 6)` and `assert_eq!(get_user_version(&db), 6)` patterns. There will be approximately 12 occurrences based on v5-to-v6 migration experience. Each needs updating to 7.
  </action>
  <verify>
Run `cargo test -p capitoltraders_lib migrate_v7` -- all v7 migration tests pass.
Run `cargo test -p capitoltraders_lib benchmark_unenriched` -- benchmark query tests pass.
Run `cargo test -p capitoltraders_lib update_benchmark` -- update method test passes.
Run `cargo test --workspace` -- ALL tests pass (no regressions from version number updates).
Run `cargo clippy --workspace` -- no warnings.
  </verify>
  <done>
6 new tests pass. All existing tests updated to expect version 7. Full workspace test suite passes with 0 failures. Clippy clean.
  </done>
</task>

</tasks>

<verification>
- `cargo test --workspace` passes with all existing + 6 new tests
- `cargo clippy --workspace` passes with no warnings
- `grep -q "benchmark_price REAL" schema/sqlite.sql` succeeds
- `grep -q "fn migrate_v7" capitoltraders_lib/src/db.rs` succeeds
- `grep -q "pub fn get_benchmark_unenriched_trades" capitoltraders_lib/src/db.rs` succeeds
- `grep -q "pub fn update_benchmark_price" capitoltraders_lib/src/db.rs` succeeds
- `grep -q "pub struct BenchmarkEnrichmentRow" capitoltraders_lib/src/db.rs` succeeds
</verification>

<success_criteria>
Schema v7 migration adds benchmark_price column to trades table. BenchmarkEnrichmentRow type defined with tx_id, issuer_ticker, tx_date, gics_sector fields. get_benchmark_unenriched_trades returns trades needing benchmark enrichment with sector data from issuers JOIN. update_benchmark_price writes benchmark price for individual trades. All tests pass including 6 new tests. Clippy clean.
</success_criteria>

<output>
After completion, create `.planning/phases/14-benchmark-price-enrichment/14-01-SUMMARY.md`
</output>
